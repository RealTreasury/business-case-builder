const RTBCB_GPT5_MAX_TOKENS=128e3,RTBCB_GPT5_MIN_TOKENS=256,RTBCB_API_TIMEOUT="undefined"!=typeof rtbcbReport&&rtbcbReport.timeout_ms?rtbcbReport.timeout_ms/1e3:300,RTBCB_GPT5_DEFAULTS={max_output_tokens:128e3,min_output_tokens:256,text:{verbosity:"medium"},temperature:.7,store:!0,timeout:RTBCB_API_TIMEOUT,max_retries:3,max_retry_time:RTBCB_API_TIMEOUT};function estimateTokens(t){return Math.ceil(1.5*t)}function supportsTemperature(t){const e=rtbcbReport.model_capabilities||{};return!(e.temperature&&e.temperature.unsupported||[]).includes(t)}function isValidUrl(t){if(!t)return!1;try{const e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch(t){return!1}}async function buildEnhancedPrompt(t){if(!isValidUrl(rtbcbReport.template_url))throw new Error("Template URL must use HTTP or HTTPS protocol");const e=await fetch(rtbcbReport.template_url),n=await e.text(),o=t&&t.companyName?t.companyName:"Company",r=t&&t.currentDate?t.currentDate:(new Date).toLocaleDateString(),a="string"==typeof t?t:t&&t.context?t.context:"";return`\nGenerate a professional business consulting report in HTML format with the following requirements:\n\nIMPORTANT: Output ONLY valid HTML code starting with <!DOCTYPE html>. Do not include any markdown formatting or explanation text outside the HTML.\n\nThe report should follow this exact structure:\n\n${n.replace(/{{COMPANY_NAME}}/g,o).replace(/{{CURRENT_DATE}}/g,r).replace(/{{BUSINESS_CONTEXT}}/g,a)}\n\nEnsure the report is:\n- Exactly 2 pages when printed (approximately 800-1000 words)\n- Professional and executive-ready\n- Data-driven with specific metrics where applicable\n- Action-oriented with clear next steps\n`}async function generateProfessionalReport(t,e){const n={...RTBCB_GPT5_DEFAULTS,..."undefined"!=typeof rtbcbReport?rtbcbReport:{}};n.model=rtbcbReport.report_model;const o=Math.min(128e3,parseInt(n.max_output_tokens,10)||128e3),r=Math.max(1,parseInt(n.min_output_tokens,10)||256),a=2*estimateTokens(1e3);n.max_output_tokens=Math.min(o,Math.max(r,a)),supportsTemperature(n.model)||delete n.temperature;const i={model:n.model,input:[{role:"system",content:"You are a senior BCG consultant creating professional HTML-formatted strategic reports. Output only valid HTML code with no additional text or markdown."},{role:"user",content:await buildEnhancedPrompt(t)}],max_output_tokens:n.max_output_tokens,text:n.text,store:n.store,stream:!0};supportsTemperature(n.model)&&(i.temperature=n.temperature);const s=new FormData;if(s.append("action","rtbcb_openai_responses"),s.append("body",JSON.stringify(i)),rtbcbReport.nonce&&s.append("nonce",rtbcbReport.nonce),!isValidUrl(rtbcbReport.ajax_url))throw new Error("Invalid AJAX URL");const p=await fetch(rtbcbReport.ajax_url,{method:"POST",body:s});if(!p.ok||!p.body)throw new Error("HTTP "+p.status+" "+p.statusText);const c=p.body.getReader(),l=new TextDecoder;let u="",d="";for(;;){const{done:t,value:n}=await c.read();if(t)break;u+=l.decode(n,{stream:!0});const o=u.split("\n\n");u=o.pop();for(const t of o){const n=t.trim();if(!n.startsWith("data:"))continue;const o=n.replace(/^data:\s*/,"");if("[DONE]"!==o)try{const t=JSON.parse(o);"response.output_text.delta"===t.type&&(d+=t.delta,e&&e(d))}catch(t){}}}return d.trim()}function sanitizeReportHTML(t){return"undefined"!=typeof DOMPurify?DOMPurify.sanitize(t,{ALLOWED_TAGS:["a","p","br","strong","em","ul","ol","li","h1","h2","h3","h4","h5","h6","div","span","table","thead","tbody","tr","th","td"],ALLOWED_ATTR:{a:["href","title","target","rel"],"*":["style"]}}):t}function displayReport(t){const e=document.createElement("iframe");e.style.width="100%",e.style.height="800px",e.style.border="1px solid #ddd",e.srcdoc=sanitizeReportHTML(t),document.getElementById("report-container").appendChild(e)}function exportToPDF(t){const e=sanitizeReportHTML(t),n=new Blob([e],{type:"text/html"}),o=URL.createObjectURL(n),r=window.open(o,"_blank");r?(r.focus(),r.onload=function(){r.print(),URL.revokeObjectURL(o)}):console.error("Failed to open print window")}async function generateAndDisplayReport(t){const e=document.getElementById("loading"),n=document.getElementById("error"),o=document.getElementById("report-container");e.style.display="block",n.style.display="none",o.innerHTML="";try{const e=await generateProfessionalReport(t,t=>{o.textContent=t});if(!e.includes("<!DOCTYPE html>"))throw new Error("Invalid HTML response from API");const n=sanitizeReportHTML(e);o.innerHTML="",displayReport(n);const r=document.createElement("button");r.textContent="Export to PDF",r.className="export-btn",r.onclick=function(){exportToPDF(n)},o.appendChild(r)}catch(t){n.textContent="Error: "+t.message,n.style.display="block"}finally{e.style.display="none"}}function initializeROIChart(){const t=document.getElementById("rtbcb-roi-chart"),e=rtbcbReportData.roiScenarios;new Chart(t,{type:"bar",data:{labels:["Conservative","Base Case","Optimistic"],datasets:[{label:"Annual Benefit ($)",data:[e.conservative?.total_annual_benefit||0,e.base?.total_annual_benefit||0,e.optimistic?.total_annual_benefit||0]}]}})}"undefined"==typeof rtbcbReport||isValidUrl(rtbcbReport.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcbReport.ajax_url=ajaxurl);