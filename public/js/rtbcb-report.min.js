const RTBCB_GPT5_MAX_TOKENS=128e3,RTBCB_GPT5_MIN_TOKENS=256,RTBCB_API_TIMEOUT="undefined"!=typeof rtbcbReport&&rtbcbReport.timeout_ms?rtbcbReport.timeout_ms/1e3:300,RTBCB_GPT5_DEFAULTS={max_output_tokens:128e3,min_output_tokens:256,text:{verbosity:"medium"},temperature:.7,store:!0,timeout:RTBCB_API_TIMEOUT,max_retries:3,max_retry_time:RTBCB_API_TIMEOUT};function estimateTokens(t){return Math.ceil(1.5*t)}function supportsTemperature(t){const e=rtbcbReport.model_capabilities||{};return!(e.temperature&&e.temperature.unsupported||[]).includes(t)}function isValidUrl(t){if(!t)return!1;try{const e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch(t){return!1}}async function buildEnhancedPrompt(t){if(!isValidUrl(rtbcbReport.template_url))throw new Error("Template URL must use HTTP or HTTPS protocol");const e=await fetch(rtbcbReport.template_url),n=await e.text(),r=t&&t.companyName?t.companyName:"Company",o=t&&t.currentDate?t.currentDate:(new Date).toLocaleDateString(),a="string"==typeof t?t:t&&t.context?t.context:"";return`\nGenerate a professional business consulting report in HTML format with the following requirements:\n\nIMPORTANT: Output ONLY valid HTML code starting with <!DOCTYPE html>. Do not include any markdown formatting or explanation text outside the HTML.\n\nThe report should follow this exact structure:\n\n${n.replace(/{{COMPANY_NAME}}/g,r).replace(/{{CURRENT_DATE}}/g,o).replace(/{{BUSINESS_CONTEXT}}/g,a)}\n\nEnsure the report is:\n- Exactly 2 pages when printed (approximately 800-1000 words)\n- Professional and executive-ready\n- Data-driven with specific metrics where applicable\n- Action-oriented with clear next steps\n`}async function generateProfessionalReport(t,e){const n={...RTBCB_GPT5_DEFAULTS,..."undefined"!=typeof rtbcbReport?rtbcbReport:{}};n.model=rtbcbReport.report_model;const r=Math.min(128e3,parseInt(n.max_output_tokens,10)||128e3),o=Math.max(1,parseInt(n.min_output_tokens,10)||256),a=2*estimateTokens(1e3);n.max_output_tokens=Math.min(r,Math.max(o,a)),supportsTemperature(n.model)||delete n.temperature;const i={model:n.model,input:[{role:"system",content:"You are a senior BCG consultant creating professional HTML-formatted strategic reports. Output only valid HTML code with no additional text or markdown."},{role:"user",content:await buildEnhancedPrompt(t)}],max_output_tokens:n.max_output_tokens,text:n.text,store:n.store,stream:!0};supportsTemperature(n.model)&&(i.temperature=n.temperature);const s=new FormData;if(s.append("action","rtbcb_openai_responses"),s.append("body",JSON.stringify(i)),rtbcbReport.nonce&&s.append("nonce",rtbcbReport.nonce),!isValidUrl(rtbcbReport.ajax_url))throw new Error("Invalid AJAX URL");const c=await fetch(rtbcbReport.ajax_url,{method:"POST",body:s});if(!c.ok||!c.body)throw new Error("HTTP "+c.status+" "+c.statusText);const l=c.body.getReader(),d=new TextDecoder;let u="",p="";for(;;){const{done:t,value:n}=await l.read();if(t)break;u+=d.decode(n,{stream:!0});const r=u.split("\n\n");u=r.pop();for(const t of r){const n=t.trim();if(!n.startsWith("data:"))continue;const r=n.replace(/^data:\s*/,"");if("[DONE]"!==r)try{const t=JSON.parse(r);"response.output_text.delta"===t.type&&(p+=t.delta,e&&e(p))}catch(t){}}}return p.trim()}function sanitizeReportHTML(t){return"undefined"!=typeof DOMPurify?DOMPurify.sanitize(t,{ALLOWED_TAGS:["a","p","br","strong","em","ul","ol","li","h1","h2","h3","h4","h5","h6","div","span","table","thead","tbody","tr","th","td"],ALLOWED_ATTR:{a:["href","title","target","rel"],"*":["style"]}}):t}function displayReport(t){const e=document.createElement("iframe");e.style.width="100%",e.style.height="800px",e.style.border="1px solid #ddd",e.srcdoc=sanitizeReportHTML(t),document.getElementById("report-container").appendChild(e)}function exportToPDF(t){const e=sanitizeReportHTML(t),n=new Blob([e],{type:"text/html"}),r=URL.createObjectURL(n),o=window.open(r,"_blank");o?(o.focus(),o.onload=function(){o.print(),URL.revokeObjectURL(r)}):console.error("Failed to open print window")}async function generateAndDisplayReport(t){const e=document.getElementById("loading"),n=document.getElementById("error"),r=document.getElementById("report-container");e.style.display="block",n.style.display="none",r.innerHTML="";try{const e=await generateProfessionalReport(t,t=>{r.textContent=t});if(!e.includes("<!DOCTYPE html>"))throw new Error("Invalid HTML response from API");const n=sanitizeReportHTML(e);r.innerHTML="",displayReport(n);const o=document.createElement("button");o.textContent="Export to PDF",o.className="export-btn",o.onclick=function(){exportToPDF(n)},r.appendChild(o)}catch(t){n.textContent="Error: "+t.message,n.style.display="block"}finally{e.style.display="none"}}function initializeROIChart(){if("undefined"==typeof Chart)return;const t=document.getElementById("rtbcb-roi-chart"),e="undefined"!=typeof rtbcbReportData?rtbcbReportData.roiScenarios:null;t&&e&&new Chart(t,{type:"bar",data:{labels:["Conservative","Base Case","Optimistic"],datasets:[{label:"Annual Benefit ($)",data:[e.conservative?.total_annual_benefit||0,e.base?.total_annual_benefit||0,e.optimistic?.total_annual_benefit||0]}]}})}function initializeCharts(){if("undefined"==typeof Chart)return void console.warn("RTBCB: Chart.js not loaded, skipping chart initialization");initializeROIChart();initializeComparisonCharts(),initializeSensitivityChart(),console.log("RTBCB: Charts initialized successfully")}function initializeROIChart(){const t=document.getElementById("rtbcb-roi-chart");if(!t)return console.log("RTBCB: ROI chart canvas not found"),null;const e=window.rtbcbChartData||generateFallbackChartData();if(!e||!e.datasets||0===e.datasets.length)return console.warn("RTBCB: No chart data available"),null;try{const n=new Chart(t,{type:"bar",data:e,options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{title:{display:!0,text:"ROI Analysis by Component",font:{size:16,weight:"bold"},padding:20},legend:{display:!0,position:"bottom",labels:{usePointStyle:!0,padding:20}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"#333",borderWidth:1,callbacks:{label:function(t){return t.dataset.label+": $"+(new Intl.NumberFormat).format(t.raw)},footer:function(t){if(t.length>0){const e=getComponentInfo(t[0].dataIndex);return e?"\n"+e:""}return""}}}},scales:{x:{grid:{display:!1},ticks:{font:{size:12}}},y:{beginAtZero:!0,grid:{borderDash:[5,5],color:"rgba(0, 0, 0, 0.1)"},ticks:{callback:function(t){return"$"+(new Intl.NumberFormat).format(t)},font:{size:11}}}},animation:{duration:1500,easing:"easeInOutQuart"}}});return t.onclick=function(t){const e=n.getElementsAtEventForMode(t,"nearest",{intersect:!0},!0);if(e.length){const t=e[0];handleChartClick(t.datasetIndex,t.index)}},n}catch(e){return console.error("RTBCB: Error initializing ROI chart:",e),showChartError(t,"Error loading ROI chart"),null}}function createScenarioMiniChart(t,e){const n=window.rtbcbReportData?.roiScenarios,r=n?.[e];if(r)try{new Chart(t,{type:"bar",data:{labels:["Annual Benefit"],datasets:[{data:[r.total_annual_benefit||0],backgroundColor:["#3b82f6"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}})}catch(t){console.error("RTBCB: Error creating mini chart for",e,t)}}function initializeComparisonCharts(){if(!document.querySelector(".rtbcb-scenario-comparison"))return;["conservative","base","optimistic"].forEach(t=>{const e=document.querySelector(`#rtbcb-${t}-chart`);e&&createScenarioMiniChart(e,t)})}function initializeSensitivityChart(){const t=document.getElementById("rtbcb-sensitivity-chart");if(!t)return;const e=window.rtbcbSensitivityData||generateFallbackSensitivityData();try{new Chart(t,{type:"bar",data:e,options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Sensitivity Analysis - Impact on ROI",font:{size:14,weight:"bold"}},legend:{display:!1}},scales:{x:{ticks:{callback:function(t){return t+"%"}}},y:{ticks:{font:{size:10}}}}}})}catch(t){console.error("RTBCB: Error initializing sensitivity chart:",t)}}function initializeSectionToggles(){document.querySelectorAll(".rtbcb-section-toggle").forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=this.getAttribute("data-target"),n=document.getElementById(e),r=this.querySelector(".rtbcb-toggle-arrow"),o=this.querySelector(".rtbcb-toggle-text"),a=this.closest(".rtbcb-section-enhanced");if(n){const t="none"!==n.style.display;t?(n.style.maxHeight=n.scrollHeight+"px",n.offsetHeight,n.style.maxHeight="0px",n.style.opacity="0",setTimeout(()=>{n.style.display="none"},300)):(n.style.display="block",n.style.maxHeight="0px",n.style.opacity="0",n.offsetHeight,n.style.maxHeight=n.scrollHeight+"px",n.style.opacity="1",setTimeout(()=>{n.style.maxHeight="none"},300)),r&&(r.textContent=t?"▼":"▲"),o&&(o.textContent=t?"Expand":"Collapse"),a&&a.classList.toggle("collapsed",t),trackSectionToggle(e,!t)}})})}function initializeInteractiveMetrics(){document.querySelectorAll(".rtbcb-metric-card").forEach(t=>{t.addEventListener("mouseenter",function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 8px 25px rgba(0, 0, 0, 0.15)"}),t.addEventListener("mouseleave",function(){this.style.transform="translateY(0)",this.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.1)"}),t.addEventListener("click",function(){expandMetricDetails(this)})}),initializeValueDriverAnimations(),initializeProgressBars()}function initializeResponsiveFeatures(){const t=document.querySelector(".rtbcb-mobile-toggle");let e;t&&t.addEventListener("click",toggleMobileMenu),window.addEventListener("resize",function(){clearTimeout(e),e=setTimeout(()=>{window.Chart&&Chart.helpers.each(Chart.instances,function(t){t.resize()})},250)}),window.addEventListener("beforeprint",function(){document.body.classList.add("rtbcb-printing")}),window.addEventListener("afterprint",function(){document.body.classList.remove("rtbcb-printing")})}function generateFallbackChartData(){const t=document.querySelector(".rtbcb-scenario-card.conservative"),e=document.querySelector(".rtbcb-scenario-card.base"),n=document.querySelector(".rtbcb-scenario-card.optimistic");if(!t||!e||!n)return console.warn("RTBCB: Scenario cards not found, using minimal fallback data"),{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Estimated Benefits",data:[5e4,2e4,3e4,1e5],backgroundColor:"rgba(59, 130, 246, 0.8)"}]};const r=(t,e)=>{const n=t.querySelector(e);if(n){const t=n.textContent.replace(/[$,]/g,"");return parseFloat(t)||0}return 0};return{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Conservative",data:[r(t,'[data-metric="labor_savings"]'),r(t,'[data-metric="fee_savings"]'),r(t,'[data-metric="error_reduction"]'),r(t,'[data-metric="total_benefit"]')],backgroundColor:"rgba(239, 68, 68, 0.8)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:2},{label:"Base Case",data:[r(e,'[data-metric="labor_savings"]'),r(e,'[data-metric="fee_savings"]'),r(e,'[data-metric="error_reduction"]'),r(e,'[data-metric="total_benefit"]')],backgroundColor:"rgba(59, 130, 246, 0.8)",borderColor:"rgba(59, 130, 246, 1)",borderWidth:2},{label:"Optimistic",data:[r(n,'[data-metric="labor_savings"]'),r(n,'[data-metric="fee_savings"]'),r(n,'[data-metric="error_reduction"]'),r(n,'[data-metric="total_benefit"]')],backgroundColor:"rgba(16, 185, 129, 0.8)",borderColor:"rgba(16, 185, 129, 1)",borderWidth:2}]}}function generateFallbackSensitivityData(){return{labels:["Implementation Delay","Adoption Challenges","Technology Evolution","Market Conditions"],datasets:[{label:"Impact %",data:[-15,-25,10,5],backgroundColor:function(t){return t.parsed.x<0?"rgba(239, 68, 68, 0.8)":"rgba(16, 185, 129, 0.8)"}}]}}function getComponentInfo(t){return["Automated processes reduce manual labor costs","Optimized banking relationships lower transaction fees","Reduced errors prevent costly mistakes and rework","Combined benefits drive strong ROI"][t]||""}function showChartError(t,e){const n=t.getContext("2d");n.clearRect(0,0,t.width,t.height),n.fillStyle="#666",n.font="14px Arial",n.textAlign="center",n.fillText(e,t.width/2,t.height/2)}function handleChartClick(t,e){console.log("Chart clicked:",t,e)}function expandMetricDetails(t){t.classList.toggle("expanded"),t.classList.contains("expanded")?showMetricDetails(t):hideMetricDetails(t)}function showMetricDetails(t){if(t.querySelector(".rtbcb-metric-details"))return;const e=document.createElement("div");e.className="rtbcb-metric-details",e.innerHTML="<p>Click for detailed breakdown and analysis</p>",t.appendChild(e)}function hideMetricDetails(t){const e=t.querySelector(".rtbcb-metric-details");e&&e.remove()}function initializeValueDriverAnimations(){document.querySelectorAll(".rtbcb-value-driver-enhanced").forEach((t,e)=>{setTimeout(()=>{t.style.opacity="1",t.style.transform="translateX(0)"},200*e)})}function initializeProgressBars(){document.querySelectorAll(".rtbcb-progress-bar").forEach(t=>{const e=t.dataset.progress||"0";setTimeout(()=>{t.style.width=e+"%"},500)})}function trackSectionToggle(t,e){"undefined"!=typeof gtag&&gtag("event","section_toggle",{section_id:t,expanded:e})}function toggleMobileMenu(){const t=document.querySelector(".rtbcb-mobile-menu");t&&t.classList.toggle("open")}function rtbcbExportPDF(){window.print()}"undefined"==typeof rtbcbReport||isValidUrl(rtbcbReport.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcbReport.ajax_url=ajaxurl),document.addEventListener("DOMContentLoaded",function(){console.log("RTBCB Report: Initializing enhanced dashboard"),initializeCharts(),initializeSectionToggles(),initializeInteractiveMetrics(),initializeResponsiveFeatures(),document.querySelector(".rtbcb-enhanced-report")?.classList.add("loaded")}),window.rtbcbExportPDF=rtbcbExportPDF;