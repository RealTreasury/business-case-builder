const RTBCB_GPT5_MIN_TOKENS=256,RTBCB_GPT5_MAX_TOKENS=8e3;if("function"==typeof require)try{require("./public/js/chartjs-adapter-date-fns.bundle.min.js")}catch(e){}function initializeCharts(){if("undefined"==typeof Chart)return void console.warn("RTBCB: Chart.js not loaded, skipping chart initialization");initializeROIChart();initializeComparisonCharts(),initializeSensitivityChart(),console.log("RTBCB: Charts initialized successfully")}function initializeROIChart(){const e=document.getElementById("rtbcb-roi-chart");if(!e)return console.log("RTBCB: ROI chart canvas not found"),null;const t=window.rtbcbChartData||generateFallbackChartData();if(!t||!t.datasets||0===t.datasets.length)return console.warn("RTBCB: No chart data available"),null;try{const n=new Chart(e,{type:"bar",data:t,options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{title:{display:!0,text:"ROI Analysis by Component",font:{size:16,weight:"bold"},padding:20},legend:{display:!0,position:"bottom",labels:{usePointStyle:!0,padding:20}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"#333",borderWidth:1,callbacks:{label:function(e){return e.dataset.label+": $"+(new Intl.NumberFormat).format(e.raw)},footer:function(e){if(e.length>0){const t=getComponentInfo(e[0].dataIndex);return t?"\n"+t:""}return""}}}},scales:{x:{grid:{display:!1},ticks:{font:{size:12}}},y:{beginAtZero:!0,grid:{borderDash:[5,5],color:"rgba(0, 0, 0, 0.1)"},ticks:{callback:function(e){return"$"+(new Intl.NumberFormat).format(e)},font:{size:11}}}},animation:{duration:1500,easing:"easeInOutQuart"}}});return e.onclick=function(e){const t=n.getElementsAtEventForMode(e,"nearest",{intersect:!0},!0);if(t.length){const e=t[0];handleChartClick(e.datasetIndex,e.index)}},n}catch(t){return console.error("RTBCB: Error initializing ROI chart:",t),showChartError(e,"Error loading ROI chart"),null}}function initializeComparisonCharts(){if(!document.querySelector(".rtbcb-scenario-comparison"))return;["conservative","base","optimistic"].forEach(e=>{const t=document.querySelector(`#rtbcb-${e}-chart`);t&&createScenarioMiniChart(t,e)})}function createScenarioMiniChart(e,t){const n=window.rtbcbChartData||generateFallbackChartData();if(!n||!n.labels||!n.datasets)return;const i={conservative:0,base:1,optimistic:2}[t],r=n.datasets[i];if(r)try{new Chart(e,{type:"bar",data:{labels:n.labels,datasets:[{label:r.label,data:r.data,backgroundColor:r.backgroundColor}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!1},y:{display:!1}}}})}catch(e){console.error("RTBCB: Error initializing scenario chart:",e)}}function initializeSensitivityChart(){const e=document.getElementById("rtbcb-sensitivity-chart");if(!e)return;const t=window.rtbcbSensitivityData||generateFallbackSensitivityData();try{new Chart(e,{type:"bar",data:t,options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Sensitivity Analysis - Impact on ROI",font:{size:14,weight:"bold"}},legend:{display:!1}},scales:{x:{ticks:{callback:function(e){return e+"%"}}},y:{ticks:{font:{size:10}}}}}})}catch(e){console.error("RTBCB: Error initializing sensitivity chart:",e)}}function initializeSectionToggles(e=document){void 0!==e&&"function"==typeof e.querySelectorAll&&e.querySelectorAll(".rtbcb-section-toggle").forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const n=this.getAttribute("data-target"),i=e.getElementById(n),r=this.querySelector(".rtbcb-toggle-arrow"),o=this.querySelector(".rtbcb-toggle-text"),a=this.closest(".rtbcb-section-enhanced");if(i){const e="none"!==i.style.display;e?(i.style.maxHeight=i.scrollHeight+"px",i.offsetHeight,i.style.maxHeight="0px",i.style.opacity="0",setTimeout(()=>{i.style.display="none"},300)):(i.style.display="block",i.style.maxHeight="0px",i.style.opacity="0",i.offsetHeight,i.style.maxHeight=i.scrollHeight+"px",i.style.opacity="1",setTimeout(()=>{i.style.maxHeight="none"},300)),r&&(r.textContent=e?"▼":"▲"),o&&(o.textContent=e?"Expand":"Collapse"),a&&a.classList.toggle("collapsed",e),trackSectionToggle(n,!e)}})})}function initializeInteractiveMetrics(){"undefined"!=typeof document&&"function"==typeof document.querySelectorAll&&(document.querySelectorAll(".rtbcb-metric-card").forEach(e=>{e.addEventListener("mouseenter",function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 8px 25px rgba(0, 0, 0, 0.15)"}),e.addEventListener("mouseleave",function(){this.style.transform="translateY(0)",this.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.1)"}),e.addEventListener("click",function(){expandMetricDetails(this)})}),initializeValueDriverAnimations(),initializeProgressBars())}function initializeResponsiveFeatures(){if("undefined"==typeof document||"function"!=typeof document.querySelector)return;const e=document.querySelector(".rtbcb-mobile-toggle");let t;e&&e.addEventListener("click",toggleMobileMenu),window.addEventListener("resize",function(){clearTimeout(t),t=setTimeout(()=>{window.Chart&&Chart.helpers.each(Chart.instances,function(e){e.resize()})},250)}),window.addEventListener("beforeprint",function(){document.body.classList.add("rtbcb-printing")}),window.addEventListener("afterprint",function(){document.body.classList.remove("rtbcb-printing")})}function generateFallbackChartData(){const e=document.querySelector(".rtbcb-scenario-card.conservative"),t=document.querySelector(".rtbcb-scenario-card.base"),n=document.querySelector(".rtbcb-scenario-card.optimistic");if(!e||!t||!n)return console.warn("RTBCB: Scenario cards not found, using minimal fallback data"),{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Estimated Benefits",data:[5e4,2e4,3e4,1e5],backgroundColor:"rgba(59, 130, 246, 0.8)"}]};const i=(e,t)=>{const n=e.querySelector(t);if(n){const e=n.textContent.replace(/[$,]/g,"");return parseFloat(e)||0}return 0};return{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Conservative",data:[i(e,'[data-metric="labor_savings"]'),i(e,'[data-metric="fee_savings"]'),i(e,'[data-metric="error_reduction"]'),i(e,'[data-metric="total_benefit"]')],backgroundColor:"rgba(239, 68, 68, 0.8)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:2},{label:"Base Case",data:[i(t,'[data-metric="labor_savings"]'),i(t,'[data-metric="fee_savings"]'),i(t,'[data-metric="error_reduction"]'),i(t,'[data-metric="total_benefit"]')],backgroundColor:"rgba(59, 130, 246, 0.8)",borderColor:"rgba(59, 130, 246, 1)",borderWidth:2},{label:"Optimistic",data:[i(n,'[data-metric="labor_savings"]'),i(n,'[data-metric="fee_savings"]'),i(n,'[data-metric="error_reduction"]'),i(n,'[data-metric="total_benefit"]')],backgroundColor:"rgba(16, 185, 129, 0.8)",borderColor:"rgba(16, 185, 129, 1)",borderWidth:2}]}}function generateFallbackSensitivityData(){return{labels:["Implementation Delay","Adoption Challenges","Technology Evolution","Market Conditions"],datasets:[{label:"Impact %",data:[-15,-25,10,5],backgroundColor:function(e){return e.parsed.x<0?"rgba(239, 68, 68, 0.8)":"rgba(16, 185, 129, 0.8)"}}]}}function getComponentInfo(e){return["Automated processes reduce manual labor costs","Optimized banking relationships lower transaction fees","Reduced errors prevent costly mistakes and rework","Combined benefits drive strong ROI"][e]||""}function showChartError(e,t){const n=e.getContext("2d");n.clearRect(0,0,e.width,e.height),n.fillStyle="#666",n.font="14px Arial",n.textAlign="center",n.fillText(t,e.width/2,e.height/2)}function handleChartClick(e,t){console.log("Chart clicked:",e,t)}function expandMetricDetails(e){e.classList.toggle("expanded"),e.classList.contains("expanded")?showMetricDetails(e):hideMetricDetails(e)}function showMetricDetails(e){if(e.querySelector(".rtbcb-metric-details"))return;const t=document.createElement("div");t.className="rtbcb-metric-details",t.innerHTML="<p>Click for detailed breakdown and analysis</p>",e.appendChild(t)}function hideMetricDetails(e){const t=e.querySelector(".rtbcb-metric-details");t&&t.remove()}function initializeValueDriverAnimations(){document.querySelectorAll(".rtbcb-value-driver-enhanced").forEach((e,t)=>{setTimeout(()=>{e.style.opacity="1",e.style.transform="translateX(0)"},200*t)})}function initializeProgressBars(){document.querySelectorAll(".rtbcb-progress-bar").forEach(e=>{const t=e.dataset.progress||"0";setTimeout(()=>{e.style.width=t+"%"},500)})}function trackSectionToggle(e,t){"undefined"!=typeof gtag&&gtag("event","section_toggle",{section_id:e,expanded:t})}function toggleMobileMenu(){const e=document.querySelector(".rtbcb-mobile-menu");e&&e.classList.toggle("open")}async function generateProfessionalReport(e,t=()=>{}){const n=await fetch(rtbcbReport.template_url);if(!n.ok)throw new Error("Failed to load template");const i=await n.text(),r=parseInt(rtbcbReport.min_output_tokens,10)||0,o=parseInt(rtbcbReport.max_output_tokens,10)||0;let a=Math.max(r,3e3);o>0&&(a=Math.min(a,o));const c={model:rtbcbReport.report_model,context:e,max_output_tokens:a};(rtbcbReport.model_capabilities?.temperature?.unsupported||[]).includes(rtbcbReport.report_model)||(c.temperature=.7);const s=new FormData;s.append("action","rtbcb_generate_report"),rtbcbReport.nonce&&s.append("rtbcb_nonce",rtbcbReport.nonce),s.append("body",JSON.stringify(c));const l=await fetch(rtbcbReport.ajax_url,{method:"POST",body:s});if(!l.ok)throw new Error(l.statusText||"Report generation failed");let d="";if(l.body){const e=l.body.getReader(),n=new TextDecoder;for(;;){const{value:i,done:r}=await e.read();if(r)break;d+=n.decode(i,{stream:!0}),t(d)}}else d=await l.text(),t(d);const u="undefined"!=typeof DOMPurify?DOMPurify.sanitize(e):e;return i.replace("{{BUSINESS_CONTEXT}}",u).replace("\x3c!-- GENERATE THE REPORT CONTENT HERE FOLLOWING THIS STRUCTURE: --\x3e",d)}function sanitizeReportHTML(e){return"undefined"!=typeof DOMPurify?DOMPurify.sanitize(e,{ALLOWED_TAGS:["a","p","br","strong","em","ul","ol","li","h1","h2","h3","h4","h5","h6","div","span","table","thead","tbody","tr","th","td"],ALLOWED_ATTR:["href","title","target","rel","style"]}):e}function displayReport(e){const t=document.createElement("iframe");t.style.width="100%",t.style.height="800px",t.style.border="1px solid #ddd",t.srcdoc=sanitizeReportHTML(e),t.addEventListener("load",()=>{t.contentDocument&&(initializeAIHighlights(t.contentDocument),initializeSectionToggles(t.contentDocument))}),document.getElementById("report-container").appendChild(t)}async function generateAndDisplayReport(e){const t=document.getElementById("loading"),n=document.getElementById("error"),i=document.getElementById("report-container");t&&(t.style.display="block"),n&&(n.style.display="none"),i&&(i.innerHTML="");try{const t=await generateProfessionalReport(e,e=>{i&&(i.textContent=e)});if(!t||!t.trim())throw new Error("Empty response from API");t.includes("<html")||console.warn("RTBCB: HTML fragment received from API");const r=sanitizeReportHTML(t);if(!r||!r.trim())return console.error("RTBCB: Sanitized report is empty or invalid"),void(n?(n.textContent="Error: Malformed report content.",n.style.display="block"):console.error("RTBCB: Malformed report content."));i&&(i.innerHTML=""),displayReport(r)}catch(e){n?(n.textContent="Error: "+e.message,n.style.display="block"):console.error("RTBCB: "+e.message)}finally{t&&(t.style.display="none")}}function initializeAIHighlights(e=document){if("function"!=typeof e.getElementById||"function"!=typeof e.querySelector)return;const t=e.getElementById("rtbcb-ai-toggle"),n=e.querySelector(".rtbcb-enhanced-report");t&&n&&(t.addEventListener("change",()=>{n.classList.toggle("show-ai-highlights",t.checked)}),addHighlight(e,".rtbcb-company-intelligence","This section was enriched by AI."))}function addHighlight(e,t,n){const i=e.querySelector(t);if(i){i.classList.add("ai-highlight");const t=e.createElement("div");t.className="ai-tooltip",t.textContent=n,i.appendChild(t)}}"undefined"!=typeof document&&"function"==typeof document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){console.log("RTBCB Report: Initializing enhanced dashboard"),initializeCharts(),initializeSectionToggles(),initializeInteractiveMetrics(),initializeResponsiveFeatures(),initializeAIHighlights(),"function"==typeof document.querySelector&&document.querySelector(".rtbcb-enhanced-report")?.classList.add("loaded")});