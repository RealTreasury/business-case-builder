if(typeof document!=="undefined"&&typeof document.addEventListener==="function"){document.addEventListener("DOMContentLoaded",function(){console.log("RTBCB Report: Initializing enhanced dashboard");initializeCharts();initializeSectionToggles();initializeInteractiveMetrics();initializeResponsiveFeatures();document.querySelector(".rtbcb-enhanced-report")?.classList.add("loaded")})}function initializeCharts(){if(typeof Chart==="undefined"){console.warn("RTBCB: Chart.js not loaded, skipping chart initialization");return}const roiChart=initializeROIChart();initializeComparisonCharts();initializeSensitivityChart();console.log("RTBCB: Charts initialized successfully")}function initializeROIChart(){const ctx=document.getElementById("rtbcb-roi-chart");if(!ctx){console.log("RTBCB: ROI chart canvas not found");return null}const chartData=window.rtbcbChartData||generateFallbackChartData();if(!chartData||!chartData.datasets||chartData.datasets.length===0){console.warn("RTBCB: No chart data available");return null}try{const chart=new Chart(ctx,{type:"bar",data:chartData,options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:"index"},plugins:{title:{display:true,text:"ROI Analysis by Component",font:{size:16,weight:"bold"},padding:20},legend:{display:true,position:"bottom",labels:{usePointStyle:true,padding:20}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"#333",borderWidth:1,callbacks:{label:function(context){return context.dataset.label+": $"+(new Intl.NumberFormat).format(context.raw)},footer:function(tooltipItems){if(tooltipItems.length>0){const dataIndex=tooltipItems[0].dataIndex;const componentInfo=getComponentInfo(dataIndex);return componentInfo?"\n"+componentInfo:""}return""}}}},scales:{x:{grid:{display:false},ticks:{font:{size:12}}},y:{beginAtZero:true,grid:{borderDash:[5,5],color:"rgba(0, 0, 0, 0.1)"},ticks:{callback:function(value){return"$"+(new Intl.NumberFormat).format(value)},font:{size:11}}}},animation:{duration:1500,easing:"easeInOutQuart"}}});ctx.onclick=function(evt){const points=chart.getElementsAtEventForMode(evt,"nearest",{intersect:true},true);if(points.length){const firstPoint=points[0];handleChartClick(firstPoint.datasetIndex,firstPoint.index)}};return chart}catch(error){console.error("RTBCB: Error initializing ROI chart:",error);showChartError(ctx,"Error loading ROI chart");return null}}function initializeComparisonCharts(){const comparisonContainer=document.querySelector(".rtbcb-scenario-comparison");if(!comparisonContainer)return;const scenarios=["conservative","base","optimistic"];scenarios.forEach(scenario=>{const canvas=document.querySelector(`#rtbcb-${scenario}-chart`);if(canvas){createScenarioMiniChart(canvas,scenario)}})}function createScenarioMiniChart(canvas,scenario){const chartData=window.rtbcbChartData||generateFallbackChartData();if(!chartData||!chartData.labels||!chartData.datasets)return;const scenarioIndex={conservative:0,base:1,optimistic:2}[scenario];const dataset=chartData.datasets[scenarioIndex];if(!dataset)return;try{new Chart(canvas,{type:"bar",data:{labels:chartData.labels,datasets:[{label:dataset.label,data:dataset.data,backgroundColor:dataset.backgroundColor}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}})}catch(error){console.error("RTBCB: Error initializing scenario chart:",error)}}function initializeSensitivityChart(){const ctx=document.getElementById("rtbcb-sensitivity-chart");if(!ctx)return;const sensitivityData=window.rtbcbSensitivityData||generateFallbackSensitivityData();try{new Chart(ctx,{type:"bar",data:sensitivityData,options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"Sensitivity Analysis - Impact on ROI",font:{size:14,weight:"bold"}},legend:{display:false}},scales:{x:{ticks:{callback:function(value){return value+"%"}}},y:{ticks:{font:{size:10}}}}}})}catch(error){console.error("RTBCB: Error initializing sensitivity chart:",error)}}function initializeSectionToggles(){document.querySelectorAll(".rtbcb-section-toggle").forEach(toggle=>{toggle.addEventListener("click",function(e){e.preventDefault();const targetId=this.getAttribute("data-target");const content=document.getElementById(targetId);const arrow=this.querySelector(".rtbcb-toggle-arrow");const text=this.querySelector(".rtbcb-toggle-text");const section=this.closest(".rtbcb-section-enhanced");if(content){const isVisible=content.style.display!=="none";if(isVisible){content.style.maxHeight=content.scrollHeight+"px";content.offsetHeight;content.style.maxHeight="0px";content.style.opacity="0";setTimeout(()=>{content.style.display="none"},300)}else{content.style.display="block";content.style.maxHeight="0px";content.style.opacity="0";content.offsetHeight;content.style.maxHeight=content.scrollHeight+"px";content.style.opacity="1";setTimeout(()=>{content.style.maxHeight="none"},300)}if(arrow){arrow.textContent=isVisible?"▼":"▲"}if(text){text.textContent=isVisible?"Expand":"Collapse"}if(section){section.classList.toggle("collapsed",isVisible)}trackSectionToggle(targetId,!isVisible)}})})}function initializeInteractiveMetrics(){document.querySelectorAll(".rtbcb-metric-card").forEach(card=>{card.addEventListener("mouseenter",function(){this.style.transform="translateY(-2px)";this.style.boxShadow="0 8px 25px rgba(0, 0, 0, 0.15)"});card.addEventListener("mouseleave",function(){this.style.transform="translateY(0)";this.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.1)"});card.addEventListener("click",function(){expandMetricDetails(this)})});initializeValueDriverAnimations();initializeProgressBars()}function initializeResponsiveFeatures(){const mobileToggle=document.querySelector(".rtbcb-mobile-toggle");if(mobileToggle){mobileToggle.addEventListener("click",toggleMobileMenu)}let resizeTimeout;window.addEventListener("resize",function(){clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{if(window.Chart){Chart.helpers.each(Chart.instances,function(instance){instance.resize()})}},250)});window.addEventListener("beforeprint",function(){document.body.classList.add("rtbcb-printing")});window.addEventListener("afterprint",function(){document.body.classList.remove("rtbcb-printing")})}function generateFallbackChartData(){const conservativeCard=document.querySelector(".rtbcb-scenario-card.conservative");const baseCard=document.querySelector(".rtbcb-scenario-card.base");const optimisticCard=document.querySelector(".rtbcb-scenario-card.optimistic");if(!conservativeCard||!baseCard||!optimisticCard){console.warn("RTBCB: Scenario cards not found, using minimal fallback data");return{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Estimated Benefits",data:[5e4,2e4,3e4,1e5],backgroundColor:"rgba(59, 130, 246, 0.8)"}]}}const extractValue=(card,selector)=>{const element=card.querySelector(selector);if(element){const text=element.textContent.replace(/[$,]/g,"");return parseFloat(text)||0}return 0};return{labels:["Labor Savings","Fee Reduction","Error Prevention","Total Benefit"],datasets:[{label:"Conservative",data:[extractValue(conservativeCard,'[data-metric="labor_savings"]'),extractValue(conservativeCard,'[data-metric="fee_savings"]'),extractValue(conservativeCard,'[data-metric="error_reduction"]'),extractValue(conservativeCard,'[data-metric="total_benefit"]')],backgroundColor:"rgba(239, 68, 68, 0.8)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:2},{label:"Base Case",data:[extractValue(baseCard,'[data-metric="labor_savings"]'),extractValue(baseCard,'[data-metric="fee_savings"]'),extractValue(baseCard,'[data-metric="error_reduction"]'),extractValue(baseCard,'[data-metric="total_benefit"]')],backgroundColor:"rgba(59, 130, 246, 0.8)",borderColor:"rgba(59, 130, 246, 1)",borderWidth:2},{label:"Optimistic",data:[extractValue(optimisticCard,'[data-metric="labor_savings"]'),extractValue(optimisticCard,'[data-metric="fee_savings"]'),extractValue(optimisticCard,'[data-metric="error_reduction"]'),extractValue(optimisticCard,'[data-metric="total_benefit"]')],backgroundColor:"rgba(16, 185, 129, 0.8)",borderColor:"rgba(16, 185, 129, 1)",borderWidth:2}]}}function generateFallbackSensitivityData(){return{labels:["Implementation Delay","Adoption Challenges","Technology Evolution","Market Conditions"],datasets:[{label:"Impact %",data:[-15,-25,10,5],backgroundColor:function(context){const value=context.parsed.x;return value<0?"rgba(239, 68, 68, 0.8)":"rgba(16, 185, 129, 0.8)"}}]}}function getComponentInfo(dataIndex){const info=["Automated processes reduce manual labor costs","Optimized banking relationships lower transaction fees","Reduced errors prevent costly mistakes and rework","Combined benefits drive strong ROI"];return info[dataIndex]||""}function showChartError(canvas,message){const ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#666";ctx.font="14px Arial";ctx.textAlign="center";ctx.fillText(message,canvas.width/2,canvas.height/2)}function handleChartClick(datasetIndex,index){console.log("Chart clicked:",datasetIndex,index)}function expandMetricDetails(card){card.classList.toggle("expanded");if(card.classList.contains("expanded")){showMetricDetails(card)}else{hideMetricDetails(card)}}function showMetricDetails(card){const existing=card.querySelector(".rtbcb-metric-details");if(existing)return;const details=document.createElement("div");details.className="rtbcb-metric-details";details.innerHTML="<p>Click for detailed breakdown and analysis</p>";card.appendChild(details)}function hideMetricDetails(card){const details=card.querySelector(".rtbcb-metric-details");if(details){details.remove()}}function initializeValueDriverAnimations(){const drivers=document.querySelectorAll(".rtbcb-value-driver-enhanced");drivers.forEach((driver,index)=>{setTimeout(()=>{driver.style.opacity="1";driver.style.transform="translateX(0)"},index*200)})}function initializeProgressBars(){const progressBars=document.querySelectorAll(".rtbcb-progress-bar");progressBars.forEach(bar=>{const progress=bar.dataset.progress||"0";setTimeout(()=>{bar.style.width=progress+"%"},500)})}function trackSectionToggle(sectionId,expanded){if(typeof gtag!=="undefined"){gtag("event","section_toggle",{section_id:sectionId,expanded:expanded})}}function toggleMobileMenu(){const menu=document.querySelector(".rtbcb-mobile-menu");if(menu){menu.classList.toggle("open")}}async function generateProfessionalReport(businessContext,onProgress=()=>{}){const templateResponse=await fetch(rtbcbReport.template_url);if(!templateResponse.ok){throw new Error("Failed to load template")}const templateHtml=await templateResponse.text();const minTokens=parseInt(rtbcbReport.min_output_tokens,10)||0;const maxTokens=parseInt(rtbcbReport.max_output_tokens,10)||0;let tokenEstimate=Math.max(minTokens,3e3);if(maxTokens>0){tokenEstimate=Math.min(tokenEstimate,maxTokens)}const requestBody={model:rtbcbReport.report_model,context:businessContext,max_output_tokens:tokenEstimate};const unsupportedTemps=rtbcbReport.model_capabilities?.temperature?.unsupported||[];if(!unsupportedTemps.includes(rtbcbReport.report_model)){requestBody.temperature=.7}const formData=new FormData;formData.append("action","rtbcb_generate_report");if(rtbcbReport.nonce){formData.append("rtbcb_nonce",rtbcbReport.nonce)}formData.append("body",JSON.stringify(requestBody));const response=await fetch(rtbcbReport.ajax_url,{method:"POST",body:formData});if(!response.ok){throw new Error(response.statusText||"Report generation failed")}let reportContent="";if(response.body){const reader=response.body.getReader();const decoder=new TextDecoder;while(true){const{value:value,done:done}=await reader.read();if(done)break;const chunk=decoder.decode(value,{stream:true});reportContent+=chunk;onProgress(reportContent)}}else{reportContent=await response.text();onProgress(reportContent)}const safeContext=typeof DOMPurify!=="undefined"?DOMPurify.sanitize(businessContext):businessContext;return templateHtml.replace("{{BUSINESS_CONTEXT}}",safeContext).replace("\x3c!-- GENERATE THE REPORT CONTENT HERE FOLLOWING THIS STRUCTURE: --\x3e",reportContent)}function sanitizeReportHTML(htmlContent){const allowedTags=["a","p","br","strong","em","ul","ol","li","h1","h2","h3","h4","h5","h6","div","span","table","thead","tbody","tr","th","td"];const allowedAttr=["href","title","target","rel","style"];return typeof DOMPurify!=="undefined"?DOMPurify.sanitize(htmlContent,{ALLOWED_TAGS:allowedTags,ALLOWED_ATTR:allowedAttr}):htmlContent}function displayReport(htmlContent){const iframe=document.createElement("iframe");iframe.style.width="100%";iframe.style.height="800px";iframe.style.border="1px solid #ddd";iframe.srcdoc=sanitizeReportHTML(htmlContent);document.getElementById("report-container").appendChild(iframe)}function exportToPDF(htmlContent){const sanitized=sanitizeReportHTML(htmlContent);const blob=new Blob([sanitized],{type:"text/html"});const url=URL.createObjectURL(blob);const printWindow=window.open(url,"_blank");if(printWindow){printWindow.focus();printWindow.onload=function(){printWindow.print();URL.revokeObjectURL(url)}}else{console.error("Failed to open print window")}}async function generateAndDisplayReport(businessContext){const loadingElement=document.getElementById("loading");const errorElement=document.getElementById("error");const reportContainer=document.getElementById("report-container");loadingElement.style.display="block";errorElement.style.display="none";reportContainer.innerHTML="";try{const htmlReport=await generateProfessionalReport(businessContext,partial=>{reportContainer.textContent=partial});if(!htmlReport.includes("<!DOCTYPE html>")){throw new Error("Invalid HTML response from API")}const safeReport=sanitizeReportHTML(htmlReport);reportContainer.innerHTML="";displayReport(safeReport);const exportBtn=document.createElement("button");exportBtn.textContent="Export to PDF";exportBtn.className="export-btn";exportBtn.onclick=function(){exportToPDF(safeReport)};reportContainer.appendChild(exportBtn)}catch(error){errorElement.textContent="Error: "+error.message;errorElement.style.display="block"}finally{loadingElement.style.display="none"}}function rtbcbExportPDF(){window.print()}window.rtbcbExportPDF=rtbcbExportPDF;