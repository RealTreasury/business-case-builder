window.openBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&(e.classList.add("active"),document.body.style.overflow="hidden",window.businessCaseBuilder?window.businessCaseBuilder.reinitialize():window.businessCaseBuilder=new BusinessCaseBuilder)},window.closeBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&(e.classList.remove("active"),document.body.style.overflow="")},document.addEventListener("DOMContentLoaded",function(){try{document.getElementById("rtbcbForm")&&(window.businessCaseBuilder=new BusinessCaseBuilder)}catch(e){console.error("BusinessCaseBuilder initialization failed:",e)}});class BusinessCaseBuilder{constructor(){this.currentStep=1,this.totalSteps=5,this.form=document.getElementById("rtbcbForm"),this.overlay=document.getElementById("rtbcbModalOverlay"),this.ajaxUrl="undefined"!=typeof rtbcbAjax&&rtbcbAjax.ajax_url?rtbcbAjax.ajax_url:"",this.form&&this.init()}init(){this.cacheElements(),this.bindEvents(),this.updateStepVisibility(),this.updateProgressIndicator()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next"),this.prevBtn=this.form.querySelector(".rtbcb-nav-prev"),this.submitBtn=this.form.querySelector(".rtbcb-nav-submit"),this.steps=this.form.querySelectorAll(".rtbcb-wizard-step"),this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step"),this.progressLine=this.form.querySelector(".rtbcb-progress-line"),this.stepFields={1:["company_name","company_size","industry"],2:["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],3:["pain_points"],4:["business_objective","implementation_timeline","budget_range"],5:["email"]}}bindEvents(){this.nextBtn&&this.nextBtn.addEventListener("click",e=>{e.preventDefault(),this.handleNext()}),this.prevBtn&&this.prevBtn.addEventListener("click",e=>{e.preventDefault(),this.handlePrev()}),this.form.addEventListener("submit",e=>{if(e.preventDefault(),this.validateStep(this.totalSteps))try{this.handleSubmit(e)}catch(e){console.error("RTBCB: handleSubmit error:",e),this.showEnhancedError("An unexpected error occurred. Please try again.")}});this.form.querySelectorAll(".rtbcb-pain-point-card").forEach(e=>{const t=e.querySelector('input[type="checkbox"]');t&&t.addEventListener("change",()=>{e.classList.toggle("rtbcb-selected",t.checked);this.form.querySelectorAll('input[name="pain_points[]"]:checked').length>0&&this.clearStepError(3)})}),this.form.querySelectorAll("input, select").forEach(e=>{e.addEventListener("blur",()=>this.validateField(e)),e.addEventListener("input",()=>this.clearFieldError(e))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.overlay.classList.contains("active")&&window.closeBusinessCaseModal()})}handleNext(){this.validateStep(this.currentStep)&&this.currentStep<this.totalSteps&&(this.currentStep++,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}handlePrev(){this.currentStep>1&&(this.currentStep--,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}validateStep(e){let t=!0;const n=this.stepFields[e];if(3===e){if(0===this.form.querySelectorAll('input[name="pain_points[]"]:checked').length)return this.showStepError(3,"Please select at least one challenge"),!1;this.clearStepError(3)}else n.forEach(e=>{const n=this.form.querySelector(`[name="${e}"]`);n&&!this.validateField(n)&&(t=!1)});return t}validateField(e){const t=e.value.trim();let n=!0,r="";if(e.hasAttribute("required")&&!t&&(r="This field is required",n=!1),"company_name"===e.name&&t&&(t.length<2?(r="Company name must be at least 2 characters",n=!1):t.length>100?(r="Company name must be less than 100 characters",n=!1):/^[^a-zA-Z]*$/.test(t)&&(r="Please enter a valid company name",n=!1)),"email"===e.type&&t){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||(r="Please enter a valid email address",n=!1)}return"number"===e.type&&t&&(Number.isFinite(Number(t))||(r="Please enter a valid number",n=!1)),n?this.clearFieldError(e):this.showFieldError(e,r),n}showFieldError(e,t){const n=e.closest(".rtbcb-field");if(!n)return;this.clearFieldError(e),e.classList.add("rtbcb-field-invalid");const r=document.createElement("div");r.className="rtbcb-field-error",r.textContent=t,n.appendChild(r)}clearFieldError(e){const t=e.closest(".rtbcb-field");if(!t)return;e.classList.remove("rtbcb-field-invalid");const n=t.querySelector(".rtbcb-field-error");n&&n.remove()}showStepError(e,t){const n=this.steps[e-1];if(!n)return;const r=n.querySelector(".rtbcb-pain-points-validation");if(r){const e=r.querySelector(".rtbcb-validation-message");e&&(e.textContent=t,e.style.display="block",e.style.color="#ef4444")}}clearStepError(e){const t=this.steps[e-1];if(!t)return;const n=t.querySelector(".rtbcb-pain-points-validation");if(n){const e=n.querySelector(".rtbcb-validation-message");e&&(e.style.display="none")}}updateStepVisibility(){if(this.steps.forEach((e,t)=>{t+1===this.currentStep?(e.classList.add("active"),e.style.display="block"):(e.classList.remove("active"),e.style.display="none")}),this.prevBtn&&(this.prevBtn.style.display=1===this.currentStep?"none":"inline-flex"),this.currentStep===this.totalSteps?this.nextBtn&&(this.nextBtn.style.display="none"):this.nextBtn&&(this.nextBtn.style.display="inline-flex"),this.submitBtn){this.currentStep===this.totalSteps?(this.submitBtn.style.display="inline-flex",this.submitBtn.disabled=!1):(this.submitBtn.style.display="none",this.submitBtn.disabled=!0)}}updateProgressIndicator(){if(this.progressSteps.forEach((e,t)=>{const n=t+1;n<this.currentStep?(e.classList.add("completed"),e.classList.remove("active")):n===this.currentStep?(e.classList.add("active"),e.classList.remove("completed")):e.classList.remove("active","completed")}),this.progressLine){const e=this.currentStep/this.totalSteps*100;this.progressLine.style.width=`${e}%`}}scrollToTop(){const e=this.form.closest(".rtbcb-modal-body");e&&(e.scrollTop=0)}async handleSubmit(e){if(e&&e.preventDefault&&e.preventDefault(),this.ajaxUrl)try{console.log("RTBCB: Starting form submission"),this.showLoading();const e=this.collectFormData();this.validateFormData(e);const t=await fetch(this.ajaxUrl,{method:"POST",body:e,credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html"}});if(console.log("RTBCB: Response status:",t.status),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.text();let r;console.log("RTBCB: Response received, length:",n.length);try{r=JSON.parse(n),console.log("RTBCB: Parsed JSON response:",r)}catch(e){if(console.log("RTBCB: Response is not JSON, treating as HTML"),n.includes('<div class="rtbcb-enhanced-report"')||n.includes('<div class="rtbcb-report"'))return void this.showEnhancedHTMLReport(n);throw new Error("Invalid response format")}if(r.success)if(r.data&&r.data.job_id)this.pollJob(r.data.job_id,Date.now(),0);else{if(!r.data)throw new Error("No report data received");r.data.report_html?this.handleSuccess(r.data):r.data.report_data?this.handleSuccess(r.data.report_data):this.handleSuccess(r.data)}else console.error("RTBCB: Error response:",r.data),this.handleError(r.data||{message:"Unknown error occurred"})}catch(e){console.error("RTBCB: Submission error:",e),this.handleError({message:e.message||"An unexpected error occurred",type:"submission_error"})}else this.showEnhancedError("Service unavailable. Please reload the page.")}collectFormData(){const e=new FormData(this.form),t=new FormData,n=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const[r,s]of e.entries())if(n.includes(r)){const e=parseFloat(s);t.append(r,Number.isFinite(e)?e:0)}else t.append(r,s);return t.append("action","rtbcb_generate_case"),"undefined"!=typeof rtbcbAjax&&rtbcbAjax.nonce&&t.append("rtbcb_nonce",rtbcbAjax.nonce),t}validateFormData(e){const t=t=>{if("function"==typeof e.get)return e.get(t);for(const[n,r]of e.entries())if(n===t)return r;return null},n=["email","company_name","company_size","industry","hours_reconciliation","hours_cash_positioning","num_banks","ftes","business_objective","implementation_timeline","budget_range"];for(const e of n)if(!t(e))throw new Error(`Missing required field: ${e.replace("_"," ")}`);const r=t("email");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))throw new Error("Please enter a valid email address");const s=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const e of s){const n=parseFloat(t(e));if(isNaN(n)||n<=0)throw new Error(`${e.replace("_"," ")} must be a positive number`)}if(0===(t=>{if("function"==typeof e.getAll)return e.getAll(t);const n=[];for(const[r,s]of e.entries())r===t&&n.push(s);return n})("pain_points[]").length)throw new Error("Please select at least one pain point")}showLoading(){const e=this.form&&"function"==typeof this.form.closest?this.form.closest(".rtbcb-form-container"):null;e&&(e.style.display="none");const t=document.getElementById("rtbcb-progress-container");if(t){const e=this.form.querySelector('[name="company_name"]')?.value||"your company";t.innerHTML=`\n                <div class="rtbcb-progress-content">\n                    <div class="rtbcb-progress-spinner"></div>\n                    <div class="rtbcb-progress-text">Generating Your Business Case</div>\n                    <div class="rtbcb-progress-step">\n                        <span class="rtbcb-progress-step-text" id="rtbcb-progress-status">Analyzing ${this.escapeHTML(e)}'s treasury operations...</span>\n                    </div>\n                </div>\n            `,t.style.display="flex"}}hideLoading(){const e=document.getElementById("rtbcb-progress-container");e&&(e.style.display="none",e.innerHTML="");const t=this.form&&"function"==typeof this.form.closest?this.form.closest(".rtbcb-form-container"):null;t&&(t.style.display="block")}async pollJob(e,t=Date.now(),n=0){if(Date.now()-t>12e5||n>600)this.handleError({message:"The request timed out after 20 minutes. Please try again later.",type:"timeout"});else try{const r=await fetch(`${this.ajaxUrl}?action=rtbcb_job_status&job_id=${encodeURIComponent(e)}&rtbcb_nonce=${rtbcbAjax.nonce}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}}),s=await r.json();if(!s.success)return void this.handleError({message:"Unable to retrieve job status",type:"polling_error"});const i=s.data,o=i.status;console.log(`RTBCB: Job status: ${o} (attempt ${n})`);const a=document.getElementById("rtbcb-progress-status"),c=i.step||i.message;a&&c&&(a.textContent=c),"completed"===o?(this.hideLoading(),i.report_html?this.handleSuccess(i):i.report_data?this.handleSuccess(i.report_data):this.handleError({message:"Report data missing from completed job",type:"job_error"})):"error"===o?(this.hideLoading(),this.handleError({message:i.message||"Job failed",type:"job_error"})):setTimeout(()=>this.pollJob(e,t,n+1),2e3)}catch(e){console.error("RTBCB: Job polling error:",e),this.handleError({message:e.message||"An unexpected error occurred",type:"polling_error"})}}handleSuccess(e){console.log("RTBCB: Success data received:",e),"string"!=typeof e?e.report_html&&e.report_html.trim()?this.showEnhancedHTMLReport(e.report_html):this.showResults(e):this.showEnhancedHTMLReport(e)}showEnhancedHTMLReport(e){console.log("RTBCB: Displaying enhanced HTML report"),this.hideLoading(),window.closeBusinessCaseModal();let t=document.getElementById("rtbcb-results-enhanced");if(t)console.log("RTBCB: Reusing existing results container");else{console.log("RTBCB: Creating results container"),t=document.createElement("div"),t.id="rtbcb-results-enhanced",t.className="rtbcb-enhanced-results-container";const e=document.getElementById("rtbcbModalOverlay");e&&e.parentNode?(e.parentNode.insertBefore(t,e.nextSibling),console.log("RTBCB: Results container inserted after modal")):(document.body.appendChild(t),console.log("RTBCB: Results container appended to body"))}console.log("RTBCB: Injecting report content"),t.innerHTML=e,t.style.display="block",this.initializeEnhancedReport(t),t.scrollIntoView({behavior:"smooth",block:"start"})}initializeEnhancedReport(e){this.initializeReportCharts(e),this.initializeCollapsibleSections(e),this.initializeInteractiveMetrics(e),this.initializeExportFunctions(e)}initializeReportCharts(e){const t=e.querySelector("#rtbcb-roi-chart");if(t)if(console.log("RTBCB: Initializing ROI chart"),"undefined"!=typeof Chart)try{const n=this.extractROIDataFromReport(e);if(console.log("RTBCB: Extracted ROI data",n),!n||0===Object.keys(n).length)return void console.warn("RTBCB: ROI data is empty. Chart will not be rendered");this.createROIChart(t,n)}catch(e){console.error("Failed to initialize chart:",e)}else console.warn("RTBCB: Chart.js library is not available")}extractROIDataFromReport(e){const t={};return e.querySelectorAll(".rtbcb-scenario-card").forEach(e=>{const n=this.getScenarioNameFromCard(e);n&&(t[n]=this.extractMetricsFromCard(e))}),t}getScenarioNameFromCard(e){if(e.classList.contains("conservative"))return"conservative";if(e.classList.contains("base"))return"base";if(e.classList.contains("optimistic"))return"optimistic";const t=e.querySelector("h4");if(t){const e=t.textContent.toLowerCase();if(e.includes("conservative"))return"conservative";if(e.includes("base"))return"base";if(e.includes("optimistic"))return"optimistic"}return null}extractMetricsFromCard(e){const t={};return e.querySelectorAll(".rtbcb-scenario-metric").forEach(e=>{const n=e.querySelector(".rtbcb-metric-label"),r=e.querySelector(".rtbcb-metric-value");if(n&&r){const e=n.textContent.trim(),s=r.textContent.replace(/[$,]/g,"").trim(),i=parseFloat(s)||0;e.includes("Total Annual")?t.total_annual_benefit=i:e.includes("Labor")?t.labor_savings=i:e.includes("Fee")?t.fee_savings=i:e.includes("Error")&&(t.error_reduction=i)}}),t}createROIChart(e,t){console.log("RTBCB: Creating ROI chart");const n=e.getContext("2d");if(!n){if(console.error("RTBCB: Failed to get canvas context for ROI chart."),e.parentNode){const t=window.wp?.i18n?.__("Chart rendering failed","rtbcb")||"Chart rendering failed",n=document.createElement("p");n.textContent=t,n.classList.add("rtbcb-chart-error"),e.parentNode.insertBefore(n,e),e.remove()}return}const r={labels:["Labor Savings","Fee Savings","Error Reduction","Total Benefit"],datasets:[]},s={conservative:{bg:"rgba(239, 68, 68, 0.8)",border:"rgba(239, 68, 68, 1)"},base:{bg:"rgba(59, 130, 246, 0.8)",border:"rgba(59, 130, 246, 1)"},optimistic:{bg:"rgba(16, 185, 129, 0.8)",border:"rgba(16, 185, 129, 1)"}};Object.keys(t).forEach(e=>{const n=t[e],i=s[e]||s.base;r.datasets.push({label:this.formatScenarioLabel(e),data:[n.labor_savings||0,n.fee_savings||0,n.error_reduction||0,n.total_annual_benefit||0],backgroundColor:i.bg,borderColor:i.border,borderWidth:1})}),new Chart(n,{type:"bar",data:r,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(new Intl.NumberFormat).format(e)}}}},plugins:{tooltip:{callbacks:{label:function(e){return e.dataset.label+": $"+(new Intl.NumberFormat).format(e.raw)}}},legend:{display:!0,position:"top"}}}}),console.log("RTBCB: ROI chart created")}formatScenarioLabel(e){switch(e){case"conservative":return"Conservative";case"base":return"Base Case";case"optimistic":return"Optimistic";default:return e.charAt(0).toUpperCase()+e.slice(1)}}initializeCollapsibleSections(e){e.querySelectorAll(".rtbcb-section-toggle").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-target"),t=document.getElementById(e),n=this.querySelector(".rtbcb-toggle-arrow"),r=this.querySelector(".rtbcb-toggle-text");if(t){const e="none"===t.style.display;t.style.display=e?"block":"none",n&&(n.textContent=e?"▲":"▼"),r&&(r.textContent=e?"Collapse":"Expand")}})})}initializeInteractiveMetrics(e){e.querySelectorAll(".rtbcb-metric-card").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("expanded")})})}initializeExportFunctions(e){e.querySelectorAll('[onclick*="print"], .rtbcb-print-btn').forEach(e=>{e.onclick=null,e.addEventListener("click",()=>{window.print()})});e.querySelectorAll(".rtbcb-export-pdf, .rtbcb-pdf-btn").forEach(e=>{e.addEventListener("click",()=>{window.print()})})}showEnhancedError(e,t=null){this.hideLoading();const n=document.getElementById("rtbcb-progress-container");n&&(n.innerHTML=`\n                <div class="rtbcb-enhanced-error" style="padding: 40px; text-align: center; max-width: 600px;">\n                    <div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">\n                        ⚠️\n                    </div>\n                    <h3 style="color: #ef4444; margin-bottom: 16px; font-size: 24px;">\n                        Unable to Generate Dashboard Report\n                    </h3>\n                    <p style="color: #4b5563; margin-bottom: 24px; font-size: 16px; line-height: 1.5;">\n                        ${this.escapeHTML(e)}\n                    </p>\n                    ${t?`\n                    <details style="margin-bottom: 24px; text-align: left;">\n                        <summary style="cursor: pointer; color: #7c3aed; font-weight: 600;">\n                            Technical Details\n                        </summary>\n                        <pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; font-size: 14px; margin-top: 8px; overflow-x: auto;">\n                            ${this.escapeHTML(JSON.stringify(t,null,2))}\n                        </pre>\n                    </details>\n                    `:""}\n                    <div class="rtbcb-error-actions" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">\n                        <button type="button" onclick="location.reload()" \n                                style="background: #7216f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">\n                            Try Again\n                        </button>\n                        <a href="mailto:contact@realtreasury.com" \n                           style="background: #f3f4f6; color: #4b5563; border: none; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">\n                            Contact Support\n                        </a>\n                    </div>\n                </div>\n            `,n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center")}showResults(e){console.log("RTBCB: Processing structured data results"),this.hideLoading();const t={companyName:e.company_name||e.metadata?.company_name||"Your Company",scenarios:e.scenarios||e.financial_analysis?.roi_scenarios||{},recommendation:{category_info:e.recommendation?.category_info||e.technology_strategy?.category_details||{},confidence:e.recommendation?.confidence||e.metadata?.confidence_level||.75,reasoning:e.recommendation?.reasoning||e.technology_strategy?.recommended_category||""},narrative:{narrative:e.narrative?.narrative||e.executive_summary?.executive_recommendation||"",next_actions:e.narrative?.next_actions||[...e.action_plan?.immediate_steps||[],...e.action_plan?.short_term_milestones||[],...e.action_plan?.long_term_objectives||[]]},risks:e.risks||e.risk_analysis?.implementation_risks||[]};window.closeBusinessCaseModal();const n=document.getElementById("rtbcbResults");n?(n.innerHTML=this.renderResults(t),this.populateRiskAssessment(t.risks),n.style.display="block",n.scrollIntoView({behavior:"smooth",block:"start"})):(console.error("RTBCB: Results container not found"),this.showEnhancedError("Unable to display results. Please refresh the page."))}renderResults(e){const{scenarios:t,recommendation:n,companyName:r,narrative:s}=e,i=r||"Your Company";return`\n            <div class="rtbcb-results-container">\n                <div class="rtbcb-results-header">\n                    <div class="rtbcb-results-badge">\n                        <span class="rtbcb-badge-icon">✓</span>\n                        Business Case Generated Successfully\n                    </div>\n                    <h2>${i} Treasury Technology Business Case</h2>\n                    <p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n                </div>\n\n                ${this.renderRecommendation(n,i)}\n                ${this.renderROISummary(t,i)}\n                ${this.renderNarrative(s)}\n                ${this.renderRiskAssessmentSection()}\n                ${this.renderNextSteps(s?.next_actions||[],i)}\n                ${this.renderActions()}\n            </div>\n        `}renderRecommendation(e,t){const n=e.category_info||{};return`\n            <div class="rtbcb-recommendation-card">\n                <div class="rtbcb-recommendation-header">\n                    <h3>Recommended Solution for ${t}</h3>\n                    <span class="rtbcb-confidence-badge">${Math.round(100*(e.confidence||.75))}% Confidence</span>\n                </div>\n                <div class="rtbcb-recommendation-name">${n.name||"Treasury Management System"}</div>\n                <div class="rtbcb-recommendation-description">\n                    ${n.description||"Modern treasury platform with automation and analytics"}\n                </div>\n                <div class="rtbcb-recommendation-reasoning">\n                    ${e.reasoning||`Based on ${t}'s profile, this solution best fits your needs.`}\n                </div>\n            </div>\n        `}renderROISummary(e,t){return`\n            <div class="rtbcb-roi-section">\n                <h3>${t} Projected Annual Benefits</h3>\n                <div class="rtbcb-roi-summary">\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Conservative</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.low?.total_annual_benefit||e.conservative?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">80% probability</div>\n                    </div>\n                    <div class="rtbcb-scenario rtbcb-scenario-base">\n                        <div class="rtbcb-scenario-label">Base Case</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.base?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Most likely outcome</div>\n                    </div>\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Optimistic</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.high?.total_annual_benefit||e.optimistic?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Best case scenario</div>\n                    </div>\n                </div>\n                ${this.renderBenefitBreakdown(e.base)}\n            </div>\n        `}renderBenefitBreakdown(e){if(!e)return"";const t=[{label:"Labor Savings",amount:e.labor_savings||0},{label:"Fee Reduction",amount:e.fee_savings||0},{label:"Error Prevention",amount:e.error_reduction||0}],n=e.total_annual_benefit||0;return`\n            <div class="rtbcb-benefit-breakdown">\n                <h4>Benefit Breakdown</h4>\n                <div class="rtbcb-chart-fallback">\n                    <div class="rtbcb-benefit-bars">\n                        ${t.map(e=>{const t=n>0?(e.amount/n*100).toFixed(0):0;return`\n                                <div class="rtbcb-benefit-bar">\n                                    <div class="rtbcb-benefit-bar-label">${e.label}</div>\n                                    <div class="rtbcb-benefit-bar-fill" style="width: ${t}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n                                        $${this.formatNumber(e.amount)}\n                                    </div>\n                                </div>\n                            `}).join("")}\n                    </div>\n                </div>\n            </div>\n        `}renderNarrative(e={}){return`\n            <div class="rtbcb-narrative-section">\n                <h3>Executive Summary</h3>\n                <div class="rtbcb-narrative-content">\n                    ${e?.narrative||"Treasury technology investment presents a compelling opportunity for operational efficiency."}\n                </div>\n            </div>\n        `}renderRiskAssessmentSection(){return'\n            <div class="rtbcb-risk-assessment">\n                <h3>Risk Assessment</h3>\n                <ul class="rtbcb-risk-list"></ul>\n            </div>\n        '}populateRiskAssessment(e){const t=document.querySelector(".rtbcb-risk-list");t&&(t.innerHTML="",(e||[]).forEach(e=>{const n=document.createElement("li");if(e&&"object"==typeof e){const t=Object.values(e).filter(Boolean);n.textContent=t.join(" - ")}else null!=e&&(n.textContent=String(e));t.appendChild(n)}))}renderNextSteps(e){return e&&0!==e.length||(e=["Present business case to stakeholders","Evaluate solution providers","Develop implementation timeline","Plan change management strategy"]),`\n            <div class="rtbcb-next-steps">\n                <h3>Recommended Next Steps</h3>\n                <div class="rtbcb-steps-grid">\n                    ${e.map((e,t)=>`\n                        <div class="rtbcb-step">\n                            <div class="rtbcb-step-number">${t+1}</div>\n                            <div class="rtbcb-step-content">\n                                <p>${e}</p>\n                            </div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}renderActions(){return'\n            <div class="rtbcb-actions-section">\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.print()">\n                    <span class="rtbcb-btn-icon">🖨️</span>\n                    Print Results\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n                    <span class="rtbcb-btn-icon">📋</span>\n                    Copy HTML\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n                    <span class="rtbcb-btn-icon">🔄</span>\n                    Start Over\n                </button>\n            </div>\n        '}copyResultsHTML(){const e=document.querySelector(".rtbcb-results-container");e&&navigator.clipboard&&navigator.clipboard.writeText(e.innerHTML).then(()=>alert("Results HTML copied to clipboard")).catch(e=>console.error("Copy failed:",e))}handleError(e){const t=e.message||"An unexpected error occurred";console.group("RTBCB Error Details"),console.error("Message:",t),console.error("Type:",e.type),console.error("Debug Info:",e.debug_info),console.error("Timestamp:",e.timestamp),console.groupEnd(),this.showEnhancedError(this.getUserFriendlyMessage(t),e)}getUserFriendlyMessage(e){const t={"Security check failed":"Session expired. Please refresh the page and try again.","OpenAI API key not configured":"Service temporarily unavailable. Please try again later.","API connection failed":"Unable to connect to analysis service. Please try again.","Missing required field":"Please fill in all required fields.","Invalid email address":"Please enter a valid email address.","PHP error occurred":"Server error encountered. Please try again.","Server returned invalid JSON response":"Server communication error. Please try again.","Unexpected server response":"Server communication error. Please try again."};for(const[n,r]of Object.entries(t))if(e.includes(n))return r;return"An error occurred while processing your request. Please try again."}escapeHTML(e){const t=document.createElement("div");return t.textContent=null==e?"":String(e),t.innerHTML}formatNumber(e){return new Intl.NumberFormat("en-US").format(Math.round(e))}reinitialize(){this.currentStep=1,this.updateStepVisibility(),this.updateProgressIndicator()}}