if(console.log("RTBCB: Wizard initializing"),"object"==typeof module&&module.exports&&"function"==typeof require)try{require("./chartjs-adapter-date-fns.bundle.min.js")}catch(t){}const __="undefined"!=typeof wp&&wp.i18n&&wp.i18n.__?wp.i18n.__:t=>t;let validateEmail,validatePainPoints,validateRequired;const req="function"==typeof require?require:"undefined"!=typeof globalThis&&globalThis.process&&globalThis.process.mainModule&&"function"==typeof globalThis.process.mainModule.require?globalThis.process.mainModule.require:null;function isValidUrl(t){if(!t)return!1;try{const e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch(t){return!1}}async function rtbcbRefreshNonce(){if("undefined"==typeof rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return!1;try{const t=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_get_nonce`);if(!t.ok)return!1;const e=await t.json();if(e&&e.success)return rtbcb_ajax.nonce=e.data||e.nonce||e,!0}catch(t){console.error("RTBCB: Nonce refresh failed",t)}return!1}req?({validateEmail:validateEmail,validatePainPoints:validatePainPoints,validateRequired:validateRequired}=req("./src/utils/formValidators.js")):"undefined"!=typeof window&&window.RTBCBValidators&&({validateEmail:validateEmail,validatePainPoints:validatePainPoints,validateRequired:validateRequired}=window.RTBCBValidators),"undefined"==typeof rtbcb_ajax||isValidUrl(rtbcb_ajax.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcb_ajax.ajax_url=ajaxurl),window.openBusinessCaseModal=function(){const t=document.getElementById("rtbcbModalOverlay");t&&(t.classList.add("active"),document.body.style.overflow="hidden",window.businessCaseBuilder?window.businessCaseBuilder.reinitialize():window.businessCaseBuilder=new BusinessCaseBuilder)},window.closeBusinessCaseModal=function(){const t=document.getElementById("rtbcbModalOverlay");t&&t.classList&&t.classList.remove&&t.classList.remove("active"),document.body&&document.body.style&&(document.body.style.overflow=""),window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.cancelPolling&&window.businessCaseBuilder.cancelPolling()};const initBusinessCaseBuilder=()=>{try{if(window.businessCaseBuilder)return!0;if(document.getElementById("rtbcbForm"))return window.businessCaseBuilder=new BusinessCaseBuilder,!0}catch(t){console.error("BusinessCaseBuilder initialization failed:",t)}return!1},setupBusinessCaseBuilder=()=>{if(initBusinessCaseBuilder())return;if("undefined"!=typeof MutationObserver){const t=new MutationObserver(()=>{initBusinessCaseBuilder()&&t.disconnect()});t.observe(document.body,{childList:!0,subtree:!0})}if("undefined"!=typeof TEST_ENV&&TEST_ENV&&!document.getElementById("rtbcbForm"))return;const t=Date.now(),e=setInterval(()=>{(initBusinessCaseBuilder()||Date.now()-t>1e4)&&clearInterval(e)},500)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",setupBusinessCaseBuilder):setupBusinessCaseBuilder();class BusinessCaseBuilder{constructor(){this.currentStep=1,this.totalSteps=0,this.form=document.getElementById("rtbcbForm"),this.overlay=document.getElementById("rtbcbModalOverlay"),this.ajaxUrl="undefined"!=typeof rtbcb_ajax&&isValidUrl(rtbcb_ajax.ajax_url)?rtbcb_ajax.ajax_url:"",this.pollTimeout=null,this.pollingCancelled=!1,this.activeJobId=null,this.progressStates=[],this.currentProgressIndex=0,this.progressTimer=null,this.reportType="",this.lastValidationErrors=[],console.log("RTBCB: BusinessCaseBuilder constructor called"),console.log("RTBCB: Form found:",!!this.form),console.log("RTBCB: Overlay found:",!!this.overlay),this.form?(this.handleNext=this.handleNext.bind(this),this.handlePrev=this.handlePrev.bind(this),this.handleSubmit=this.handleSubmit.bind(this),console.log("RTBCB: Event handlers bound"),this.init()):console.error("RTBCB: Form with ID rtbcbForm not found")}init(){this.cacheElements(),this.bindEvents(),this.restorePersistentState(),this.initializePath()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next"),this.prevBtn=this.form.querySelector(".rtbcb-nav-prev"),this.submitBtn=this.form.querySelector(".rtbcb-nav-submit"),console.log("RTBCB: Cached elements - nextBtn:",!!this.nextBtn,"prevBtn:",!!this.prevBtn,"submitBtn:",!!this.submitBtn),this.steps=this.form.querySelectorAll(".rtbcb-wizard-step"),this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step"),this.progressLine=this.form.querySelector(".rtbcb-progress-line"),console.log("RTBCB: Found",this.steps.length,"wizard steps and",this.progressSteps.length,"progress steps"),this.basicStepFields={1:["report_type"],2:["company_name"],3:["pain_points"],4:["email","consent"]},this.getStepFields=this.getEnhancedFields.bind(this)}bindEvents(){if(console.log("RTBCB: bindEvents executed"),this.nextBtn)console.log("RTBCB: Binding next button click handler"),this.nextBtn.addEventListener("click",this.handleNext);else if(("undefined"==typeof TEST_ENV||!TEST_ENV)&&(console.warn("RTBCB: Next button not found"),"undefined"!=typeof MutationObserver)){const t=new MutationObserver(()=>{this.nextBtn=this.form.querySelector(".rtbcb-nav-next"),this.nextBtn&&(console.log("RTBCB: Dynamically found next button, binding handler"),this.nextBtn.addEventListener("click",this.handleNext),t.disconnect())});t.observe(this.form,{childList:!0,subtree:!0})}this.prevBtn&&this.prevBtn.addEventListener("click",this.handlePrev),this.form.addEventListener("submit",this.handleSubmit),this.form.addEventListener("change",t=>{const e=t.target;if(e.matches('input[name="pain_points[]"]')){const t=e.closest(".rtbcb-pain-point-card");t&&t.classList.toggle("rtbcb-selected",e.checked);if(this.form.querySelectorAll('input[name="pain_points[]"]:checked').length>0){const t=e.closest(".rtbcb-wizard-step"),s=Array.from(this.steps).indexOf(t)+1;this.clearStepError(s)}}}),this.form.querySelectorAll(".rtbcb-report-type-card").forEach(t=>{t.addEventListener("click",()=>{const e=t.querySelector('input[name="report_type"]');e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})))})}),this.form.querySelectorAll('input[name="report_type"]').forEach(t=>{t.addEventListener("change",()=>{t.checked&&(this.form.querySelectorAll(".rtbcb-report-type-card").forEach(e=>{e.classList.toggle("rtbcb-selected",e.contains(t))}),console.log("RTBCB: Report type changed to:",t.value),this.initializePath())})}),this.form.querySelectorAll("input, select").forEach(t=>{t.addEventListener("blur",()=>this.validateField(t)),t.addEventListener("input",()=>this.clearFieldError(t))}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.overlay.classList.contains("active")&&window.closeBusinessCaseModal()})}initializePath(){this.currentStep=1;const t=this.form.querySelector('input[name="report_type"]:checked');if(this.reportType=t?t.value:"basic",console.log("RTBCB: Initializing path for report type:",this.reportType),"enhanced"===this.reportType){this.form.querySelectorAll(".rtbcb-enhanced-only input, .rtbcb-enhanced-only select").forEach(t=>{t.disabled=!1,t.closest(".rtbcb-field-required")&&t.setAttribute("required","required")}),this.form.querySelectorAll(".rtbcb-enhanced-only").forEach(t=>{t.style.display="block"}),this.steps=[this.form.querySelector('.rtbcb-wizard-step[data-step="1"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="2"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="3"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="4"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="5"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="6"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="7"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="8"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="9"]')],this.getStepFields=this.getEnhancedFields.bind(this);const t=this.steps.filter(Boolean).length;this.progressSteps=Array.from(this.form.querySelectorAll(".rtbcb-progress-step")).filter(Boolean).slice(0,t),this.progressSteps.forEach((t,e)=>{if(t){t.style.display="flex",t.dataset.step=e+1;const s=t.querySelector(".rtbcb-progress-number");s&&(s.textContent=e+1)}}),this.totalSteps=t}else{this.form.querySelectorAll(".rtbcb-enhanced-only input, .rtbcb-enhanced-only select").forEach(t=>{t.disabled=!0,t.removeAttribute("required")}),this.form.querySelectorAll(".rtbcb-enhanced-only").forEach(t=>{t.style.display="none"});const t=this.form.querySelector('.rtbcb-wizard-step[data-step="9"]'),e=t?t.querySelector('input[name="email"]'):null;e&&e.setAttribute("required","required"),this.steps=[this.form.querySelector('.rtbcb-wizard-step[data-step="1"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="2"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="7"]'),t],this.getStepFields=t=>this.basicStepFields[t]||[];const s=this.steps.filter(Boolean).length;this.progressSteps=[this.form.querySelector('.rtbcb-progress-step[data-step="1"]'),this.form.querySelector('.rtbcb-progress-step[data-step="2"]'),this.form.querySelector('.rtbcb-progress-step[data-step="7"]'),this.form.querySelector('.rtbcb-progress-step[data-step="9"]')].filter(Boolean).slice(0,s),this.form.querySelectorAll(".rtbcb-progress-step").forEach(t=>{t&&(t.style.display="none")}),this.progressSteps.forEach((t,e)=>{t.style.display="flex",t.dataset.step=e+1;const s=t.querySelector(".rtbcb-progress-number");s&&(s.textContent=e+1)}),this.totalSteps=s}console.log("RTBCB: Path initialized. Total steps:",this.totalSteps,"Current step fields:",this.getStepFields(this.currentStep)),this.currentStep=Math.min(this.currentStep,this.totalSteps),this.updateStepVisibility(),this.updateProgressIndicator()}saveFormData(t){try{const e=window.sessionStorage;if(!e)return;const s={};for(const[e,r]of t.entries())s[e]?Array.isArray(s[e])?s[e].push(r):s[e]=[s[e],r]:s[e]=r;e.setItem("rtbcbFormData",JSON.stringify(s))}catch(t){"undefined"!=typeof TEST_ENV&&TEST_ENV||console.warn("RTBCB: Session storage unavailable",t)}}restorePersistentState(){try{const t=window.sessionStorage,e=window.localStorage;if(!t&&!e)return;const s=t&&t.getItem("rtbcbFinalReport")||e&&e.getItem("rtbcbFinalReport");if(s)return void this.showEnhancedHTMLReport(s);const r=t?t.getItem("rtbcbFormData"):null;if(r)try{const t=JSON.parse(r),e=this.form.querySelector('input[name="report_type"]:checked'),s=e?e.value:"basic";this.populateForm(t);const n=this.form.querySelector('input[name="report_type"]:checked');(n?n.value:s)!==s&&this.initializePath()}catch(t){}const n=t.getItem("rtbcbJobId");n&&(this.overlay&&(this.overlay.classList.add("active"),document.body.style.overflow="hidden"),this.activeJobId=n,this.showLoading(),this.startProgressiveLoading(),this.pollingCancelled=!1,this.pollJob(n,Date.now(),0))}catch(t){"undefined"!=typeof TEST_ENV&&TEST_ENV||console.warn("RTBCB: Session storage unavailable",t)}}populateForm(t){Object.entries(t).forEach(([t,e])=>{if(Array.isArray(e))e.forEach(e=>{const s=this.form.querySelector(`[name="${t}"][value="${e}"]`);s&&(s.checked=!0)});else{const s=this.form.querySelector(`[name="${t}"]`);if(!s)return;if("checkbox"===s.type)s.checked=!0;else if("radio"===s.type){const s=this.form.querySelector(`[name="${t}"][value="${e}"]`);s&&(s.checked=!0,s.dispatchEvent(new Event("change",{bubbles:!0})))}else s.value=e}})}clearPersistentState(){try{const t=window.sessionStorage;t&&(t.removeItem("rtbcbFormData"),t.removeItem("rtbcbJobId"))}catch(t){}}saveFinalReport(t){try{const e=window.sessionStorage;e&&e.setItem("rtbcbFinalReport",t)}catch(t){"undefined"!=typeof TEST_ENV&&TEST_ENV||console.warn("RTBCB: Session storage unavailable",t)}try{const e=window.localStorage;e&&e.setItem("rtbcbFinalReport",t)}catch(t){"undefined"!=typeof TEST_ENV&&TEST_ENV||console.warn("RTBCB: Local storage unavailable",t)}}handleNext(t){t&&t.preventDefault&&t.preventDefault(),console.log("RTBCB: handleNext called for step",this.currentStep),console.log("RTBCB: About to validate step",this.currentStep);if(this.validateStep(this.currentStep))console.log("RTBCB: Step validation passed"),this.currentStep<this.totalSteps?(this.currentStep++,console.log("RTBCB: Moving to step",this.currentStep),this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop()):console.log("RTBCB: Already at last step");else{console.log("RTBCB: Step validation failed");const t=this.lastValidationErrors||[];let e;e=t.length?__("Please review the following fields: ","rtbcb")+t.join(", "):__("Please correct the highlighted fields.","rtbcb"),alert(e)}}handlePrev(t){t&&t.preventDefault&&t.preventDefault(),this.currentStep>1&&(this.currentStep--,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}getEnhancedFields(t){const e=this.form.querySelector(`.rtbcb-wizard-step[data-step="${t}"]`);if(!e)return[];const s=[...new Set(Array.from(e.querySelectorAll("[name][required]")).map(t=>t.name))];if(2===t){const t=e.querySelector('[name="job_title"]');if(t){t.removeAttribute("required");const e=s.indexOf("job_title");-1!==e&&s.splice(e,1)}}return e.querySelector('input[name="pain_points[]"]')&&!s.includes("pain_points")&&s.push("pain_points"),s}validateStep(t){const e=this.getStepFields(t)||[];let s=!0;if(this.lastValidationErrors=[],e.includes("pain_points")){const e=Array.from(this.form.querySelectorAll('input[name="pain_points[]"]:checked')).map(t=>t.value);if(!validatePainPoints(e)){const e=__("Please select at least one pain point","rtbcb");return this.showStepError(t,e),this.lastValidationErrors.push(e),!1}this.clearStepError(t)}for(const t of e){const e=this.form.querySelector(`[name="${t}"]`);if(e&&(("basic"!==this.reportType||!e.closest(".rtbcb-enhanced-only"))&&("enhanced"!==this.reportType||!e.closest(".rtbcb-enhanced-only")||e.hasAttribute("required"))&&!this.validateField(e,!0))){s=!1;const r=e.closest(".rtbcb-field"),n=r?r.querySelector("label"):null,i=n?n.textContent.trim():t;this.lastValidationErrors.push(i)}}return s}validateField(t,e=!1){const s=t.value.trim();let r=!0,n="";if("radio"===t.type){const e=this.form.querySelectorAll(`input[name="${t.name}"]`);return Array.from(e).some(t=>t.checked)?(e.forEach(t=>t.classList.remove("rtbcb-field-invalid")),this.clearFieldError(t),!0):(n=__("This field is required","rtbcb"),e.forEach(t=>t.classList.add("rtbcb-field-invalid")),this.showFieldError(t,n),!1)}if(e||t.hasAttribute("required"))if("checkbox"===t.type){const e=Array.from(this.form.querySelectorAll(`[name="${t.name}"]:checked`)).map(t=>t.value);validateRequired(e)||(n=__("This field is required","rtbcb"),r=!1)}else validateRequired(s)||(n=__("This field is required","rtbcb"),r=!1);return"company_name"===t.name&&s&&(s.length<2?(n=__("Company name must be at least 2 characters","rtbcb"),r=!1):s.length>100?(n=__("Company name must be less than 100 characters","rtbcb"),r=!1):/^[^a-zA-Z]*$/.test(s)&&(n=__("Please enter a valid company name","rtbcb"),r=!1)),"email"===t.type&&s&&(validateEmail(s)||(n=__("Please enter a valid email address","rtbcb"),r=!1)),"number"===t.type&&s&&(Number.isFinite(Number(s))||(n=__("Please enter a valid number","rtbcb"),r=!1)),r?this.clearFieldError(t):this.showFieldError(t,n),r}showFieldError(t,e){const s=t.closest(".rtbcb-field");if(!s)return;this.clearFieldError(t),t.classList.add("rtbcb-field-invalid");const r=document.createElement("div");r.className="rtbcb-field-error",r.textContent=e,s.appendChild(r)}clearFieldError(t){const e=t.closest(".rtbcb-field");if(!e)return;t.classList.remove("rtbcb-field-invalid");const s=e.querySelector(".rtbcb-field-error");s&&s.remove()}showStepError(t,e){const s=this.steps[t-1];if(!s)return;const r=s.querySelector(".rtbcb-pain-points-validation");if(r){const t=r.querySelector(".rtbcb-validation-message");t&&(t.textContent=e,t.style.display="block",t.style.color="#ef4444")}}clearStepError(t){const e=this.steps[t-1];if(!e)return;const s=e.querySelector(".rtbcb-pain-points-validation");if(s){const t=s.querySelector(".rtbcb-validation-message");t&&(t.style.display="none")}}updateStepVisibility(){if(this.steps.forEach((t,e)=>{if(!t)return;e+1===this.currentStep?(t.classList.add("active"),t.style.display="block"):(t.classList.remove("active"),t.style.display="none")}),this.prevBtn&&(this.prevBtn.style.display=1===this.currentStep?"none":"inline-flex"),this.currentStep===this.totalSteps?this.nextBtn&&(this.nextBtn.style.display="none"):this.nextBtn&&(this.nextBtn.style.display="inline-flex"),this.submitBtn){this.currentStep===this.totalSteps?(this.submitBtn.style.display="inline-flex",this.submitBtn.disabled=!1):(this.submitBtn.style.display="none",this.submitBtn.disabled=!0)}}updateProgressIndicator(){const t=Math.min(this.currentStep,this.progressSteps.length);if(this.progressSteps.forEach((e,s)=>{if(!e)return;const r=s+1;r<t?(e.classList.add("completed"),e.classList.remove("active")):r===t?(e.classList.add("active"),e.classList.remove("completed")):e.classList.remove("active","completed")}),this.progressLine){const t=this.currentStep/this.totalSteps*100;this.progressLine.style.width=`${t}%`}}scrollToTop(){const t=this.form.closest(".rtbcb-modal-body");t&&(t.scrollTop=0)}initializeProgressStates(){this.progressStates=[{step:"initializing",message:__("Initializing analysis...","rtbcb"),duration:2e3},{step:"collecting_data",message:__("Collecting your data...","rtbcb"),duration:3e3},{step:"calculating_roi",message:__("Calculating ROI scenarios...","rtbcb"),duration:8e3},{step:"analyzing_company",message:__("Analyzing company profile...","rtbcb"),duration:6e3},{step:"market_research",message:__("Researching market insights...","rtbcb"),duration:5e3},{step:"generating_recommendations",message:__("Generating recommendations...","rtbcb"),duration:1e4},{step:"finalizing",message:__("Finalizing your report...","rtbcb"),duration:5e3}],this.currentProgressIndex=0,this.progressTimer=null}startProgressiveLoading(){this.initializeProgressStates(),this.currentProgressIndex=0,this.showProgressState(this.progressStates[0]),this.scheduleNextProgressState()}showProgressState(t){const e=document.getElementById("rtbcb-progress-status");e&&(e.style.transition="opacity 0.3s ease",e.style.opacity="0.5",setTimeout(()=>{e.textContent=t.message,e.style.opacity="1",e.style.transform="scale(1.02)",setTimeout(()=>{e.style.transform="scale(1)"},200)},300),console.log(`RTBCB: Progress state: ${t.step} - ${t.message}`))}scheduleNextProgressState(){if(this.pollingCancelled)return;const t=this.progressStates[this.currentProgressIndex];t&&(this.progressTimer=setTimeout(()=>{if(this.currentProgressIndex++,this.currentProgressIndex<this.progressStates.length&&!this.pollingCancelled){const t=this.progressStates[this.currentProgressIndex];this.showProgressState(t),this.scheduleNextProgressState()}else this.pollingCancelled||(this.currentProgressIndex=Math.max(0,this.progressStates.length-3),this.scheduleNextProgressState())},t.duration))}cancelProgressiveLoading(){this.progressTimer&&(clearTimeout(this.progressTimer),this.progressTimer=null),this.currentProgressIndex=0}async handleSubmit(t){if(t&&t.preventDefault&&t.preventDefault(),this.validateStep(this.currentStep))if(isValidUrl(this.ajaxUrl))try{console.log("RTBCB: Starting form submission"),this.showLoading(),this.startProgressiveLoading();const t=this.collectFormData();if(this.saveFormData(t),this.validateFormData(t),!isValidUrl(this.ajaxUrl))return void this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"));let e,s,r,n=0;for(;n<2;){if(e=await fetch(this.ajaxUrl,{method:"POST",body:t,credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html"}}),s=await e.text(),403===e.status&&0===n){if(await rtbcbRefreshNonce()){"function"==typeof t.set?t.set("rtbcb_nonce",rtbcb_ajax.nonce):t.append("rtbcb_nonce",rtbcb_ajax.nonce),n++;continue}return this.cancelProgressiveLoading(),void this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"})}break}if(console.log("RTBCB: Response status:",e.status),!e.ok){let t=__("An error occurred while processing your request. Please try again.","rtbcb"),e=null;try{e=JSON.parse(s),e&&e.data&&e.data.message?t=e.data.message:e&&e.message&&(t=e.message)}catch(t){}return this.cancelProgressiveLoading(),void(e&&"object"==typeof e?(e.message=t,e.raw_message=!0,this.handleError(e)):this.handleError({message:t,raw_message:!0}))}console.log("RTBCB: Response received, length:",s.length),console.log("RTBCB: Response received, length:",s.length);try{if(r=JSON.parse(s),console.log("RTBCB: Parsed JSON response:",r),"string"==typeof r)try{console.log("RTBCB: Response is a string, attempting second parse"),r=JSON.parse(r),console.log("RTBCB: Parsed stringified JSON response:",r)}catch(t){console.log("RTBCB: Failed to parse stringified JSON, attempting to clean");const e=r.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");r=JSON.parse(e),console.log("RTBCB: Parsed cleaned stringified JSON response:",r)}}catch(t){console.log("RTBCB: JSON parse failed, attempting to clean response");try{const t=s.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");r=JSON.parse(t),console.log("RTBCB: Parsed cleaned JSON response:",r)}catch(t){if(console.log("RTBCB: Response is not JSON, treating as HTML"),s.includes('<div class="rtbcb-enhanced-report"')||s.includes('<div class="rtbcb-report"'))return this.cancelProgressiveLoading(),void this.showEnhancedHTMLReport(s);throw new Error(__("Invalid response format","rtbcb"))}}if(r.success){const t=r.data||r;if(t.job_id){this.cancelPolling(),this.pollingCancelled=!1,this.activeJobId=t.job_id;try{window.sessionStorage&&window.sessionStorage.setItem("rtbcbJobId",t.job_id)}catch(t){}this.cancelProgressiveLoading(),this.pollJob(this.activeJobId,Date.now(),0)}else this.cancelProgressiveLoading(),t.report_html?this.handleSuccess(t):t.report_data?this.handleSuccess(t.report_data):this.handleSuccess(t)}else{const t=r.data||r;console.error("RTBCB: Error response:",t),this.cancelProgressiveLoading(),this.handleError(t||{message:__("Unknown error occurred","rtbcb")})}}catch(t){console.error("RTBCB: Submission error:",t),this.cancelProgressiveLoading(),this.handleError({message:t.message||__("An unexpected error occurred","rtbcb"),type:"submission_error"})}else this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"))}collectFormData(){const t=new FormData(this.form),e=new FormData,s=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],r=["report_type"];for(const[n,i]of t.entries())if(!r.includes(n)&&("job_title"!==n||i))if(s.includes(n)){const t=parseFloat(i);e.append(n,Number.isFinite(t)?t:"")}else e.append(n,i);e.append("action","rtbcb_generate_case"),"undefined"!=typeof rtbcb_ajax&&rtbcb_ajax.nonce&&e.append("rtbcb_nonce",rtbcb_ajax.nonce);const n=this.form.querySelector('input[name="report_type"]:checked'),i=n?n.value:"basic";return e.append("report_type",i),e.append("fast_mode","fast"===i?"1":"0"),e}validateFormData(t){const e=e=>{if("function"==typeof t.get)return t.get(e);for(const[s,r]of t.entries())if(s===e)return r;return null},s=e=>{if("function"==typeof t.getAll){const s=t.getAll(e);return Array.isArray(s)?s:[]}const s=[];for(const[r,n]of t.entries())r===e&&s.push(n);return s},r=new Set,n=new Set;for(let t=1;t<=this.totalSteps;t++){(this.getStepFields(t)||[]).forEach(t=>{const e=t.replace(/\[\]$/,"");r.add(e),(t.endsWith("[]")||"pain_points"===e)&&n.add(e)})}"basic"!==this.reportType&&["hours_reconciliation","hours_cash_positioning","num_banks","ftes"].forEach(t=>{this.form.querySelector(`[name="${t}"]`)&&r.add(t)});for(const t of r){if("pain_points"===t){const t=s("pain_points[]");if(!validatePainPoints(t.filter(t=>t)))throw new Error(__("Please select at least one pain point","rtbcb"));continue}if(this.form?this.form.querySelector(`[name="${t}"]`)||this.form.querySelector(`[name="${t}[]"]`):null){if(n.has(t)){const e=s(`${t}[]`).filter(t=>t);if(!validateRequired(e))throw new Error(`${__("Missing required field:","rtbcb")} ${t.replace("_"," ")}`);continue}if(!validateRequired(e(t)))throw new Error(`${__("Missing required field:","rtbcb")} ${t.replace("_"," ")}`)}}if(r.has("email")){const t=e("email");if(!validateEmail(t))throw new Error(__("Please enter a valid email address","rtbcb"))}if("basic"!==this.reportType){const t=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const s of t)if(r.has(s)){const t=parseFloat(e(s));if(isNaN(t)||t<=0)throw new Error(`${s.replace("_"," ")} ${__("must be a positive number","rtbcb")}`)}}}showLoading(){const t=document.querySelector(".rtbcb-modal-container");t&&(t.style.display="none");const e=document.getElementById("rtbcb-progress-container");if(e){const t=this.form.querySelector('[name="company_name"]')?.value||"your company",s=this.escapeHTML(t),r=!1!==window.rtbcb_ajax?.settings?.enable_ai_analysis?`Analyzing ${s}'s treasury operations...`:"Calculating ROI scenarios...",n=__("Cancel and Start Over","rtbcb");e.innerHTML=`\n\t\t\t\t<div class="rtbcb-progress-content">\n\t\t\t\t\t<div class="rtbcb-progress-spinner"></div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-text">\n\t\t\t\t\t\tGenerating Your Business Case\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-step">\n\t\t\t\t\t\t<span class="rtbcb-progress-step-text" id="rtbcb-progress-status">\n\t\t\t\t\t\t\t${r}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-partial">\n\t\t\t\t\t\t<div id="rtbcb-partial-basic-roi" style="display: none;"></div>\n\t\t\t\t\t\t<div id="rtbcb-partial-category" style="display: none;"></div>\n\t\t\t\t\t\t<div id="rtbcb-partial-analysis" style="display: none;"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type="button" class="rtbcb-progress-cancel">${n}</button>\n\t\t\t\t</div>\n\t\t\t`,e.style.display="flex",e.classList.add("active"),document.body.style.overflow="hidden",e.setAttribute("role","dialog"),e.setAttribute("aria-label","Generating business case report"),e.setAttribute("aria-live","polite");const i=e.querySelector(".rtbcb-progress-cancel");i&&i.addEventListener("click",()=>{this.cancelPolling(),this.hideLoading(),"function"==typeof this.reinitialize&&this.reinitialize()}),console.log("RTBCB: Progress overlay shown")}}hideLoading(){const t=document.getElementById("rtbcb-progress-container");t&&(t.style.display="none",t.classList.remove("active"),t.innerHTML="",t.removeAttribute("role"),t.removeAttribute("aria-label"),t.removeAttribute("aria-live")),document.body.style.overflow="";const e=document.querySelector(".rtbcb-modal-container");e&&(e.style.display="block");const s=this.form&&"function"==typeof this.form.closest?this.form.closest(".rtbcb-form-container"):null;s&&(s.style.display="block"),console.log("RTBCB: Progress overlay hidden")}cancelPolling(){this.pollingCancelled=!0,this.cancelProgressiveLoading(),this.pollTimeout&&(clearTimeout(this.pollTimeout),this.pollTimeout=null),this.clearPersistentState(),this.activeJobId=null,console.log("RTBCB: All polling and progress timers cancelled")}async pollJob(t,e=Date.now(),s=0){if(!this.pollingCancelled){if(Date.now()-e>12e5||s>600)return this.handleError({message:__("The request timed out after 20 minutes. Please try again later.","rtbcb"),type:"timeout"}),void this.cancelPolling();try{let r,n,i="undefined"!=typeof rtbcb_ajax&&rtbcb_ajax.nonce?rtbcb_ajax.nonce:"",o=0;for(;o<2;){if(r=await fetch(`${this.ajaxUrl}?action=rtbcb_job_status&job_id=${encodeURIComponent(t)}&rtbcb_nonce=${i}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}}),n=await r.text(),(403===r.status||n.includes("Security check failed"))&&0===o){if(await rtbcbRefreshNonce()){i=rtbcb_ajax.nonce,o++;continue}return this.cancelPolling(),this.hideLoading(),void this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"})}break}if(!r.ok)return this.cancelPolling(),void this.handleError({message:r.statusText,type:"polling_error"});const a=JSON.parse(n);if(!a.success)return this.handleError({message:__("Unable to retrieve job status","rtbcb"),type:"polling_error"}),void this.cancelPolling();const c=a.data||a,{status:l,step:d,message:b,percent:p}=c;console.log(`RTBCB: Job status: ${l} (attempt ${s})`),this.updateJobProgressStatus(c,s),this.updatePartialResults(c),"completed"===l?(this.cancelPolling(),this.showCompletionAnimation(()=>{this.hideLoading(),c.report_html?this.handleSuccess({report_html:c.report_html,report_data:c.report_data}):c.report_data?this.handleSuccess(c.report_data):this.handleError({message:__("Report data missing from completed job","rtbcb"),type:"job_error"})})):"error"===l?(this.cancelPolling(),this.hideLoading(),this.handleError({message:c.message||__("Job failed","rtbcb"),type:"job_error"})):"number"==typeof p&&p>=100?(this.cancelPolling(),this.showCompletionAnimation(()=>{this.hideLoading(),c.report_html?this.handleSuccess({report_html:c.report_html,report_data:c.report_data}):c.report_data?this.handleSuccess(c.report_data):this.handleError({message:"Report data missing from completed job",type:"job_error"})})):this.pollingCancelled||(this.pollTimeout=setTimeout(()=>this.pollJob(t,e,s+1),2e3))}catch(t){console.error("RTBCB: Job polling error:",t),this.cancelPolling(),this.handleError({message:t.message||"An unexpected error occurred",type:"polling_error"})}}}showCompletionAnimation(t){const e=document.getElementById("rtbcb-progress-status"),s=document.querySelector(".rtbcb-progress-spinner");e&&(e.textContent=__("Report completed successfully! ✓","rtbcb"),e.style.color="var(--success-green)",e.style.fontWeight="600"),s&&(s.style.borderTopColor="var(--success-green)",s.style.animation="rtbcb-spin 0.5s ease-out",setTimeout(()=>{s.style.display="none";const t=document.createElement("div");t.innerHTML="✓",t.style.cssText="\n\t\t\t\t\tfont-size: 60px;\n\t\t\t\t\tcolor: var(--success-green);\n\t\t\t\t\tanimation: rtbcb-bounce 0.6s ease-out;\n\t\t\t\t\tmargin: 0 auto 24px;\n\t\t\t\t\twidth: 60px;\n\t\t\t\t\theight: 60px;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t",s.parentNode.insertBefore(t,s)},500)),setTimeout(t,1500)}updateJobProgressStatus(t,e){const s=document.getElementById("rtbcb-progress-status");if(!s)return;const{status:r,step:n,message:i,percent:o}=t;let a="";if(n&&"processing"!==n)a=this.formatProgressStep(n);else if(i&&i.trim())a=this.formatProgressMessage(i);else{const t=s.textContent||__("Processing...","rtbcb");a=t}"number"==typeof o&&o>0&&o<100&&(a+=` (${Math.round(o)}%)`),a!==s.textContent&&(s.style.transition="opacity 0.2s ease",s.style.opacity="0.7",setTimeout(()=>{s.textContent=a,s.style.opacity="1"},200))}updatePartialResults(t){const e=document.getElementById("rtbcb-partial-basic-roi");if(t.basic_roi&&e){const s=t.basic_roi?.financial_analysis?.roi_scenarios?.base?.total_annual_benefit;"number"==typeof s&&s>0&&(e.innerHTML=`\n\t\t\t\t\t<strong>✓ ROI Analysis Complete</strong><br>\n\t\t\t\t\tProjected Annual Benefit: $${this.formatNumber(s)}\n\t\t\t\t`,e.style.display="block")}const s=document.getElementById("rtbcb-partial-category");t.category&&s&&(s.innerHTML=`\n\t\t\t\t<strong>✓ Solution Identified</strong><br>\n\t\t\t\tRecommended: ${this.escapeHTML(t.category)}\n\t\t\t`,s.style.display="block");const r=document.getElementById("rtbcb-partial-analysis");t.analysis_step&&r&&(r.innerHTML=`\n\t\t\t\t<strong>✓ AI Analysis</strong><br>\n\t\t\t\t${this.escapeHTML(t.analysis_step)}\n\t\t\t`,r.style.display="block")}formatProgressStep(t){return{roi_calculation:__("Calculating ROI scenarios...","rtbcb"),category_recommendation:__("Identifying optimal solution category...","rtbcb"),rag_search:__("Researching market insights...","rtbcb"),ai_analysis:__("Generating AI-powered analysis...","rtbcb"),report_generation:__("Assembling your business case report...","rtbcb"),finalizing:__("Finalizing recommendations...","rtbcb")}[t]||t.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())+"..."}formatProgressMessage(t){if(!t)return"";return t.replace(/\.+$/,"")+"..."}handleSuccess(t){this.clearPersistentState(),console.log("RTBCB: Success data received:",t),"string"!=typeof t?t.report_html&&t.report_html.trim()?this.showEnhancedHTMLReport(t.report_html):this.showResults(t):this.showEnhancedHTMLReport(t)}showEnhancedHTMLReport(t){console.log("RTBCB: Displaying enhanced HTML report"),this.hideLoading(),window.closeBusinessCaseModal();let e=document.getElementById("rtbcb-results-enhanced");if(e)console.log("RTBCB: Reusing existing results container");else{console.log("RTBCB: Creating results container"),e=document.createElement("div"),e.id="rtbcb-results-enhanced",e.className="rtbcb-enhanced-results-container";const t=document.getElementById("rtbcbModalOverlay");t&&t.parentNode?(t.parentNode.insertBefore(e,t.nextSibling),console.log("RTBCB: Results container inserted after modal")):(document.body.appendChild(e),console.log("RTBCB: Results container appended to body"))}console.log("RTBCB: Injecting report content"),e.innerHTML=t,e.style.display="block",this.saveFinalReport(t),this.initializeEnhancedReport(e),e.scrollIntoView({behavior:"smooth",block:"start"})}initializeEnhancedReport(t){this.initializeReportCharts(t),this.initializeCollapsibleSections(t),this.initializeInteractiveMetrics(t)}initializeReportCharts(t){if(window.rtbcb_ajax?.settings&&!1===window.rtbcb_ajax.settings.enable_charts)return void console.log("RTBCB: Charts disabled in settings");const e=t.querySelector("#rtbcb-roi-chart");if(e)if(console.log("RTBCB: Initializing ROI chart"),"undefined"!=typeof Chart)try{const s=this.extractROIDataFromReport(t);if(console.log("RTBCB: Extracted ROI data",s),!s||0===Object.keys(s).length)return void console.warn("RTBCB: ROI data is empty. Chart will not be rendered");this.createROIChart(e,s)}catch(t){console.error("Failed to initialize chart:",t)}else console.warn("RTBCB: Chart.js library is not available")}extractROIDataFromReport(t){const e={};return t.querySelectorAll(".rtbcb-scenario-card").forEach(t=>{const s=this.getScenarioNameFromCard(t);s&&(e[s]=this.extractMetricsFromCard(t))}),e}getScenarioNameFromCard(t){if(t.classList.contains("conservative"))return"conservative";if(t.classList.contains("base"))return"base";if(t.classList.contains("optimistic"))return"optimistic";const e=t.querySelector("h4");if(e){const t=e.textContent.toLowerCase();if(t.includes("conservative"))return"conservative";if(t.includes("base"))return"base";if(t.includes("optimistic"))return"optimistic"}return null}extractMetricsFromCard(t){const e={};return t.querySelectorAll(".rtbcb-scenario-metric").forEach(t=>{const s=t.querySelector(".rtbcb-metric-label"),r=t.querySelector(".rtbcb-metric-value");if(s&&r){const t=s.textContent.trim(),n=r.textContent.replace(/[$,]/g,"").trim(),i=parseFloat(n)||0;t.includes("Total Annual")?e.total_annual_benefit=i:t.includes("Labor")?e.labor_savings=i:t.includes("Fee")?e.fee_savings=i:t.includes("Error")&&(e.error_reduction=i)}}),e}createROIChart(t,e){console.log("RTBCB: Creating ROI chart");const s="function"==typeof Chart.getChart?Chart.getChart(t):null;s&&s.destroy();const r=t.getContext("2d");if(!r){if(console.error("RTBCB: Failed to get canvas context for ROI chart."),t.parentNode){const e=window.wp?.i18n?.__("Chart rendering failed","rtbcb")||"Chart rendering failed",s=document.createElement("p");s.textContent=e,s.classList.add("rtbcb-chart-error"),t.parentNode.insertBefore(s,t),t.remove()}return}const n={labels:["Labor Savings","Fee Savings","Error Reduction","Total Benefit"],datasets:[]},i={conservative:{bg:"rgba(239, 68, 68, 0.8)",border:"rgba(239, 68, 68, 1)"},base:{bg:"rgba(59, 130, 246, 0.8)",border:"rgba(59, 130, 246, 1)"},optimistic:{bg:"rgba(16, 185, 129, 0.8)",border:"rgba(16, 185, 129, 1)"}};Object.keys(e).forEach(t=>{const s=e[t],r=i[t]||i.base;n.datasets.push({label:this.formatScenarioLabel(t),data:[s.labor_savings||0,s.fee_savings||0,s.error_reduction||0,s.total_annual_benefit||0],backgroundColor:r.bg,borderColor:r.border,borderWidth:1})}),new Chart(r,{type:"bar",data:n,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(t){return"$"+(new Intl.NumberFormat).format(t)}}}},plugins:{tooltip:{callbacks:{label:function(t){return t.dataset.label+": $"+(new Intl.NumberFormat).format(t.raw)}}},legend:{display:!0,position:"top"}}}}),console.log("RTBCB: ROI chart created")}formatScenarioLabel(t){switch(t){case"conservative":return"Conservative";case"base":return"Base Case";case"optimistic":return"Optimistic";default:return t.charAt(0).toUpperCase()+t.slice(1)}}initializeCollapsibleSections(t){t.querySelectorAll(".rtbcb-section-toggle").forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-target"),e=document.getElementById(t),s=this.querySelector(".rtbcb-toggle-arrow"),r=this.querySelector(".rtbcb-toggle-text");if(e){const t="none"===e.style.display;e.style.display=t?"block":"none",s&&(s.textContent=t?"▲":"▼"),r&&(r.textContent=t?"Collapse":"Expand")}})})}initializeInteractiveMetrics(t){t.querySelectorAll(".rtbcb-metric-card").forEach(t=>{t.addEventListener("click",function(){this.classList.toggle("expanded")})})}showEnhancedError(t,e=null){this.hideLoading();const s=document.getElementById("rtbcb-progress-container");s&&(s.innerHTML=`\n\t\t\t\t<div class="rtbcb-progress-content">\n\t\t\t\t\t<div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">\n\t\t\t\t\t\t⚠️\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-text" style="color: #ef4444; margin-bottom: 16px;">\n\t\t\t\t\t\tUnable to Generate Report\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-step">\n\t\t\t\t\t\t<span class="rtbcb-progress-step-text" style="color: #4b5563;">\n\t\t\t\t\t\t\t${window.DOMPurify?DOMPurify.sanitize(t):this.escapeHTML(t)}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t${e?`\n\t\t\t\t\t<details style="margin-top: 16px; text-align: left; width: 100%; max-width: 400px;">\n\t\t\t\t\t\t<summary style="cursor: pointer; color: #7c3aed; font-weight: 600; margin-bottom: 8px;">\n\t\t\t\t\t\t\tTechnical Details\n\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t<pre style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">\n\t\t\t\t\t\t\t${this.escapeHTML(JSON.stringify(e,null,2))}\n\t\t\t\t\t\t</pre>\n\t\t\t\t\t</details>\n\t\t\t\t\t`:""}\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-partial" style="margin-top: 20px;">\n\t\t\t\t\t\t<button type="button" onclick="location.reload()"\n\t\t\t\t\t\t\t\tstyle="background: #7216f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 0 8px 8px 0;">\n\t\t\t\t\t\t\tTry Again\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<a href="/request-processing/" target="_blank"\n\t\t\t\t\t\tstyle="background: #f3f4f6; color: #4b5563; border: none; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; margin: 0 8px 8px 0;">\n\t\t\t\t\t\t\tRequest Processing\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`,s.style.display="flex",s.classList.add("active"),s.setAttribute("role","alert"),s.setAttribute("aria-label","Error occurred"))}showResults(t){console.log("RTBCB: Processing structured data results"),this.hideLoading();const e=t.company_intelligence?.industry_context||t.industry_context||t.industry_insights||{},s={companyName:t.company_name||t.metadata?.company_name||"Your Company",scenarios:t.scenarios||t.financial_analysis?.roi_scenarios||{},recommendation:{category_info:t.recommendation?.category_info||t.technology_strategy?.category_details||{},confidence:t.recommendation?.confidence||t.metadata?.confidence_level||.75,reasoning:t.recommendation?.reasoning||t.technology_strategy?.recommended_category||""},executiveSummary:t.executive_summary||t.narrative||{},operationalAnalysis:t.operational_insights||{},industryContext:{sector_analysis:e.sector_analysis||{},benchmarking:e.benchmarking||{},regulatory_landscape:e.regulatory_landscape||{}},nextActions:t.narrative?.next_actions||[...t.action_plan?.immediate_steps||[],...t.action_plan?.short_term_milestones||[],...t.action_plan?.long_term_objectives||[]],risks:t.risks||[...t.risk_analysis?.implementation_risks||[],...t.risk_analysis?.risk_matrix||[],...t.risk_analysis?.mitigation_strategies||[]]};window.closeBusinessCaseModal();const r=document.getElementById("rtbcbResults");r?(r.innerHTML=this.renderResults(s),this.populateRiskAssessment(s.risks),r.style.display="block",this.saveFinalReport(r.innerHTML),r.scrollIntoView({behavior:"smooth",block:"start"})):(console.error("RTBCB: Results container not found"),this.showEnhancedError(__("Unable to display results. Please refresh the page.","rtbcb")))}renderResults(t){const{scenarios:e,recommendation:s,companyName:r,executiveSummary:n,operationalAnalysis:i,industryContext:o,nextActions:a,risks:c}=t,l=r||"Your Company";return`\n                       <div class="rtbcb-results-container">\n                               <div class="rtbcb-results-header">\n                                       <div class="rtbcb-results-badge">\n                                               <span class="rtbcb-badge-icon">✓</span>\n                                               Business Case Generated Successfully\n                                       </div>\n                                       <h2>${l} Treasury Technology Business Case</h2>\n                                       <p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n                               </div>\n\n                               ${!(n&&(n.strategic_positioning||n.executive_recommendation||n.narrative||Array.isArray(n.key_value_drivers)&&n.key_value_drivers.length))?`<p>${__("Treasury technology investment presents a compelling opportunity for operational efficiency.","rtbcb")}</p>`:""}\n                               ${this.renderRecommendation(s,l)}\n                               ${this.renderROISummary(e,l)}\n                       ${this.renderExecutiveSummary(n)}\n                       ${this.renderOperationalAnalysis(i)}\n${this.renderIndustryInsights(o)}\n                       ${c&&c.length?this.renderRiskAssessmentSection():""}\n                       ${this.renderNextSteps(a||[],l)}\n                       ${this.renderActions()}\n               </div>\n       `}renderRecommendation(t,e){const s=t.category_info||{};return`\n\t\t\t<div class="rtbcb-recommendation-card">\n\t\t\t\t<div class="rtbcb-recommendation-header">\n\t\t\t\t\t<h3>Recommended Solution for ${e}</h3>\n\t\t\t\t\t<span class="rtbcb-confidence-badge">${Math.round(100*(t.confidence||.75))}% Confidence</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="rtbcb-recommendation-name">${s.name||"Treasury Management System"}</div>\n\t\t\t\t<div class="rtbcb-recommendation-description">\n\t\t\t\t\t${s.description||"Modern treasury platform with automation and analytics"}\n\t\t\t\t</div>\n\t\t\t\t<div class="rtbcb-recommendation-reasoning">\n\t\t\t\t\t${t.reasoning||`Based on ${e}'s profile, this solution best fits your needs.`}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderROISummary(t,e){return`\n\t\t\t<div class="rtbcb-roi-section">\n\t\t\t\t<h3>${e} Projected Annual Benefits</h3>\n\t\t\t\t<div class="rtbcb-roi-summary">\n\t\t\t\t\t<div class="rtbcb-scenario">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Conservative</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(t.low?.total_annual_benefit||t.conservative?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">80% probability</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rtbcb-scenario rtbcb-scenario-base">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Base Case</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(t.base?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">Most likely outcome</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rtbcb-scenario">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Optimistic</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(t.high?.total_annual_benefit||t.optimistic?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">Best case scenario</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t${this.renderBenefitBreakdown(t.base)}\n\t\t\t</div>\n\t\t`}renderBenefitBreakdown(t){if(!t)return"";const e=[{label:"Labor Savings",amount:t.labor_savings||0},{label:"Fee Reduction",amount:t.fee_savings||0},{label:"Error Prevention",amount:t.error_reduction||0}],s=t.total_annual_benefit||0;return`\n\t\t\t<div class="rtbcb-benefit-breakdown">\n\t\t\t\t<h4>Benefit Breakdown</h4>\n\t\t\t\t<div class="rtbcb-chart-fallback">\n\t\t\t\t\t<div class="rtbcb-benefit-bars">\n\t\t\t\t\t\t${e.map(t=>{const e=s>0?(t.amount/s*100).toFixed(0):0;return`\n\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar">\n\t\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar-label">${t.label}</div>\n\t\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar-fill" style="width: ${e}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n\t\t\t\t\t\t\t\t\t\t$${this.formatNumber(t.amount)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t`}).join("")}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderExecutiveSummary(t={}){const e=t?.strategic_positioning||"",s=t?.executive_recommendation||t?.narrative||"",r=Array.isArray(t?.key_value_drivers)?t.key_value_drivers:[];return e||s||r.length?`\n\t\t<div class="rtbcb-narrative-section">\n\t\t\t<h3>${__("Executive Summary","rtbcb")}</h3>\n\t\t\t${e?`<p>${this.escapeHTML(e)}</p>`:""}\n\t\t\t${s?`<div class="rtbcb-executive-recommendation"><strong>${__("Executive Recommendation","rtbcb")}:</strong> ${this.escapeHTML(s)}</div>`:""}\n\t\t\t${r.length?`<div class="rtbcb-industry-group"><h4>${__("Key Value Drivers","rtbcb")}</h4><ul>${(t=>t.map(t=>`<li>${this.escapeHTML(t)}</li>`).join(""))(r)}</ul></div>`:""}\n\t\t</div>\n\t`:""}renderOperationalAnalysis(t={}){const e=(t=t||{}).current_state_assessment||t.currentStateAssessment||[],s=t.process_improvements||t.processImprovements||[],r=t.automation_opportunities||t.automationOpportunities||[],n=t=>Array.isArray(t)?t.filter(t=>t&&"object"==typeof t?Object.values(t).some(t=>t):t):[],i=Array.isArray(e)?n(e):e,o=n(s),a=n(r),c=Array.isArray(i)?i.length>0:!!i,l=o.length>0,d=a.length>0;if(!c&&!l&&!d)return"";const b=c?(t=>Array.isArray(t)?`<ul>${t.map(t=>`<li>${this.escapeHTML(t)}</li>`).join("")}</ul>`:`<p>${this.escapeHTML(t)}</p>`)(i):"",p=l?`<div class="rtbcb-industry-group"><h4>${this.escapeHTML(__("Process Improvements","rtbcb"))}</h4><ul>${(t=>t.map(t=>{if(t&&"object"==typeof t){const e=this.escapeHTML(t.process||t.process_area||t.processArea||""),s=this.escapeHTML(t.current_state||t.currentState||""),r=this.escapeHTML(t.improved_state||t.improvedState||""),n=this.escapeHTML(t.impact||t.impact_level||t.impactLevel||"");let i="";return(s||r)&&(i+=`${s} → ${r}`),n&&(i+=i?` (${n})`:`(${n})`),`<li><strong>${e}</strong>${i?`: ${i}`:""}</li>`}return`<li>${this.escapeHTML(t)}</li>`}).join(""))(o)}</ul></div>`:"",u=d?`<div class="rtbcb-industry-group"><h4>${this.escapeHTML(__("Automation Opportunities","rtbcb"))}</h4><ul>${(t=>t.map(t=>{if(t&&"object"==typeof t){const e=this.escapeHTML(t.opportunity||""),s=this.escapeHTML(t.complexity||t.complexity_level||t.complexityLevel||""),r=this.escapeHTML(t.implementation_effort||t.implementationEffort||""),n=this.escapeHTML(t.savings||t.time_savings||t.timeSavings||""),i=[];s&&i.push(`${s} ${this.escapeHTML(__("complexity","rtbcb"))}`),r&&i.push(`${r} ${this.escapeHTML(__("effort","rtbcb"))}`),n&&i.push(n);return`<li><strong>${e}</strong>${i.length?`: ${i.join(" → ")}`:""}</li>`}return`<li>${this.escapeHTML(t)}</li>`}).join(""))(a)}</ul></div>`:"";return`\n<div class="rtbcb-operational-analysis">\n<h3>${this.escapeHTML(__("Operational Insights","rtbcb"))}</h3>\n${b}\n${p}\n${u}\n</div>\n`}renderIndustryInsights(t={}){const{sector_analysis:e={},benchmarking:s={},regulatory_landscape:r={}}=t||{},{market_dynamics:n="",growth_trends:i="",disruption_factors:o=[],technology_adoption:a=""}=e,{typical_treasury_setup:c="",common_pain_points:l=[],investment_patterns:d=""}=s,{key_regulations:b=[],compliance_complexity:p="",upcoming_changes:u=[]}=r;if(!(n||i||0!==o.length||a||c||0!==l.length||d||0!==b.length||p||0!==u.length))return"";const h=t=>t.map(t=>`<li>${this.escapeHTML(t)}</li>`).join("");return`\n<div class="rtbcb-industry-insights">\n<h3>Industry Insights</h3>\n${n?`<div class="rtbcb-industry-group"><h4>Market Dynamics</h4><p>${this.escapeHTML(n)}</p></div>`:""}\n${i?`<div class="rtbcb-industry-group"><h4>Growth Trends</h4><p>${this.escapeHTML(i)}</p></div>`:""}\n${o.length?`<div class="rtbcb-industry-group"><h4>Disruption Factors</h4><ul>${h(o)}</ul></div>`:""}\n${a?`<div class="rtbcb-industry-group"><h4>Technology Adoption</h4><p>${this.escapeHTML(a)}</p></div>`:""}\n${c?`<div class="rtbcb-industry-group"><h4>Typical Treasury Setup</h4><p>${this.escapeHTML(c)}</p></div>`:""}\n${l.length?`<div class="rtbcb-industry-group"><h4>Common Pain Points</h4><ul>${h(l)}</ul></div>`:""}\n${d?`<div class="rtbcb-industry-group"><h4>Investment Patterns</h4><p>${this.escapeHTML(d)}</p></div>`:""}\n${b.length?`<div class="rtbcb-industry-group"><h4>Key Regulations</h4><ul>${h(b)}</ul></div>`:""}\n${p?`<div class="rtbcb-industry-group"><h4>Compliance Complexity</h4><p>${this.escapeHTML(p)}</p></div>`:""}\n${u.length?`<div class="rtbcb-industry-group"><h4>Upcoming Changes</h4><ul>${h(u)}</ul></div>`:""}\n</div>\n`}renderRiskAssessmentSection(){return`\n\t\t<div class="rtbcb-risk-assessment">\n\t\t\t<h3>${__("Risk Assessment","rtbcb")}</h3>\n\t\t\t<ul class="rtbcb-risk-list"></ul>\n\t\t</div>\n\t`}populateRiskAssessment(t){const e=document.querySelector(".rtbcb-risk-list");e&&(e.innerHTML="",(t||[]).forEach(t=>{const s=document.createElement("li");if(t&&"object"==typeof t){const e=Object.values(t).filter(Boolean);s.textContent=e.join(" - ")}else null!=t&&(s.textContent=String(t));e.appendChild(s)}))}renderNextSteps(t){t&&0!==t.length||(t=[__("Present business case to stakeholders","rtbcb"),__("Evaluate solution providers","rtbcb"),__("Develop implementation timeline","rtbcb"),__("Plan change management strategy","rtbcb")]);const e=t=>window.DOMPurify&&"function"==typeof window.DOMPurify.sanitize?window.DOMPurify.sanitize(t):this.escapeHTML(t);return`\n\t\t\t<div class="rtbcb-next-steps">\n\t\t\t\t<h3>${__("Recommended Next Steps","rtbcb")}</h3>\n\t\t\t\t<div class="rtbcb-steps-grid">\n\t\t\t\t\t${t.map((t,s)=>`\n\t\t\t\t\t\t<div class="rtbcb-step">\n\t\t\t\t\t\t\t<div class="rtbcb-step-number">${s+1}</div>\n\t\t\t\t\t\t\t<div class="rtbcb-step-content">\n\t\t\t\t\t\t\t\t<p>${e(t)}</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderActions(){return`\n\t\t\t<div class="rtbcb-actions-section">\n\t\t\t\t<button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n\t\t\t\t\t<span class="rtbcb-btn-icon">📋</span>\n\t\t\t\t\t${__("Copy HTML","rtbcb")}\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n\t\t\t\t\t<span class="rtbcb-btn-icon">🔄</span>\n\t\t\t\t\t${__("Start Over","rtbcb")}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`}copyResultsHTML(){const t=document.querySelector(".rtbcb-results-container");t&&navigator.clipboard&&navigator.clipboard.writeText(t.innerHTML).then(()=>alert(__("Results HTML copied to clipboard","rtbcb"))).catch(t=>console.error("Copy failed:",t))}handleError(t){this.clearPersistentState();const e=t.message||__("An unexpected error occurred","rtbcb"),s=t.raw_message?e:this.getUserFriendlyMessage(e);console.group("RTBCB Error Details"),console.error("Message:",e),console.error("Type:",t.type),console.error("Debug Info:",t.debug_info),console.error("Timestamp:",t.timestamp),console.groupEnd(),this.showEnhancedError(s,t)}getUserFriendlyMessage(t){const e={"Security check failed":__("Session expired. Please refresh the page and try again.","rtbcb"),"OpenAI API key not configured":__("Service temporarily unavailable. Please try again later.","rtbcb"),"API connection failed":__("Unable to connect to analysis service. Please try again.","rtbcb"),"Missing required field":__("Please fill in all required fields.","rtbcb"),"Invalid email address":__("Please enter a valid email address.","rtbcb"),"request took longer than our 5-minute limit":__('Your request exceeded the 5-minute limit. Visit the <a href="/request-processing/" target="_blank">Request Processing page</a> or <a href="#" onclick="window.location.href=&apos;mailto:contact@realtreasury.com?subject=Business%20Case%20Request&apos;">request email delivery</a>.',"rtbcb"),"PHP error occurred":__("Server error encountered. Please try again.","rtbcb"),"Server returned invalid JSON response":__("Server communication error. Please try again.","rtbcb"),"Unexpected server response":__("Server communication error. Please try again.","rtbcb"),"Job not found":__("Unable to locate your report request. Please resubmit the form.","rtbcb")};for(const[s,r]of Object.entries(e))if(t.includes(s))return r;return __("An error occurred while processing your request. Please try again.","rtbcb")}escapeHTML(t){const e=document.createElement("div");return e.textContent=null==t?"":String(t),e.innerHTML}formatNumber(t){return"number"!=typeof t||isNaN(t)?"0":new Intl.NumberFormat("en-US",{maximumFractionDigits:0,minimumFractionDigits:0}).format(t)}reinitialize(){this.currentStep=1,this.updateStepVisibility(),this.updateProgressIndicator();try{window.sessionStorage&&window.sessionStorage.removeItem("rtbcbFinalReport")}catch(t){}}}