console.log("RTBCB: Wizard initializing");if(typeof module==="object"&&module.exports&&typeof require==="function"){try{require("./chartjs-adapter-date-fns.bundle.min.js")}catch(e){}}const __=typeof wp!=="undefined"&&wp.i18n&&wp.i18n.__?wp.i18n.__:s=>s;function isValidUrl(url){if(!url){return false}try{const parsed=new URL(url);return parsed.protocol==="http:"||parsed.protocol==="https:"}catch(e){return false}}if(typeof rtbcb_ajax!=="undefined"&&!isValidUrl(rtbcb_ajax.ajax_url)){if(typeof ajaxurl!=="undefined"&&isValidUrl(ajaxurl)){rtbcb_ajax.ajax_url=ajaxurl}}async function rtbcbRefreshNonce(){if(typeof rtbcb_ajax==="undefined"||!isValidUrl(rtbcb_ajax.ajax_url)){return false}try{const response=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_get_nonce`);if(!response.ok){return false}const data=await response.json();if(data&&data.success){rtbcb_ajax.nonce=data.data||data.nonce||data;return true}}catch(err){console.error("RTBCB: Nonce refresh failed",err)}return false}window.openBusinessCaseModal=function(){const overlay=document.getElementById("rtbcbModalOverlay");if(overlay){overlay.classList.add("active");document.body.style.overflow="hidden";if(window.businessCaseBuilder){window.businessCaseBuilder.reinitialize()}else{window.businessCaseBuilder=new BusinessCaseBuilder}}};window.closeBusinessCaseModal=function(){const overlay=document.getElementById("rtbcbModalOverlay");if(overlay&&overlay.classList&&overlay.classList.remove){overlay.classList.remove("active")}if(document.body&&document.body.style){document.body.style.overflow=""}if(window.businessCaseBuilder&&typeof window.businessCaseBuilder.cancelPolling==="function"){window.businessCaseBuilder.cancelPolling()}};const initBusinessCaseBuilder=()=>{try{if(window.businessCaseBuilder){return true}if(document.getElementById("rtbcbForm")){window.businessCaseBuilder=new BusinessCaseBuilder;return true}}catch(error){console.error("BusinessCaseBuilder initialization failed:",error)}return false};const setupBusinessCaseBuilder=()=>{if(initBusinessCaseBuilder()){return}if(typeof MutationObserver!=="undefined"){const observer=new MutationObserver(()=>{if(initBusinessCaseBuilder()){observer.disconnect()}});observer.observe(document.body,{childList:true,subtree:true})}if(typeof TEST_ENV!=="undefined"&&TEST_ENV&&!document.getElementById("rtbcbForm")){return}const start=Date.now();const interval=setInterval(()=>{if(initBusinessCaseBuilder()||Date.now()-start>1e4){clearInterval(interval)}},500)};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",setupBusinessCaseBuilder)}else{setupBusinessCaseBuilder()}class BusinessCaseBuilder{constructor(){this.currentStep=1;this.totalSteps=0;this.form=document.getElementById("rtbcbForm");this.overlay=document.getElementById("rtbcbModalOverlay");this.ajaxUrl=typeof rtbcb_ajax!=="undefined"&&isValidUrl(rtbcb_ajax.ajax_url)?rtbcb_ajax.ajax_url:"";this.pollTimeout=null;this.pollingCancelled=false;this.activeJobId=null;this.progressStates=[];this.currentProgressIndex=0;this.progressTimer=null;this.reportType="";this.lastValidationErrors=[];console.log("RTBCB: BusinessCaseBuilder constructor called");console.log("RTBCB: Form found:",!!this.form);console.log("RTBCB: Overlay found:",!!this.overlay);if(!this.form){console.error("RTBCB: Form with ID rtbcbForm not found");return}this.handleNext=this.handleNext.bind(this);this.handlePrev=this.handlePrev.bind(this);this.handleSubmit=this.handleSubmit.bind(this);console.log("RTBCB: Event handlers bound");this.init()}init(){this.cacheElements();this.bindEvents();this.restorePersistentState();this.initializePath()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next");this.prevBtn=this.form.querySelector(".rtbcb-nav-prev");this.submitBtn=this.form.querySelector(".rtbcb-nav-submit");console.log("RTBCB: Cached elements - nextBtn:",!!this.nextBtn,"prevBtn:",!!this.prevBtn,"submitBtn:",!!this.submitBtn);this.steps=this.form.querySelectorAll(".rtbcb-wizard-step");this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step");this.progressLine=this.form.querySelector(".rtbcb-progress-line");console.log("RTBCB: Found",this.steps.length,"wizard steps and",this.progressSteps.length,"progress steps");this.basicStepFields={1:["report_type"],2:["company_name"],3:["email"]};this.getStepFields=this.getEnhancedFields.bind(this)}bindEvents(){console.log("RTBCB: bindEvents executed");if(this.nextBtn){console.log("RTBCB: Binding next button click handler");this.nextBtn.addEventListener("click",this.handleNext)}else{console.warn("RTBCB: Next button not found");if(typeof MutationObserver!=="undefined"){const observer=new MutationObserver(()=>{this.nextBtn=this.form.querySelector(".rtbcb-nav-next");if(this.nextBtn){console.log("RTBCB: Dynamically found next button, binding handler");this.nextBtn.addEventListener("click",this.handleNext);observer.disconnect()}});observer.observe(this.form,{childList:true,subtree:true})}}if(this.prevBtn){this.prevBtn.addEventListener("click",this.handlePrev)}this.form.addEventListener("submit",this.handleSubmit);this.form.addEventListener("change",event=>{const target=event.target;if(target.matches('input[name="report_type"]')){console.log("RTBCB: Report type changed to:",target.value);this.initializePath()}if(target.matches('input[name="pain_points[]"]')){const card=target.closest(".rtbcb-pain-point-card");if(card){card.classList.toggle("rtbcb-selected",target.checked)}const checkedBoxes=this.form.querySelectorAll('input[name="pain_points[]"]:checked');if(checkedBoxes.length>0){this.clearStepError(7)}}});this.form.querySelectorAll("input, select").forEach(field=>{field.addEventListener("blur",()=>this.validateField(field));field.addEventListener("input",()=>this.clearFieldError(field))});document.addEventListener("keydown",e=>{if(e.key==="Escape"&&this.overlay.classList.contains("active")){window.closeBusinessCaseModal()}})}initializePath(){const selected=this.form.querySelector('input[name="report_type"]:checked');this.reportType=selected?selected.value:"basic";console.log("RTBCB: Initializing path for report type:",this.reportType);if(this.reportType==="enhanced"){this.form.querySelectorAll(".rtbcb-enhanced-only input, .rtbcb-enhanced-only select").forEach(field=>{field.disabled=false;if(field.closest(".rtbcb-field-required")){field.setAttribute("required","required")}});this.form.querySelectorAll(".rtbcb-enhanced-only").forEach(el=>{el.style.display="block"});this.steps=[this.form.querySelector('.rtbcb-wizard-step[data-step="1"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="2"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="3"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="4"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="5"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="6"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="7"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="8"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="9"]')];this.getStepFields=this.getEnhancedFields.bind(this);const stepCount=this.steps.filter(Boolean).length;this.progressSteps=Array.from(this.form.querySelectorAll(".rtbcb-progress-step")).filter(Boolean).slice(0,stepCount);this.progressSteps.forEach((step,index)=>{if(step){step.style.display="flex";step.dataset.step=index+1;const num=step.querySelector(".rtbcb-progress-number");if(num){num.textContent=index+1}}});this.totalSteps=stepCount}else{this.form.querySelectorAll(".rtbcb-enhanced-only input, .rtbcb-enhanced-only select").forEach(field=>{field.disabled=true;field.removeAttribute("required")});this.form.querySelectorAll(".rtbcb-enhanced-only").forEach(el=>{el.style.display="none"});this.steps=[this.form.querySelector('.rtbcb-wizard-step[data-step="1"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="2"]'),this.form.querySelector('.rtbcb-wizard-step[data-step="9"]')];this.getStepFields=step=>this.basicStepFields[step]||[];const stepCount=this.steps.filter(Boolean).length;this.progressSteps=[this.form.querySelector('.rtbcb-progress-step[data-step="1"]'),this.form.querySelector('.rtbcb-progress-step[data-step="2"]'),this.form.querySelector('.rtbcb-progress-step[data-step="9"]')].filter(Boolean).slice(0,stepCount);this.form.querySelectorAll(".rtbcb-progress-step").forEach(step=>{if(step){step.style.display="none"}});this.progressSteps.forEach((step,index)=>{step.style.display="flex";step.dataset.step=index+1;const num=step.querySelector(".rtbcb-progress-number");if(num){num.textContent=index+1}});this.totalSteps=stepCount}console.log("RTBCB: Path initialized. Total steps:",this.totalSteps,"Current step fields:",this.getStepFields(this.currentStep));this.currentStep=Math.min(this.currentStep,this.totalSteps);this.updateStepVisibility();this.updateProgressIndicator()}saveFormData(formData){try{const storage=window.sessionStorage;if(!storage){return}const data={};for(const[key,value]of formData.entries()){if(data[key]){if(Array.isArray(data[key])){data[key].push(value)}else{data[key]=[data[key],value]}}else{data[key]=value}}storage.setItem("rtbcbFormData",JSON.stringify(data))}catch(e){console.warn("RTBCB: Session storage unavailable",e)}}restorePersistentState(){try{const storage=window.sessionStorage;const persistent=window.localStorage;if(!storage&&!persistent){return}const reportHtml=storage&&storage.getItem("rtbcbFinalReport")||persistent&&persistent.getItem("rtbcbFinalReport");if(reportHtml){this.showEnhancedHTMLReport(reportHtml);return}const savedData=storage?storage.getItem("rtbcbFormData"):null;if(savedData){try{const parsed=JSON.parse(savedData);const defaultTypeEl=this.form.querySelector('input[name="report_type"]:checked');const defaultType=defaultTypeEl?defaultTypeEl.value:"basic";this.populateForm(parsed);const savedTypeEl=this.form.querySelector('input[name="report_type"]:checked');const savedType=savedTypeEl?savedTypeEl.value:defaultType;if(savedType!==defaultType){this.initializePath()}}catch(err){}}const jobId=storage.getItem("rtbcbJobId");if(jobId){if(this.overlay){this.overlay.classList.add("active");document.body.style.overflow="hidden"}this.activeJobId=jobId;this.showLoading();this.startProgressiveLoading();this.pollingCancelled=false;this.pollJob(jobId,Date.now(),0)}}catch(e){console.warn("RTBCB: Session storage unavailable",e)}}populateForm(data){Object.entries(data).forEach(([key,value])=>{if(Array.isArray(value)){value.forEach(val=>{const field=this.form.querySelector(`[name="${key}"][value="${val}"]`);if(field){field.checked=true}})}else{const field=this.form.querySelector(`[name="${key}"]`);if(!field){return}if(field.type==="checkbox"){field.checked=true}else if(field.type==="radio"){const radio=this.form.querySelector(`[name="${key}"][value="${value}"]`);if(radio){radio.checked=true}}else{field.value=value}}})}clearPersistentState(){try{const storage=window.sessionStorage;if(storage){storage.removeItem("rtbcbFormData");storage.removeItem("rtbcbJobId")}}catch(e){}}saveFinalReport(html){try{const storage=window.sessionStorage;if(storage){storage.setItem("rtbcbFinalReport",html)}}catch(e){console.warn("RTBCB: Session storage unavailable",e)}try{const persistent=window.localStorage;if(persistent){persistent.setItem("rtbcbFinalReport",html)}}catch(e){console.warn("RTBCB: Local storage unavailable",e)}}handleNext(event){if(event&&event.preventDefault){event.preventDefault()}console.log("RTBCB: handleNext called for step",this.currentStep);console.log("RTBCB: About to validate step",this.currentStep);const validationPassed=this.validateStep(this.currentStep);if(validationPassed){console.log("RTBCB: Step validation passed");if(this.currentStep<this.totalSteps){this.currentStep++;console.log("RTBCB: Moving to step",this.currentStep);this.updateStepVisibility();this.updateProgressIndicator();this.scrollToTop()}else{console.log("RTBCB: Already at last step")}}else{console.log("RTBCB: Step validation failed");const errors=this.lastValidationErrors||[];let message;if(errors.length){message=__("Please review the following fields: ","rtbcb")+errors.join(", ")}else{message=__("Please correct the highlighted fields.","rtbcb")}alert(message)}}handlePrev(event){if(event&&event.preventDefault){event.preventDefault()}if(this.currentStep>1){this.currentStep--;this.updateStepVisibility();this.updateProgressIndicator();this.scrollToTop()}}getEnhancedFields(stepNumber){const step=this.form.querySelector(`.rtbcb-wizard-step[data-step="${stepNumber}"]`);if(!step){return[]}const requiredFields=[...new Set(Array.from(step.querySelectorAll("[name][required]")).map(field=>field.name))];if(stepNumber===2){const jobField=step.querySelector('[name="job_title"]');if(jobField){jobField.removeAttribute("required");const index=requiredFields.indexOf("job_title");if(index!==-1){requiredFields.splice(index,1)}}}if(step.querySelector('input[name="pain_points[]"]')&&!requiredFields.includes("pain_points")){requiredFields.push("pain_points")}return requiredFields}validateStep(stepNumber){const currentFields=this.getStepFields(stepNumber)||[];let isValid=true;this.lastValidationErrors=[];if(currentFields.includes("pain_points")){const checkedBoxes=this.form.querySelectorAll('input[name="pain_points[]"]:checked');if(checkedBoxes.length===0){const message=__("Please select at least one challenge","rtbcb");this.showStepError(stepNumber,message);this.lastValidationErrors.push(message);return false}this.clearStepError(stepNumber)}for(const fieldName of currentFields){const field=this.form.querySelector(`[name="${fieldName}"]`);if(!field){continue}if(this.reportType==="basic"&&field.closest(".rtbcb-enhanced-only")){continue}if(this.reportType==="enhanced"&&field.closest(".rtbcb-enhanced-only")&&!field.hasAttribute("required")){continue}if(!this.validateField(field,true)){isValid=false;const fieldContainer=field.closest(".rtbcb-field");const label=fieldContainer?fieldContainer.querySelector("label"):null;const fieldLabel=label?label.textContent.trim():fieldName;this.lastValidationErrors.push(fieldLabel)}}return isValid}validateField(field,forceRequired=false){const value=field.value.trim();let isValid=true;let errorMessage="";if(field.type==="radio"){const group=this.form.querySelectorAll(`input[name="${field.name}"]`);const checked=Array.from(group).some(radio=>radio.checked);if(!checked){errorMessage=__("This field is required","rtbcb");group.forEach(radio=>radio.classList.add("rtbcb-field-invalid"));this.showFieldError(field,errorMessage);return false}group.forEach(radio=>radio.classList.remove("rtbcb-field-invalid"));this.clearFieldError(field);return true}if(forceRequired||field.hasAttribute("required")){if(field.type==="checkbox"){const checked=this.form.querySelectorAll(`[name="${field.name}"]:checked`).length>0;if(!checked){errorMessage=__("This field is required","rtbcb");isValid=false}}else if(!value){errorMessage=__("This field is required","rtbcb");isValid=false}}if(field.name==="company_name"&&value){if(value.length<2){errorMessage=__("Company name must be at least 2 characters","rtbcb");isValid=false}else if(value.length>100){errorMessage=__("Company name must be less than 100 characters","rtbcb");isValid=false}else if(/^[^a-zA-Z]*$/.test(value)){errorMessage=__("Please enter a valid company name","rtbcb");isValid=false}}if(field.type==="email"&&value){const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(value)){errorMessage=__("Please enter a valid email address","rtbcb");isValid=false}}if(field.type==="number"&&value){if(!Number.isFinite(Number(value))){errorMessage=__("Please enter a valid number","rtbcb");isValid=false}}if(!isValid){this.showFieldError(field,errorMessage)}else{this.clearFieldError(field)}return isValid}showFieldError(field,message){const fieldContainer=field.closest(".rtbcb-field");if(!fieldContainer)return;this.clearFieldError(field);field.classList.add("rtbcb-field-invalid");const errorEl=document.createElement("div");errorEl.className="rtbcb-field-error";errorEl.textContent=message;fieldContainer.appendChild(errorEl)}clearFieldError(field){const fieldContainer=field.closest(".rtbcb-field");if(!fieldContainer)return;field.classList.remove("rtbcb-field-invalid");const existingError=fieldContainer.querySelector(".rtbcb-field-error");if(existingError){existingError.remove()}}showStepError(stepNumber,message){const step=this.steps[stepNumber-1];if(!step)return;const validationDiv=step.querySelector(".rtbcb-pain-points-validation");if(validationDiv){const messageDiv=validationDiv.querySelector(".rtbcb-validation-message");if(messageDiv){messageDiv.textContent=message;messageDiv.style.display="block";messageDiv.style.color="#ef4444"}}}clearStepError(stepNumber){const step=this.steps[stepNumber-1];if(!step)return;const validationDiv=step.querySelector(".rtbcb-pain-points-validation");if(validationDiv){const messageDiv=validationDiv.querySelector(".rtbcb-validation-message");if(messageDiv){messageDiv.style.display="none"}}}updateStepVisibility(){this.steps.forEach((step,index)=>{if(!step){return}const stepNum=index+1;if(stepNum===this.currentStep){step.classList.add("active");step.style.display="block"}else{step.classList.remove("active");step.style.display="none"}});if(this.prevBtn){this.prevBtn.style.display=this.currentStep===1?"none":"inline-flex"}if(this.currentStep===this.totalSteps){if(this.nextBtn){this.nextBtn.style.display="none"}}else{if(this.nextBtn){this.nextBtn.style.display="inline-flex"}}if(this.submitBtn){const isLastStep=this.currentStep===this.totalSteps;if(isLastStep){this.submitBtn.style.display="inline-flex";this.submitBtn.disabled=false}else{this.submitBtn.style.display="none";this.submitBtn.disabled=true}}}updateProgressIndicator(){const activeIndex=Math.min(this.currentStep,this.progressSteps.length);this.progressSteps.forEach((step,index)=>{if(!step){return}const stepNum=index+1;if(stepNum<activeIndex){step.classList.add("completed");step.classList.remove("active")}else if(stepNum===activeIndex){step.classList.add("active");step.classList.remove("completed")}else{step.classList.remove("active","completed")}});if(this.progressLine){const progress=this.currentStep/this.totalSteps*100;this.progressLine.style.width=`${progress}%`}}scrollToTop(){const modalBody=this.form.closest(".rtbcb-modal-body");if(modalBody){modalBody.scrollTop=0}}initializeProgressStates(){this.progressStates=[{step:"initializing",message:__("Initializing analysis...","rtbcb"),duration:2e3},{step:"collecting_data",message:__("Collecting your data...","rtbcb"),duration:3e3},{step:"calculating_roi",message:__("Calculating ROI scenarios...","rtbcb"),duration:8e3},{step:"analyzing_company",message:__("Analyzing company profile...","rtbcb"),duration:6e3},{step:"market_research",message:__("Researching market insights...","rtbcb"),duration:5e3},{step:"generating_recommendations",message:__("Generating recommendations...","rtbcb"),duration:1e4},{step:"finalizing",message:__("Finalizing your report...","rtbcb"),duration:5e3}];this.currentProgressIndex=0;this.progressTimer=null}startProgressiveLoading(){this.initializeProgressStates();this.currentProgressIndex=0;this.showProgressState(this.progressStates[0]);this.scheduleNextProgressState()}showProgressState(state){const statusElement=document.getElementById("rtbcb-progress-status");if(!statusElement){return}statusElement.style.transition="opacity 0.3s ease";statusElement.style.opacity="0.5";setTimeout(()=>{statusElement.textContent=state.message;statusElement.style.opacity="1";statusElement.style.transform="scale(1.02)";setTimeout(()=>{statusElement.style.transform="scale(1)"},200)},300);console.log(`RTBCB: Progress state: ${state.step} - ${state.message}`)}scheduleNextProgressState(){if(this.pollingCancelled){return}const currentState=this.progressStates[this.currentProgressIndex];if(!currentState){return}this.progressTimer=setTimeout(()=>{this.currentProgressIndex++;if(this.currentProgressIndex<this.progressStates.length&&!this.pollingCancelled){const nextState=this.progressStates[this.currentProgressIndex];this.showProgressState(nextState);this.scheduleNextProgressState()}else if(!this.pollingCancelled){this.currentProgressIndex=Math.max(0,this.progressStates.length-3);this.scheduleNextProgressState()}},currentState.duration)}cancelProgressiveLoading(){if(this.progressTimer){clearTimeout(this.progressTimer);this.progressTimer=null}this.currentProgressIndex=0}async handleSubmit(event){if(event&&event.preventDefault){event.preventDefault()}if(!this.validateStep(this.currentStep)){return}if(!isValidUrl(this.ajaxUrl)){this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"));return}try{console.log("RTBCB: Starting form submission");this.showLoading();this.startProgressiveLoading();const formData=this.collectFormData();this.saveFormData(formData);this.validateFormData(formData);if(!isValidUrl(this.ajaxUrl)){this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"));return}let attempt=0;let response;let responseText;while(attempt<2){response=await fetch(this.ajaxUrl,{method:"POST",body:formData,credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html"}});responseText=await response.text();if(response.status===403&&attempt===0){const refreshed=await rtbcbRefreshNonce();if(refreshed){if(typeof formData.set==="function"){formData.set("rtbcb_nonce",rtbcb_ajax.nonce)}else{formData.append("rtbcb_nonce",rtbcb_ajax.nonce)}attempt++;continue}this.cancelProgressiveLoading();this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"});return}break}console.log("RTBCB: Response status:",response.status);if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}console.log("RTBCB: Response received, length:",responseText.length);console.log("RTBCB: Response received, length:",responseText.length);let data;try{data=JSON.parse(responseText);console.log("RTBCB: Parsed JSON response:",data);if(typeof data==="string"){try{console.log("RTBCB: Response is a string, attempting second parse");data=JSON.parse(data);console.log("RTBCB: Parsed stringified JSON response:",data)}catch(stringError){console.log("RTBCB: Failed to parse stringified JSON, attempting to clean");const cleanedString=data.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");data=JSON.parse(cleanedString);console.log("RTBCB: Parsed cleaned stringified JSON response:",data)}}}catch(parseError){console.log("RTBCB: JSON parse failed, attempting to clean response");try{const cleaned=responseText.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");data=JSON.parse(cleaned);console.log("RTBCB: Parsed cleaned JSON response:",data)}catch(cleanError){console.log("RTBCB: Response is not JSON, treating as HTML");if(responseText.includes('<div class="rtbcb-enhanced-report"')||responseText.includes('<div class="rtbcb-report"')){this.cancelProgressiveLoading();this.showEnhancedHTMLReport(responseText);return}throw new Error(__("Invalid response format","rtbcb"))}}if(data.success){const payload=data.data||data;if(payload.job_id){this.cancelPolling();this.pollingCancelled=false;this.activeJobId=payload.job_id;try{window.sessionStorage&&window.sessionStorage.setItem("rtbcbJobId",payload.job_id)}catch(e){}this.cancelProgressiveLoading();this.pollJob(this.activeJobId,Date.now(),0)}else{this.cancelProgressiveLoading();if(payload.report_html){this.handleSuccess(payload)}else if(payload.report_data){this.handleSuccess(payload.report_data)}else{this.handleSuccess(payload)}}}else{const payload=data.data||data;console.error("RTBCB: Error response:",payload);this.cancelProgressiveLoading();this.handleError(payload||{message:__("Unknown error occurred","rtbcb")})}}catch(error){console.error("RTBCB: Submission error:",error);this.cancelProgressiveLoading();this.handleError({message:error.message||__("An unexpected error occurred","rtbcb"),type:"submission_error"})}}collectFormData(){const rawData=new FormData(this.form);const formData=new FormData;const numericFields=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];const skipFields=["report_type"];for(const[key,value]of rawData.entries()){if(skipFields.includes(key)){continue}if(key==="job_title"&&!value){continue}if(numericFields.includes(key)){const num=parseFloat(value);formData.append(key,Number.isFinite(num)?num:0)}else{formData.append(key,value)}}formData.append("action","rtbcb_generate_case");if(typeof rtbcb_ajax!=="undefined"&&rtbcb_ajax.nonce){formData.append("rtbcb_nonce",rtbcb_ajax.nonce)}const selectedReport=this.form.querySelector('input[name="report_type"]:checked');const reportType=selectedReport?selectedReport.value:"basic";formData.append("report_type",reportType);formData.append("fast_mode",reportType==="fast"?"1":"0");return formData}validateFormData(formData){const getValue=field=>{if(typeof formData.get==="function"){return formData.get(field)}for(const[k,v]of formData.entries()){if(k===field){return v}}return null};const getAllValues=field=>{if(typeof formData.getAll==="function"){return formData.getAll(field)}const values=[];for(const[k,v]of formData.entries()){if(k===field){values.push(v)}}return values};const requiredFields=new Set;const arrayFields=new Set;for(let step=1;step<=this.totalSteps;step++){const fields=this.getStepFields(step)||[];fields.forEach(field=>{if(field.endsWith("[]")){arrayFields.add(field.replace(/\[\]$/,""));requiredFields.add(field.replace(/\[\]$/,""))}else{requiredFields.add(field)}})}for(const field of requiredFields){if(field==="pain_points"){continue}if(arrayFields.has(field)){if(getAllValues(`${field}[]`).length===0){throw new Error(`${__("Missing required field:","rtbcb")} ${field.replace("_"," ")}`)}continue}if(!getValue(field)){throw new Error(`${__("Missing required field:","rtbcb")} ${field.replace("_"," ")}`)}}if(requiredFields.has("email")){const email=getValue("email");const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(email)){throw new Error(__("Please enter a valid email address","rtbcb"))}}if(this.reportType!=="basic"){const numericFields=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const field of numericFields){if(requiredFields.has(field)){const value=parseFloat(getValue(field));if(isNaN(value)||value<=0){throw new Error(`${field.replace("_"," ")} ${__("must be a positive number","rtbcb")}`)}}}if(requiredFields.has("pain_points")&&getAllValues("pain_points[]").length===0){throw new Error(__("Please select at least one pain point","rtbcb"))}}}showLoading(){const modalContainer=document.querySelector(".rtbcb-modal-container");if(modalContainer){modalContainer.style.display="none"}const progressContainer=document.getElementById("rtbcb-progress-container");if(progressContainer){const companyName=this.form.querySelector('[name="company_name"]')?.value||"your company";const escapedCompanyName=this.escapeHTML(companyName);const enableAI=window.rtbcb_ajax?.settings?.enable_ai_analysis!==false;const initialText=enableAI?`Analyzing ${escapedCompanyName}'s treasury operations...`:"Calculating ROI scenarios...";const cancelText=__("Cancel and Start Over","rtbcb");progressContainer.innerHTML=`\n\t\t\t\t<div class="rtbcb-progress-content">\n\t\t\t\t\t<div class="rtbcb-progress-spinner"></div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-text">\n\t\t\t\t\t\tGenerating Your Business Case\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-step">\n\t\t\t\t\t\t<span class="rtbcb-progress-step-text" id="rtbcb-progress-status">\n\t\t\t\t\t\t\t${initialText}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-partial">\n\t\t\t\t\t\t<div id="rtbcb-partial-basic-roi" style="display: none;"></div>\n\t\t\t\t\t\t<div id="rtbcb-partial-category" style="display: none;"></div>\n\t\t\t\t\t\t<div id="rtbcb-partial-analysis" style="display: none;"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type="button" class="rtbcb-progress-cancel">${cancelText}</button>\n\t\t\t\t</div>\n\t\t\t`;progressContainer.style.display="flex";progressContainer.classList.add("active");document.body.style.overflow="hidden";progressContainer.setAttribute("role","dialog");progressContainer.setAttribute("aria-label","Generating business case report");progressContainer.setAttribute("aria-live","polite");const cancelBtn=progressContainer.querySelector(".rtbcb-progress-cancel");if(cancelBtn){cancelBtn.addEventListener("click",()=>{this.cancelPolling();this.hideLoading();if(typeof this.reinitialize==="function"){this.reinitialize()}})}console.log("RTBCB: Progress overlay shown")}}hideLoading(){const progressContainer=document.getElementById("rtbcb-progress-container");if(progressContainer){progressContainer.style.display="none";progressContainer.classList.remove("active");progressContainer.innerHTML="";progressContainer.removeAttribute("role");progressContainer.removeAttribute("aria-label");progressContainer.removeAttribute("aria-live")}document.body.style.overflow="";const modalContainer=document.querySelector(".rtbcb-modal-container");if(modalContainer){modalContainer.style.display="block"}const formContainer=this.form&&typeof this.form.closest==="function"?this.form.closest(".rtbcb-form-container"):null;if(formContainer){formContainer.style.display="block"}console.log("RTBCB: Progress overlay hidden")}cancelPolling(){this.pollingCancelled=true;this.cancelProgressiveLoading();if(this.pollTimeout){clearTimeout(this.pollTimeout);this.pollTimeout=null}this.clearPersistentState();this.activeJobId=null;console.log("RTBCB: All polling and progress timers cancelled")}async pollJob(jobId,startTime=Date.now(),attempt=0){const MAX_DURATION=20*60*1e3;const MAX_ATTEMPTS=600;if(this.pollingCancelled){return}if(Date.now()-startTime>MAX_DURATION||attempt>MAX_ATTEMPTS){this.handleError({message:__("The request timed out after 20 minutes. Please try again later.","rtbcb"),type:"timeout"});this.cancelPolling();return}try{let nonce=typeof rtbcb_ajax!=="undefined"&&rtbcb_ajax.nonce?rtbcb_ajax.nonce:"";let attemptNonce=0;let response;let responseText;while(attemptNonce<2){response=await fetch(`${this.ajaxUrl}?action=rtbcb_job_status&job_id=${encodeURIComponent(jobId)}&rtbcb_nonce=${nonce}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});responseText=await response.text();if((response.status===403||responseText.includes("Security check failed"))&&attemptNonce===0){const refreshed=await rtbcbRefreshNonce();if(refreshed){nonce=rtbcb_ajax.nonce;attemptNonce++;continue}this.cancelPolling();this.hideLoading();this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"});return}break}if(!response.ok){this.cancelPolling();this.handleError({message:response.statusText,type:"polling_error"});return}const data=JSON.parse(responseText);if(!data.success){this.handleError({message:__("Unable to retrieve job status","rtbcb"),type:"polling_error"});this.cancelPolling();return}const statusData=data.data||data;const{status:status,step:step,message:message,percent:percent}=statusData;console.log(`RTBCB: Job status: ${status} (attempt ${attempt})`);this.updateJobProgressStatus(statusData,attempt);this.updatePartialResults(statusData);if(status==="completed"){this.cancelPolling();this.showCompletionAnimation(()=>{this.hideLoading();if(statusData.report_html){this.handleSuccess({report_html:statusData.report_html,report_data:statusData.report_data})}else if(statusData.report_data){this.handleSuccess(statusData.report_data)}else{this.handleError({message:__("Report data missing from completed job","rtbcb"),type:"job_error"})}})}else if(status==="error"){this.cancelPolling();this.hideLoading();this.handleError({message:statusData.message||__("Job failed","rtbcb"),type:"job_error"})}else if(typeof percent==="number"&&percent>=100){this.cancelPolling();this.showCompletionAnimation(()=>{this.hideLoading();if(statusData.report_html){this.handleSuccess({report_html:statusData.report_html,report_data:statusData.report_data})}else if(statusData.report_data){this.handleSuccess(statusData.report_data)}else{this.handleError({message:"Report data missing from completed job",type:"job_error"})}})}else if(!this.pollingCancelled){this.pollTimeout=setTimeout(()=>this.pollJob(jobId,startTime,attempt+1),2e3)}}catch(error){console.error("RTBCB: Job polling error:",error);this.cancelPolling();this.handleError({message:error.message||"An unexpected error occurred",type:"polling_error"})}}showCompletionAnimation(callback){const statusElement=document.getElementById("rtbcb-progress-status");const spinner=document.querySelector(".rtbcb-progress-spinner");if(statusElement){statusElement.textContent=__("Report completed successfully! ✓","rtbcb");statusElement.style.color="var(--success-green)";statusElement.style.fontWeight="600"}if(spinner){spinner.style.borderTopColor="var(--success-green)";spinner.style.animation="rtbcb-spin 0.5s ease-out";setTimeout(()=>{spinner.style.display="none";const checkmark=document.createElement("div");checkmark.innerHTML="✓";checkmark.style.cssText=`\n\t\t\t\t\tfont-size: 60px;\n\t\t\t\t\tcolor: var(--success-green);\n\t\t\t\t\tanimation: rtbcb-bounce 0.6s ease-out;\n\t\t\t\t\tmargin: 0 auto 24px;\n\t\t\t\t\twidth: 60px;\n\t\t\t\t\theight: 60px;\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t`;spinner.parentNode.insertBefore(checkmark,spinner)},500)}setTimeout(callback,1500)}updateJobProgressStatus(statusData,attempt){const progressStatus=document.getElementById("rtbcb-progress-status");if(!progressStatus){return}const{status:status,step:step,message:message,percent:percent}=statusData;let displayText="";if(step&&step!=="processing"){displayText=this.formatProgressStep(step)}else if(message&&message.trim()){displayText=this.formatProgressMessage(message)}else{const currentText=progressStatus.textContent||__("Processing...","rtbcb");displayText=currentText}if(typeof percent==="number"&&percent>0&&percent<100){displayText+=` (${Math.round(percent)}%)`}if(displayText!==progressStatus.textContent){progressStatus.style.transition="opacity 0.2s ease";progressStatus.style.opacity="0.7";setTimeout(()=>{progressStatus.textContent=displayText;progressStatus.style.opacity="1"},200)}}updatePartialResults(statusData){const roiContainer=document.getElementById("rtbcb-partial-basic-roi");if(statusData.basic_roi&&roiContainer){const baseROI=statusData.basic_roi?.financial_analysis?.roi_scenarios?.base?.total_annual_benefit;if(typeof baseROI==="number"&&baseROI>0){roiContainer.innerHTML=`\n\t\t\t\t\t<strong>✓ ROI Analysis Complete</strong><br>\n\t\t\t\t\tProjected Annual Benefit: $${this.formatNumber(baseROI)}\n\t\t\t\t`;roiContainer.style.display="block"}}const categoryContainer=document.getElementById("rtbcb-partial-category");if(statusData.category&&categoryContainer){categoryContainer.innerHTML=`\n\t\t\t\t<strong>✓ Solution Identified</strong><br>\n\t\t\t\tRecommended: ${this.escapeHTML(statusData.category)}\n\t\t\t`;categoryContainer.style.display="block"}const analysisContainer=document.getElementById("rtbcb-partial-analysis");if(statusData.analysis_step&&analysisContainer){analysisContainer.innerHTML=`\n\t\t\t\t<strong>✓ AI Analysis</strong><br>\n\t\t\t\t${this.escapeHTML(statusData.analysis_step)}\n\t\t\t`;analysisContainer.style.display="block"}}formatProgressStep(step){const stepMap={roi_calculation:__("Calculating ROI scenarios...","rtbcb"),category_recommendation:__("Identifying optimal solution category...","rtbcb"),rag_search:__("Researching market insights...","rtbcb"),ai_analysis:__("Generating AI-powered analysis...","rtbcb"),report_generation:__("Assembling your business case report...","rtbcb"),finalizing:__("Finalizing recommendations...","rtbcb")};return stepMap[step]||step.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase())+"..."}formatProgressMessage(message){if(!message){return""}const cleanMessage=message.replace(/\.+$/,"");return cleanMessage+"..."}handleSuccess(data){this.clearPersistentState();console.log("RTBCB: Success data received:",data);if(typeof data==="string"){this.showEnhancedHTMLReport(data);return}if(data.report_html&&data.report_html.trim()){this.showEnhancedHTMLReport(data.report_html)}else{this.showResults(data)}}showEnhancedHTMLReport(htmlContent){console.log("RTBCB: Displaying enhanced HTML report");this.hideLoading();window.closeBusinessCaseModal();let resultsContainer=document.getElementById("rtbcb-results-enhanced");if(!resultsContainer){console.log("RTBCB: Creating results container");resultsContainer=document.createElement("div");resultsContainer.id="rtbcb-results-enhanced";resultsContainer.className="rtbcb-enhanced-results-container";const modal=document.getElementById("rtbcbModalOverlay");if(modal&&modal.parentNode){modal.parentNode.insertBefore(resultsContainer,modal.nextSibling);console.log("RTBCB: Results container inserted after modal")}else{document.body.appendChild(resultsContainer);console.log("RTBCB: Results container appended to body")}}else{console.log("RTBCB: Reusing existing results container")}console.log("RTBCB: Injecting report content");resultsContainer.innerHTML=htmlContent;resultsContainer.style.display="block";this.saveFinalReport(htmlContent);this.initializeEnhancedReport(resultsContainer);resultsContainer.scrollIntoView({behavior:"smooth",block:"start"})}initializeEnhancedReport(container){this.initializeReportCharts(container);this.initializeCollapsibleSections(container);this.initializeInteractiveMetrics(container)}initializeReportCharts(container){if(window.rtbcb_ajax?.settings&&window.rtbcb_ajax.settings.enable_charts===false){console.log("RTBCB: Charts disabled in settings");return}const chartCanvas=container.querySelector("#rtbcb-roi-chart");if(!chartCanvas)return;console.log("RTBCB: Initializing ROI chart");if(typeof Chart==="undefined"){console.warn("RTBCB: Chart.js library is not available");return}try{const roiData=this.extractROIDataFromReport(container);console.log("RTBCB: Extracted ROI data",roiData);if(!roiData||Object.keys(roiData).length===0){console.warn("RTBCB: ROI data is empty. Chart will not be rendered");return}this.createROIChart(chartCanvas,roiData)}catch(error){console.error("Failed to initialize chart:",error)}}extractROIDataFromReport(container){const roiData={};const scenarioCards=container.querySelectorAll(".rtbcb-scenario-card");scenarioCards.forEach(card=>{const scenarioName=this.getScenarioNameFromCard(card);if(scenarioName){roiData[scenarioName]=this.extractMetricsFromCard(card)}});return roiData}getScenarioNameFromCard(card){if(card.classList.contains("conservative"))return"conservative";if(card.classList.contains("base"))return"base";if(card.classList.contains("optimistic"))return"optimistic";const heading=card.querySelector("h4");if(heading){const text=heading.textContent.toLowerCase();if(text.includes("conservative"))return"conservative";if(text.includes("base"))return"base";if(text.includes("optimistic"))return"optimistic"}return null}extractMetricsFromCard(card){const metrics={};const metricElements=card.querySelectorAll(".rtbcb-scenario-metric");metricElements.forEach(metric=>{const label=metric.querySelector(".rtbcb-metric-label");const value=metric.querySelector(".rtbcb-metric-value");if(label&&value){const labelText=label.textContent.trim();const valueText=value.textContent.replace(/[$,]/g,"").trim();const numValue=parseFloat(valueText)||0;if(labelText.includes("Total Annual")){metrics.total_annual_benefit=numValue}else if(labelText.includes("Labor")){metrics.labor_savings=numValue}else if(labelText.includes("Fee")){metrics.fee_savings=numValue}else if(labelText.includes("Error")){metrics.error_reduction=numValue}}});return metrics}createROIChart(canvas,roiData){console.log("RTBCB: Creating ROI chart");const existingChart=typeof Chart.getChart==="function"?Chart.getChart(canvas):null;if(existingChart){existingChart.destroy()}const ctx=canvas.getContext("2d");if(!ctx){console.error("RTBCB: Failed to get canvas context for ROI chart.");if(canvas.parentNode){const message=window.wp?.i18n?.__("Chart rendering failed","rtbcb")||"Chart rendering failed";const errorEl=document.createElement("p");errorEl.textContent=message;errorEl.classList.add("rtbcb-chart-error");canvas.parentNode.insertBefore(errorEl,canvas);canvas.remove()}return}const chartData={labels:["Labor Savings","Fee Savings","Error Reduction","Total Benefit"],datasets:[]};const colors={conservative:{bg:"rgba(239, 68, 68, 0.8)",border:"rgba(239, 68, 68, 1)"},base:{bg:"rgba(59, 130, 246, 0.8)",border:"rgba(59, 130, 246, 1)"},optimistic:{bg:"rgba(16, 185, 129, 0.8)",border:"rgba(16, 185, 129, 1)"}};Object.keys(roiData).forEach(scenario=>{const data=roiData[scenario];const color=colors[scenario]||colors.base;chartData.datasets.push({label:this.formatScenarioLabel(scenario),data:[data.labor_savings||0,data.fee_savings||0,data.error_reduction||0,data.total_annual_benefit||0],backgroundColor:color.bg,borderColor:color.border,borderWidth:1})});new Chart(ctx,{type:"bar",data:chartData,options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:function(value){return"$"+(new Intl.NumberFormat).format(value)}}}},plugins:{tooltip:{callbacks:{label:function(context){return context.dataset.label+": $"+(new Intl.NumberFormat).format(context.raw)}}},legend:{display:true,position:"top"}}}});console.log("RTBCB: ROI chart created")}formatScenarioLabel(scenario){switch(scenario){case"conservative":return"Conservative";case"base":return"Base Case";case"optimistic":return"Optimistic";default:return scenario.charAt(0).toUpperCase()+scenario.slice(1)}}initializeCollapsibleSections(container){const toggles=container.querySelectorAll(".rtbcb-section-toggle");toggles.forEach(toggle=>{toggle.addEventListener("click",function(){const targetId=this.getAttribute("data-target");const content=document.getElementById(targetId);const arrow=this.querySelector(".rtbcb-toggle-arrow");const text=this.querySelector(".rtbcb-toggle-text");if(content){const isHidden=content.style.display==="none";content.style.display=isHidden?"block":"none";if(arrow){arrow.textContent=isHidden?"▲":"▼"}if(text){text.textContent=isHidden?"Collapse":"Expand"}}})})}initializeInteractiveMetrics(container){const metricCards=container.querySelectorAll(".rtbcb-metric-card");metricCards.forEach(card=>{card.addEventListener("click",function(){this.classList.toggle("expanded")})})}showEnhancedError(message,details=null){this.hideLoading();const progressContainer=document.getElementById("rtbcb-progress-container");if(progressContainer){progressContainer.innerHTML=`\n\t\t\t\t<div class="rtbcb-progress-content">\n\t\t\t\t\t<div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">\n\t\t\t\t\t\t⚠️\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-text" style="color: #ef4444; margin-bottom: 16px;">\n\t\t\t\t\t\tUnable to Generate Report\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-step">\n\t\t\t\t\t\t<span class="rtbcb-progress-step-text" style="color: #4b5563;">\n\t\t\t\t\t\t\t${window.DOMPurify?DOMPurify.sanitize(message):this.escapeHTML(message)}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t${details?`\n\t\t\t\t\t<details style="margin-top: 16px; text-align: left; width: 100%; max-width: 400px;">\n\t\t\t\t\t\t<summary style="cursor: pointer; color: #7c3aed; font-weight: 600; margin-bottom: 8px;">\n\t\t\t\t\t\t\tTechnical Details\n\t\t\t\t\t\t</summary>\n\t\t\t\t\t\t<pre style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">\n\t\t\t\t\t\t\t${this.escapeHTML(JSON.stringify(details,null,2))}\n\t\t\t\t\t\t</pre>\n\t\t\t\t\t</details>\n\t\t\t\t\t`:""}\n\t\t\t\t\t\n\t\t\t\t\t<div class="rtbcb-progress-partial" style="margin-top: 20px;">\n\t\t\t\t\t\t<button type="button" onclick="location.reload()"\n\t\t\t\t\t\t\t\tstyle="background: #7216f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 0 8px 8px 0;">\n\t\t\t\t\t\t\tTry Again\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<a href="/request-processing/" target="_blank"\n\t\t\t\t\t\tstyle="background: #f3f4f6; color: #4b5563; border: none; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; margin: 0 8px 8px 0;">\n\t\t\t\t\t\t\tRequest Processing\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;progressContainer.style.display="flex";progressContainer.classList.add("active");progressContainer.setAttribute("role","alert");progressContainer.setAttribute("aria-label","Error occurred")}}showResults(data){console.log("RTBCB: Processing structured data results");this.hideLoading();const context=data.company_intelligence?.industry_context||data.industry_context||data.industry_insights||{};const mapped={companyName:data.company_name||data.metadata?.company_name||"Your Company",scenarios:data.scenarios||data.financial_analysis?.roi_scenarios||{},recommendation:{category_info:data.recommendation?.category_info||data.technology_strategy?.category_details||{},confidence:data.recommendation?.confidence||data.metadata?.confidence_level||.75,reasoning:data.recommendation?.reasoning||data.technology_strategy?.recommended_category||""},executiveSummary:data.executive_summary||data.narrative||{},operationalAnalysis:data.operational_insights||{},industryContext:{sector_analysis:context.sector_analysis||{},benchmarking:context.benchmarking||{},regulatory_landscape:context.regulatory_landscape||{}},nextActions:data.narrative?.next_actions||[...data.action_plan?.immediate_steps||[],...data.action_plan?.short_term_milestones||[],...data.action_plan?.long_term_objectives||[]],risks:data.risks||[...data.risk_analysis?.implementation_risks||[],...data.risk_analysis?.risk_matrix||[],...data.risk_analysis?.mitigation_strategies||[]]};window.closeBusinessCaseModal();const resultsContainer=document.getElementById("rtbcbResults");if(resultsContainer){resultsContainer.innerHTML=this.renderResults(mapped);this.populateRiskAssessment(mapped.risks);resultsContainer.style.display="block";this.saveFinalReport(resultsContainer.innerHTML);resultsContainer.scrollIntoView({behavior:"smooth",block:"start"})}else{console.error("RTBCB: Results container not found");this.showEnhancedError(__("Unable to display results. Please refresh the page.","rtbcb"))}}renderResults(data){const{scenarios:scenarios,recommendation:recommendation,companyName:companyName,executiveSummary:executiveSummary,operationalAnalysis:operationalAnalysis,industryContext:industryContext,nextActions:nextActions,risks:risks}=data;const displayName=companyName||"Your Company";return`\n\t\t\t<div class="rtbcb-results-container">\n\t\t\t\t<div class="rtbcb-results-header">\n\t\t\t\t\t<div class="rtbcb-results-badge">\n\t\t\t\t\t\t<span class="rtbcb-badge-icon">✓</span>\n\t\t\t\t\t\tBusiness Case Generated Successfully\n\t\t\t\t\t</div>\n\t\t\t\t\t<h2>${displayName} Treasury Technology Business Case</h2>\n\t\t\t\t\t<p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n\t\t\t\t</div>\n\n\t\t\t\t${this.renderRecommendation(recommendation,displayName)}\n\t\t\t\t${this.renderROISummary(scenarios,displayName)}\n\t\t\t${this.renderExecutiveSummary(executiveSummary)}\n\t\t\t${this.renderOperationalAnalysis(operationalAnalysis)}\n${this.renderIndustryInsights(industryContext)}\n\t\t\t${risks&&risks.length?this.renderRiskAssessmentSection():""}\n\t\t\t${this.renderNextSteps(nextActions||[],displayName)}\n\t\t\t${this.renderActions()}\n\t\t</div>\n\t`}renderRecommendation(recommendation,companyName){const category=recommendation.category_info||{};const confidence=Math.round((recommendation.confidence||.75)*100);return`\n\t\t\t<div class="rtbcb-recommendation-card">\n\t\t\t\t<div class="rtbcb-recommendation-header">\n\t\t\t\t\t<h3>Recommended Solution for ${companyName}</h3>\n\t\t\t\t\t<span class="rtbcb-confidence-badge">${confidence}% Confidence</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="rtbcb-recommendation-name">${category.name||"Treasury Management System"}</div>\n\t\t\t\t<div class="rtbcb-recommendation-description">\n\t\t\t\t\t${category.description||"Modern treasury platform with automation and analytics"}\n\t\t\t\t</div>\n\t\t\t\t<div class="rtbcb-recommendation-reasoning">\n\t\t\t\t\t${recommendation.reasoning||`Based on ${companyName}'s profile, this solution best fits your needs.`}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderROISummary(scenarios,companyName){return`\n\t\t\t<div class="rtbcb-roi-section">\n\t\t\t\t<h3>${companyName} Projected Annual Benefits</h3>\n\t\t\t\t<div class="rtbcb-roi-summary">\n\t\t\t\t\t<div class="rtbcb-scenario">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Conservative</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.low?.total_annual_benefit||scenarios.conservative?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">80% probability</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rtbcb-scenario rtbcb-scenario-base">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Base Case</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.base?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">Most likely outcome</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rtbcb-scenario">\n\t\t\t\t\t\t<div class="rtbcb-scenario-label">Optimistic</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.high?.total_annual_benefit||scenarios.optimistic?.total_annual_benefit||0)}</div>\n\t\t\t\t\t\t<div class="rtbcb-scenario-confidence">Best case scenario</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t${this.renderBenefitBreakdown(scenarios.base)}\n\t\t\t</div>\n\t\t`}renderBenefitBreakdown(scenario){if(!scenario)return"";const benefits=[{label:"Labor Savings",amount:scenario.labor_savings||0},{label:"Fee Reduction",amount:scenario.fee_savings||0},{label:"Error Prevention",amount:scenario.error_reduction||0}];const total=scenario.total_annual_benefit||0;return`\n\t\t\t<div class="rtbcb-benefit-breakdown">\n\t\t\t\t<h4>Benefit Breakdown</h4>\n\t\t\t\t<div class="rtbcb-chart-fallback">\n\t\t\t\t\t<div class="rtbcb-benefit-bars">\n\t\t\t\t\t\t${benefits.map(b=>{const percentage=total>0?(b.amount/total*100).toFixed(0):0;return`\n\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar">\n\t\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar-label">${b.label}</div>\n\t\t\t\t\t\t\t\t\t<div class="rtbcb-benefit-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n\t\t\t\t\t\t\t\t\t\t$${this.formatNumber(b.amount)}\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t`}).join("")}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderExecutiveSummary(summary={}){const positioning=summary?.strategic_positioning||"";const recommendation=summary?.executive_recommendation||summary?.narrative||"";const keyDrivers=Array.isArray(summary?.key_value_drivers)?summary.key_value_drivers:[];const renderList=items=>items.map(item=>`<li>${this.escapeHTML(item)}</li>`).join("");if(!positioning&&!recommendation&&!keyDrivers.length){return""}return`\n\t\t<div class="rtbcb-narrative-section">\n\t\t\t<h3>${__("Executive Summary","rtbcb")}</h3>\n\t\t\t${positioning?`<p>${this.escapeHTML(positioning)}</p>`:""}\n\t\t\t${recommendation?`<div class="rtbcb-executive-recommendation"><strong>${__("Executive Recommendation","rtbcb")}:</strong> ${this.escapeHTML(recommendation)}</div>`:""}\n\t\t\t${keyDrivers.length?`<div class="rtbcb-industry-group"><h4>${__("Key Value Drivers","rtbcb")}</h4><ul>${renderList(keyDrivers)}</ul></div>`:""}\n\t\t</div>\n\t`}renderOperationalAnalysis(analysis={}){analysis=analysis||{};const current_state_assessment=analysis.current_state_assessment||analysis.currentStateAssessment||[];const process_improvements=analysis.process_improvements||analysis.processImprovements||[];const automation_opportunities=analysis.automation_opportunities||analysis.automationOpportunities||[];const sanitizeItems=items=>Array.isArray(items)?items.filter(item=>{if(item&&typeof item==="object"){return Object.values(item).some(val=>val)}return item}):[];const currentItems=Array.isArray(current_state_assessment)?sanitizeItems(current_state_assessment):current_state_assessment;const processItems=sanitizeItems(process_improvements);const automationItems=sanitizeItems(automation_opportunities);const hasCurrent=Array.isArray(currentItems)?currentItems.length>0:!!currentItems;const hasProcess=processItems.length>0;const hasAutomation=automationItems.length>0;if(!hasCurrent&&!hasProcess&&!hasAutomation){return""}const renderCurrentState=items=>{if(Array.isArray(items)){return`<ul>${items.map(item=>`<li>${this.escapeHTML(item)}</li>`).join("")}</ul>`}return`<p>${this.escapeHTML(items)}</p>`};const renderProcessImprovements=items=>items.map(item=>{if(item&&typeof item==="object"){const process=this.escapeHTML(item.process||item.process_area||item.processArea||"");const current=this.escapeHTML(item.current_state||item.currentState||"");const improved=this.escapeHTML(item.improved_state||item.improvedState||"");const impact=this.escapeHTML(item.impact||item.impact_level||item.impactLevel||"");let details="";if(current||improved){details+=`${current} → ${improved}`}if(impact){details+=details?` (${impact})`:`(${impact})`}return`<li><strong>${process}</strong>${details?`: ${details}`:""}</li>`}return`<li>${this.escapeHTML(item)}</li>`}).join("");const renderAutomationOpportunities=items=>items.map(item=>{if(item&&typeof item==="object"){const opportunity=this.escapeHTML(item.opportunity||"");const complexity=this.escapeHTML(item.complexity||item.complexity_level||item.complexityLevel||"");const effort=this.escapeHTML(item.implementation_effort||item.implementationEffort||"");const savings=this.escapeHTML(item.savings||item.time_savings||item.timeSavings||"");const parts=[];if(complexity){parts.push(`${complexity} ${this.escapeHTML(__("complexity","rtbcb"))}`)}if(effort){parts.push(`${effort} ${this.escapeHTML(__("effort","rtbcb"))}`)}if(savings){parts.push(savings)}const detail=parts.length?`: ${parts.join(" → ")}`:"";return`<li><strong>${opportunity}</strong>${detail}</li>`}return`<li>${this.escapeHTML(item)}</li>`}).join("");const currentSection=hasCurrent?renderCurrentState(currentItems):"";const processSection=hasProcess?`<div class="rtbcb-industry-group"><h4>${this.escapeHTML(__("Process Improvements","rtbcb"))}</h4><ul>${renderProcessImprovements(processItems)}</ul></div>`:"";const automationSection=hasAutomation?`<div class="rtbcb-industry-group"><h4>${this.escapeHTML(__("Automation Opportunities","rtbcb"))}</h4><ul>${renderAutomationOpportunities(automationItems)}</ul></div>`:"";return`\n<div class="rtbcb-operational-analysis">\n<h3>${this.escapeHTML(__("Operational Insights","rtbcb"))}</h3>\n${currentSection}\n${processSection}\n${automationSection}\n</div>\n`}renderIndustryInsights(context={}){const{sector_analysis:sector_analysis={},benchmarking:benchmarking={},regulatory_landscape:regulatory_landscape={}}=context||{};const{market_dynamics:market_dynamics="",growth_trends:growth_trends="",disruption_factors:disruption_factors=[],technology_adoption:technology_adoption=""}=sector_analysis;const{typical_treasury_setup:typical_treasury_setup="",common_pain_points:common_pain_points=[],investment_patterns:investment_patterns=""}=benchmarking;const{key_regulations:key_regulations=[],compliance_complexity:compliance_complexity="",upcoming_changes:upcoming_changes=[]}=regulatory_landscape;if(!market_dynamics&&!growth_trends&&disruption_factors.length===0&&!technology_adoption&&!typical_treasury_setup&&common_pain_points.length===0&&!investment_patterns&&key_regulations.length===0&&!compliance_complexity&&upcoming_changes.length===0){return""}const renderList=items=>items.map(item=>`<li>${this.escapeHTML(item)}</li>`).join("");return`\n<div class="rtbcb-industry-insights">\n<h3>Industry Insights</h3>\n${market_dynamics?`<div class="rtbcb-industry-group"><h4>Market Dynamics</h4><p>${this.escapeHTML(market_dynamics)}</p></div>`:""}\n${growth_trends?`<div class="rtbcb-industry-group"><h4>Growth Trends</h4><p>${this.escapeHTML(growth_trends)}</p></div>`:""}\n${disruption_factors.length?`<div class="rtbcb-industry-group"><h4>Disruption Factors</h4><ul>${renderList(disruption_factors)}</ul></div>`:""}\n${technology_adoption?`<div class="rtbcb-industry-group"><h4>Technology Adoption</h4><p>${this.escapeHTML(technology_adoption)}</p></div>`:""}\n${typical_treasury_setup?`<div class="rtbcb-industry-group"><h4>Typical Treasury Setup</h4><p>${this.escapeHTML(typical_treasury_setup)}</p></div>`:""}\n${common_pain_points.length?`<div class="rtbcb-industry-group"><h4>Common Pain Points</h4><ul>${renderList(common_pain_points)}</ul></div>`:""}\n${investment_patterns?`<div class="rtbcb-industry-group"><h4>Investment Patterns</h4><p>${this.escapeHTML(investment_patterns)}</p></div>`:""}\n${key_regulations.length?`<div class="rtbcb-industry-group"><h4>Key Regulations</h4><ul>${renderList(key_regulations)}</ul></div>`:""}\n${compliance_complexity?`<div class="rtbcb-industry-group"><h4>Compliance Complexity</h4><p>${this.escapeHTML(compliance_complexity)}</p></div>`:""}\n${upcoming_changes.length?`<div class="rtbcb-industry-group"><h4>Upcoming Changes</h4><ul>${renderList(upcoming_changes)}</ul></div>`:""}\n</div>\n`}renderRiskAssessmentSection(){return`\n\t\t<div class="rtbcb-risk-assessment">\n\t\t\t<h3>${__("Risk Assessment","rtbcb")}</h3>\n\t\t\t<ul class="rtbcb-risk-list"></ul>\n\t\t</div>\n\t`}populateRiskAssessment(risks){const list=document.querySelector(".rtbcb-risk-list");if(!list)return;list.innerHTML="";(risks||[]).forEach(risk=>{const item=document.createElement("li");if(risk&&typeof risk==="object"){const values=Object.values(risk).filter(Boolean);item.textContent=values.join(" - ")}else if(risk!=null){item.textContent=String(risk)}list.appendChild(item)})}renderNextSteps(steps){if(!steps||steps.length===0){steps=[__("Present business case to stakeholders","rtbcb"),__("Evaluate solution providers","rtbcb"),__("Develop implementation timeline","rtbcb"),__("Plan change management strategy","rtbcb")]}const sanitize=str=>window.DOMPurify&&typeof window.DOMPurify.sanitize==="function"?window.DOMPurify.sanitize(str):this.escapeHTML(str);return`\n\t\t\t<div class="rtbcb-next-steps">\n\t\t\t\t<h3>${__("Recommended Next Steps","rtbcb")}</h3>\n\t\t\t\t<div class="rtbcb-steps-grid">\n\t\t\t\t\t${steps.map((step,index)=>`\n\t\t\t\t\t\t<div class="rtbcb-step">\n\t\t\t\t\t\t\t<div class="rtbcb-step-number">${index+1}</div>\n\t\t\t\t\t\t\t<div class="rtbcb-step-content">\n\t\t\t\t\t\t\t\t<p>${sanitize(step)}</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderActions(){return`\n\t\t\t<div class="rtbcb-actions-section">\n\t\t\t\t<button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n\t\t\t\t\t<span class="rtbcb-btn-icon">📋</span>\n\t\t\t\t\t${__("Copy HTML","rtbcb")}\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n\t\t\t\t\t<span class="rtbcb-btn-icon">🔄</span>\n\t\t\t\t\t${__("Start Over","rtbcb")}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t`}copyResultsHTML(){const container=document.querySelector(".rtbcb-results-container");if(!container||!navigator.clipboard){return}navigator.clipboard.writeText(container.innerHTML).then(()=>alert(__("Results HTML copied to clipboard","rtbcb"))).catch(err=>console.error("Copy failed:",err))}handleError(errorData){this.clearPersistentState();const message=errorData.message||__("An unexpected error occurred","rtbcb");console.group("RTBCB Error Details");console.error("Message:",message);console.error("Type:",errorData.type);console.error("Debug Info:",errorData.debug_info);console.error("Timestamp:",errorData.timestamp);console.groupEnd();this.showEnhancedError(this.getUserFriendlyMessage(message),errorData)}getUserFriendlyMessage(serverMessage){const errorMappings={"Security check failed":__("Session expired. Please refresh the page and try again.","rtbcb"),"OpenAI API key not configured":__("Service temporarily unavailable. Please try again later.","rtbcb"),"API connection failed":__("Unable to connect to analysis service. Please try again.","rtbcb"),"Missing required field":__("Please fill in all required fields.","rtbcb"),"Invalid email address":__("Please enter a valid email address.","rtbcb"),"request took longer than our 5-minute limit":__('Your request exceeded the 5-minute limit. Visit the <a href="/request-processing/" target="_blank">Request Processing page</a> or <a href="#" onclick="window.location.href=&apos;mailto:contact@realtreasury.com?subject=Business%20Case%20Request&apos;">request email delivery</a>.',"rtbcb"),"PHP error occurred":__("Server error encountered. Please try again.","rtbcb"),"Server returned invalid JSON response":__("Server communication error. Please try again.","rtbcb"),"Unexpected server response":__("Server communication error. Please try again.","rtbcb"),"Job not found":__("Unable to locate your report request. Please resubmit the form.","rtbcb")};for(const[key,message]of Object.entries(errorMappings)){if(serverMessage.includes(key)){return message}}return __("An error occurred while processing your request. Please try again.","rtbcb")}escapeHTML(str){const div=document.createElement("div");div.textContent=str==null?"":String(str);return div.innerHTML}formatNumber(num){if(typeof num!=="number"||isNaN(num))return"0";return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,minimumFractionDigits:0}).format(num)}reinitialize(){this.currentStep=1;this.updateStepVisibility();this.updateProgressIndicator();try{window.sessionStorage&&window.sessionStorage.removeItem("rtbcbFinalReport")}catch(e){}}}