if("function"==typeof require)try{require("./public/js/chartjs-adapter-date-fns.bundle.min.js")}catch(e){}const __="undefined"!=typeof wp&&wp.i18n&&wp.i18n.__?wp.i18n.__:e=>e;function isValidUrl(e){if(!e)return!1;try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}async function rtbcbRefreshNonce(){if("undefined"==typeof rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return!1;try{const e=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_get_nonce`);if(!e.ok)return!1;const t=await e.json();if(t&&t.success)return rtbcb_ajax.nonce=t.data||t.nonce||t,!0}catch(e){console.error("RTBCB: Nonce refresh failed",e)}return!1}"undefined"==typeof rtbcb_ajax||isValidUrl(rtbcb_ajax.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcb_ajax.ajax_url=ajaxurl),window.openBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&(e.classList.add("active"),document.body.style.overflow="hidden",window.businessCaseBuilder?window.businessCaseBuilder.reinitialize():window.businessCaseBuilder=new BusinessCaseBuilder)},window.closeBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&e.classList&&e.classList.remove&&e.classList.remove("active"),document.body&&document.body.style&&(document.body.style.overflow=""),window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.cancelPolling&&window.businessCaseBuilder.cancelPolling()},document.addEventListener("DOMContentLoaded",function(){try{document.getElementById("rtbcbForm")&&(window.businessCaseBuilder=new BusinessCaseBuilder)}catch(e){console.error("BusinessCaseBuilder initialization failed:",e)}});class BusinessCaseBuilder{constructor(){this.currentStep=1,this.totalSteps=5,this.form=document.getElementById("rtbcbForm"),this.overlay=document.getElementById("rtbcbModalOverlay"),this.ajaxUrl="undefined"!=typeof rtbcb_ajax&&isValidUrl(rtbcb_ajax.ajax_url)?rtbcb_ajax.ajax_url:"",this.pollTimeout=null,this.pollingCancelled=!1,this.activeJobId=null,this.progressStates=[],this.currentProgressIndex=0,this.progressTimer=null,this.form&&(this.handleNext=this.handleNext.bind(this),this.handlePrev=this.handlePrev.bind(this),this.handleSubmit=this.handleSubmit.bind(this),this.init())}init(){this.cacheElements(),this.bindEvents(),this.updateStepVisibility(),this.updateProgressIndicator(),this.restorePersistentState()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next"),this.prevBtn=this.form.querySelector(".rtbcb-nav-prev"),this.submitBtn=this.form.querySelector(".rtbcb-nav-submit"),this.steps=this.form.querySelectorAll(".rtbcb-wizard-step"),this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step"),this.progressLine=this.form.querySelector(".rtbcb-progress-line"),this.stepFields={1:["company_name","company_size","industry"],2:["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],3:["pain_points"],4:["business_objective","implementation_timeline","budget_range"],5:["email"]}}bindEvents(){this.nextBtn&&this.nextBtn.addEventListener("click",this.handleNext),this.prevBtn&&this.prevBtn.addEventListener("click",this.handlePrev),this.form.addEventListener("submit",this.handleSubmit),this.form.addEventListener("change",e=>{const t=e.target;if(t.matches('input[name="pain_points[]"]')){const e=t.closest(".rtbcb-pain-point-card");e&&e.classList.toggle("rtbcb-selected",t.checked);this.form.querySelectorAll('input[name="pain_points[]"]:checked').length>0&&this.clearStepError(3)}}),this.form.querySelectorAll("input, select").forEach(e=>{e.addEventListener("blur",()=>this.validateField(e)),e.addEventListener("input",()=>this.clearFieldError(e))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.overlay.classList.contains("active")&&window.closeBusinessCaseModal()})}saveFormData(e){try{const t=window.sessionStorage;if(!t)return;const s={};for(const[t,r]of e.entries())s[t]?Array.isArray(s[t])?s[t].push(r):s[t]=[s[t],r]:s[t]=r;t.setItem("rtbcbFormData",JSON.stringify(s))}catch(e){console.warn("RTBCB: Session storage unavailable",e)}}restorePersistentState(){try{const e=window.sessionStorage;if(!e)return;const t=e.getItem("rtbcbFormData");if(t)try{const e=JSON.parse(t);this.populateForm(e)}catch(e){}const s=e.getItem("rtbcbJobId");s&&(this.activeJobId=s,this.showLoading(),this.startProgressiveLoading(),this.pollingCancelled=!1,this.pollJob(s,Date.now(),0))}catch(e){console.warn("RTBCB: Session storage unavailable",e)}}populateForm(e){Object.entries(e).forEach(([e,t])=>{if(Array.isArray(t))t.forEach(t=>{const s=this.form.querySelector(`[name="${e}"][value="${t}"]`);s&&(s.checked=!0)});else{const s=this.form.querySelector(`[name="${e}"]`);if(!s)return;if("checkbox"===s.type)s.checked=!0;else if("radio"===s.type){const s=this.form.querySelector(`[name="${e}"][value="${t}"]`);s&&(s.checked=!0)}else s.value=t}})}clearPersistentState(){try{const e=window.sessionStorage;e&&(e.removeItem("rtbcbFormData"),e.removeItem("rtbcbJobId"))}catch(e){}}handleNext(e){e&&e.preventDefault&&e.preventDefault(),this.validateStep(this.currentStep)&&this.currentStep<this.totalSteps&&(this.currentStep++,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}handlePrev(e){e&&e.preventDefault&&e.preventDefault(),this.currentStep>1&&(this.currentStep--,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}validateStep(e){let t=!0;const s=this.stepFields[e];if(3===e){if(0===this.form.querySelectorAll('input[name="pain_points[]"]:checked').length)return this.showStepError(3,__("Please select at least one challenge","rtbcb")),!1;this.clearStepError(3)}else s.forEach(e=>{const s=this.form.querySelector(`[name="${e}"]`);s&&!this.validateField(s)&&(t=!1)});return t}validateField(e){const t=e.value.trim();let s=!0,r="";if(e.hasAttribute("required")&&!t&&(r=__("This field is required","rtbcb"),s=!1),"company_name"===e.name&&t&&(t.length<2?(r=__("Company name must be at least 2 characters","rtbcb"),s=!1):t.length>100?(r=__("Company name must be less than 100 characters","rtbcb"),s=!1):/^[^a-zA-Z]*$/.test(t)&&(r=__("Please enter a valid company name","rtbcb"),s=!1)),"email"===e.type&&t){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||(r=__("Please enter a valid email address","rtbcb"),s=!1)}return"number"===e.type&&t&&(Number.isFinite(Number(t))||(r=__("Please enter a valid number","rtbcb"),s=!1)),s?this.clearFieldError(e):this.showFieldError(e,r),s}showFieldError(e,t){const s=e.closest(".rtbcb-field");if(!s)return;this.clearFieldError(e),e.classList.add("rtbcb-field-invalid");const r=document.createElement("div");r.className="rtbcb-field-error",r.textContent=t,s.appendChild(r)}clearFieldError(e){const t=e.closest(".rtbcb-field");if(!t)return;e.classList.remove("rtbcb-field-invalid");const s=t.querySelector(".rtbcb-field-error");s&&s.remove()}showStepError(e,t){const s=this.steps[e-1];if(!s)return;const r=s.querySelector(".rtbcb-pain-points-validation");if(r){const e=r.querySelector(".rtbcb-validation-message");e&&(e.textContent=t,e.style.display="block",e.style.color="#ef4444")}}clearStepError(e){const t=this.steps[e-1];if(!t)return;const s=t.querySelector(".rtbcb-pain-points-validation");if(s){const e=s.querySelector(".rtbcb-validation-message");e&&(e.style.display="none")}}updateStepVisibility(){if(this.steps.forEach((e,t)=>{t+1===this.currentStep?(e.classList.add("active"),e.style.display="block"):(e.classList.remove("active"),e.style.display="none")}),this.prevBtn&&(this.prevBtn.style.display=1===this.currentStep?"none":"inline-flex"),this.currentStep===this.totalSteps?this.nextBtn&&(this.nextBtn.style.display="none"):this.nextBtn&&(this.nextBtn.style.display="inline-flex"),this.submitBtn){this.currentStep===this.totalSteps?(this.submitBtn.style.display="inline-flex",this.submitBtn.disabled=!1):(this.submitBtn.style.display="none",this.submitBtn.disabled=!0)}}updateProgressIndicator(){if(this.progressSteps.forEach((e,t)=>{const s=t+1;s<this.currentStep?(e.classList.add("completed"),e.classList.remove("active")):s===this.currentStep?(e.classList.add("active"),e.classList.remove("completed")):e.classList.remove("active","completed")}),this.progressLine){const e=this.currentStep/this.totalSteps*100;this.progressLine.style.width=`${e}%`}}scrollToTop(){const e=this.form.closest(".rtbcb-modal-body");e&&(e.scrollTop=0)}initializeProgressStates(){this.progressStates=[{step:"initializing",message:__("Initializing analysis...","rtbcb"),duration:2e3},{step:"collecting_data",message:__("Collecting your data...","rtbcb"),duration:3e3},{step:"calculating_roi",message:__("Calculating ROI scenarios...","rtbcb"),duration:8e3},{step:"analyzing_company",message:__("Analyzing company profile...","rtbcb"),duration:6e3},{step:"market_research",message:__("Researching market insights...","rtbcb"),duration:5e3},{step:"generating_recommendations",message:__("Generating recommendations...","rtbcb"),duration:1e4},{step:"finalizing",message:__("Finalizing your report...","rtbcb"),duration:5e3}],this.currentProgressIndex=0,this.progressTimer=null}startProgressiveLoading(){this.initializeProgressStates(),this.currentProgressIndex=0,this.showProgressState(this.progressStates[0]),this.scheduleNextProgressState()}showProgressState(e){const t=document.getElementById("rtbcb-progress-status");t&&(t.style.transition="opacity 0.3s ease",t.style.opacity="0.5",setTimeout(()=>{t.textContent=e.message,t.style.opacity="1",t.style.transform="scale(1.02)",setTimeout(()=>{t.style.transform="scale(1)"},200)},300),console.log(`RTBCB: Progress state: ${e.step} - ${e.message}`))}scheduleNextProgressState(){if(this.pollingCancelled)return;const e=this.progressStates[this.currentProgressIndex];e&&(this.progressTimer=setTimeout(()=>{if(this.currentProgressIndex++,this.currentProgressIndex<this.progressStates.length&&!this.pollingCancelled){const e=this.progressStates[this.currentProgressIndex];this.showProgressState(e),this.scheduleNextProgressState()}else this.pollingCancelled||(this.currentProgressIndex=Math.max(0,this.progressStates.length-3),this.scheduleNextProgressState())},e.duration))}cancelProgressiveLoading(){this.progressTimer&&(clearTimeout(this.progressTimer),this.progressTimer=null),this.currentProgressIndex=0}async handleSubmit(e){if(e&&e.preventDefault&&e.preventDefault(),this.validateStep(this.totalSteps))if(isValidUrl(this.ajaxUrl))try{console.log("RTBCB: Starting form submission"),this.showLoading(),this.startProgressiveLoading();const e=this.collectFormData();if(this.saveFormData(e),this.validateFormData(e),!isValidUrl(this.ajaxUrl))return void this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"));let t,s,r,n=0;for(;n<2;){if(t=await fetch(this.ajaxUrl,{method:"POST",body:e,credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json, text/html"}}),s=await t.text(),403===t.status&&0===n){if(await rtbcbRefreshNonce()){"function"==typeof e.set?e.set("rtbcb_nonce",rtbcb_ajax.nonce):e.append("rtbcb_nonce",rtbcb_ajax.nonce),n++;continue}return this.cancelProgressiveLoading(),void this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"})}break}if(console.log("RTBCB: Response status:",t.status),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);console.log("RTBCB: Response received, length:",s.length),console.log("RTBCB: Response received, length:",s.length);try{if(r=JSON.parse(s),console.log("RTBCB: Parsed JSON response:",r),"string"==typeof r)try{console.log("RTBCB: Response is a string, attempting second parse"),r=JSON.parse(r),console.log("RTBCB: Parsed stringified JSON response:",r)}catch(e){console.log("RTBCB: Failed to parse stringified JSON, attempting to clean");const t=r.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");r=JSON.parse(t),console.log("RTBCB: Parsed cleaned stringified JSON response:",r)}}catch(e){console.log("RTBCB: JSON parse failed, attempting to clean response");try{const e=s.replaceAll("\\/","/").replaceAll('\\"','"').replace(/(^"|"$)/g,"");r=JSON.parse(e),console.log("RTBCB: Parsed cleaned JSON response:",r)}catch(e){if(console.log("RTBCB: Response is not JSON, treating as HTML"),s.includes('<div class="rtbcb-enhanced-report"')||s.includes('<div class="rtbcb-report"'))return this.cancelProgressiveLoading(),void this.showEnhancedHTMLReport(s);throw new Error(__("Invalid response format","rtbcb"))}}if(r.success){const e=r.data||r;if(e.job_id){this.cancelPolling(),this.pollingCancelled=!1,this.activeJobId=e.job_id;try{window.sessionStorage&&window.sessionStorage.setItem("rtbcbJobId",e.job_id)}catch(e){}this.cancelProgressiveLoading(),this.pollJob(this.activeJobId,Date.now(),0)}else this.cancelProgressiveLoading(),e.report_html?this.handleSuccess(e):e.report_data?this.handleSuccess(e.report_data):this.handleSuccess(e)}else{const e=r.data||r;console.error("RTBCB: Error response:",e),this.cancelProgressiveLoading(),this.handleError(e||{message:__("Unknown error occurred","rtbcb")})}}catch(e){console.error("RTBCB: Submission error:",e),this.cancelProgressiveLoading(),this.handleError({message:e.message||__("An unexpected error occurred","rtbcb"),type:"submission_error"})}else this.showEnhancedError(__("Service unavailable. Please reload the page.","rtbcb"))}collectFormData(){const e=new FormData(this.form),t=new FormData,s=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],r=["fast_mode","report_type"];for(const[n,i]of e.entries())if(!r.includes(n))if(s.includes(n)){const e=parseFloat(i);t.append(n,Number.isFinite(e)?e:0)}else t.append(n,i);t.append("action","rtbcb_generate_case"),"undefined"!=typeof rtbcb_ajax&&rtbcb_ajax.nonce&&t.append("rtbcb_nonce",rtbcb_ajax.nonce);const n=this.form.querySelector('input[name="report_type"]:checked'),i=n?n.value:"basic";return t.append("report_type",i),t.append("fast_mode","fast"===i?"1":"0"),t}validateFormData(e){const t=t=>{if("function"==typeof e.get)return e.get(t);for(const[s,r]of e.entries())if(s===t)return r;return null},s=["email","company_name","company_size","industry","hours_reconciliation","hours_cash_positioning","num_banks","ftes","business_objective","implementation_timeline","budget_range"];for(const e of s)if(!t(e))throw new Error(`${__("Missing required field:","rtbcb")} ${e.replace("_"," ")}`);const r=t("email");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))throw new Error(__("Please enter a valid email address","rtbcb"));const n=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const e of n){const s=parseFloat(t(e));if(isNaN(s)||s<=0)throw new Error(`${e.replace("_"," ")} ${__("must be a positive number","rtbcb")}`)}if(0===(t=>{if("function"==typeof e.getAll)return e.getAll(t);const s=[];for(const[r,n]of e.entries())r===t&&s.push(n);return s})("pain_points[]").length)throw new Error(__("Please select at least one pain point","rtbcb"))}showLoading(){const e=document.querySelector(".rtbcb-modal-container");e&&(e.style.display="none");const t=document.getElementById("rtbcb-progress-container");if(t){const e=this.form.querySelector('[name="company_name"]')?.value||"your company",s=this.escapeHTML(e),r=!1!==window.rtbcb_ajax?.settings?.enable_ai_analysis?`Analyzing ${s}'s treasury operations...`:"Calculating ROI scenarios...";t.innerHTML=`\n                <div class="rtbcb-progress-content">\n                    <div class="rtbcb-progress-spinner"></div>\n                    \n                    <div class="rtbcb-progress-text">\n                        Generating Your Business Case\n                    </div>\n                    \n                    <div class="rtbcb-progress-step">\n                        <span class="rtbcb-progress-step-text" id="rtbcb-progress-status">\n                            ${r}\n                        </span>\n                    </div>\n                    \n                    <div class="rtbcb-progress-partial">\n                        <div id="rtbcb-partial-basic-roi" style="display: none;"></div>\n                        <div id="rtbcb-partial-category" style="display: none;"></div>\n                        <div id="rtbcb-partial-analysis" style="display: none;"></div>\n                    </div>\n                </div>\n            `,t.style.display="flex",t.classList.add("active"),document.body.style.overflow="hidden",t.setAttribute("role","dialog"),t.setAttribute("aria-label","Generating business case report"),t.setAttribute("aria-live","polite"),console.log("RTBCB: Progress overlay shown")}}hideLoading(){const e=document.getElementById("rtbcb-progress-container");e&&(e.style.display="none",e.classList.remove("active"),e.innerHTML="",e.removeAttribute("role"),e.removeAttribute("aria-label"),e.removeAttribute("aria-live")),document.body.style.overflow="";const t=document.querySelector(".rtbcb-modal-container");t&&(t.style.display="block");const s=this.form&&"function"==typeof this.form.closest?this.form.closest(".rtbcb-form-container"):null;s&&(s.style.display="block"),console.log("RTBCB: Progress overlay hidden")}cancelPolling(){this.pollingCancelled=!0,this.cancelProgressiveLoading(),this.pollTimeout&&(clearTimeout(this.pollTimeout),this.pollTimeout=null),this.clearPersistentState(),console.log("RTBCB: All polling and progress timers cancelled")}async pollJob(e,t=Date.now(),s=0){if(!this.pollingCancelled){if(Date.now()-t>12e5||s>600)return this.handleError({message:__("The request timed out after 20 minutes. Please try again later.","rtbcb"),type:"timeout"}),void this.cancelPolling();try{let r,n,i="undefined"!=typeof rtbcb_ajax&&rtbcb_ajax.nonce?rtbcb_ajax.nonce:"",o=0;for(;o<2;){if(r=await fetch(`${this.ajaxUrl}?action=rtbcb_job_status&job_id=${encodeURIComponent(e)}&rtbcb_nonce=${i}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}}),n=await r.text(),(403===r.status||n.includes("Security check failed"))&&0===o){if(await rtbcbRefreshNonce()){i=rtbcb_ajax.nonce,o++;continue}return this.cancelPolling(),this.hideLoading(),void this.handleError({message:__("Security validation failed. Please reload the page.","rtbcb"),type:"nonce_error"})}break}if(!r.ok)return this.cancelPolling(),void this.handleError({message:r.statusText,type:"polling_error"});const a=JSON.parse(n);if(!a.success)return this.handleError({message:__("Unable to retrieve job status","rtbcb"),type:"polling_error"}),void this.cancelPolling();const c=a.data||a,{status:l,step:d,message:b,percent:p}=c;console.log(`RTBCB: Job status: ${l} (attempt ${s})`),this.updateJobProgressStatus(c,s),this.updatePartialResults(c),"completed"===l?(this.cancelPolling(),this.showCompletionAnimation(()=>{this.hideLoading(),c.report_html?this.handleSuccess({report_html:c.report_html,report_data:c.report_data}):c.report_data?this.handleSuccess(c.report_data):this.handleError({message:__("Report data missing from completed job","rtbcb"),type:"job_error"})})):"error"===l?(this.cancelPolling(),this.hideLoading(),this.handleError({message:c.message||__("Job failed","rtbcb"),type:"job_error"})):"number"==typeof p&&p>=100?(this.cancelPolling(),this.showCompletionAnimation(()=>{this.hideLoading(),c.report_html?this.handleSuccess({report_html:c.report_html,report_data:c.report_data}):c.report_data?this.handleSuccess(c.report_data):this.handleError({message:"Report data missing from completed job",type:"job_error"})})):this.pollingCancelled||(this.pollTimeout=setTimeout(()=>this.pollJob(e,t,s+1),2e3))}catch(e){console.error("RTBCB: Job polling error:",e),this.cancelPolling(),this.handleError({message:e.message||"An unexpected error occurred",type:"polling_error"})}}}showCompletionAnimation(e){const t=document.getElementById("rtbcb-progress-status"),s=document.querySelector(".rtbcb-progress-spinner");t&&(t.textContent=__("Report completed successfully! ‚úì","rtbcb"),t.style.color="var(--success-green)",t.style.fontWeight="600"),s&&(s.style.borderTopColor="var(--success-green)",s.style.animation="rtbcb-spin 0.5s ease-out",setTimeout(()=>{s.style.display="none";const e=document.createElement("div");e.innerHTML="‚úì",e.style.cssText="\n                    font-size: 60px;\n                    color: var(--success-green);\n                    animation: rtbcb-bounce 0.6s ease-out;\n                    margin: 0 auto 24px;\n                    width: 60px;\n                    height: 60px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                ",s.parentNode.insertBefore(e,s)},500)),setTimeout(e,1500)}updateJobProgressStatus(e,t){const s=document.getElementById("rtbcb-progress-status");if(!s)return;const{status:r,step:n,message:i,percent:o}=e;let a="";if(n&&"processing"!==n)a=this.formatProgressStep(n);else if(i&&i.trim())a=this.formatProgressMessage(i);else{const e=s.textContent||__("Processing...","rtbcb");a=e}"number"==typeof o&&o>0&&o<100&&(a+=` (${Math.round(o)}%)`),a!==s.textContent&&(s.style.transition="opacity 0.2s ease",s.style.opacity="0.7",setTimeout(()=>{s.textContent=a,s.style.opacity="1"},200))}updatePartialResults(e){const t=document.getElementById("rtbcb-partial-basic-roi");if(e.basic_roi&&t){const s=e.basic_roi?.financial_analysis?.roi_scenarios?.base?.total_annual_benefit;"number"==typeof s&&s>0&&(t.innerHTML=`\n                    <strong>‚úì ROI Analysis Complete</strong><br>\n                    Projected Annual Benefit: $${this.formatNumber(s)}\n                `,t.style.display="block")}const s=document.getElementById("rtbcb-partial-category");e.category&&s&&(s.innerHTML=`\n                <strong>‚úì Solution Identified</strong><br>\n                Recommended: ${this.escapeHTML(e.category)}\n            `,s.style.display="block");const r=document.getElementById("rtbcb-partial-analysis");e.analysis_step&&r&&(r.innerHTML=`\n                <strong>‚úì AI Analysis</strong><br>\n                ${this.escapeHTML(e.analysis_step)}\n            `,r.style.display="block")}formatProgressStep(e){return{roi_calculation:__("Calculating ROI scenarios...","rtbcb"),category_recommendation:__("Identifying optimal solution category...","rtbcb"),rag_search:__("Researching market insights...","rtbcb"),ai_analysis:__("Generating AI-powered analysis...","rtbcb"),report_generation:__("Assembling your business case report...","rtbcb"),finalizing:__("Finalizing recommendations...","rtbcb")}[e]||e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())+"..."}formatProgressMessage(e){if(!e)return"";return e.replace(/\.+$/,"")+"..."}handleSuccess(e){this.clearPersistentState(),console.log("RTBCB: Success data received:",e),"string"!=typeof e?e.report_html&&e.report_html.trim()?this.showEnhancedHTMLReport(e.report_html):this.showResults(e):this.showEnhancedHTMLReport(e)}showEnhancedHTMLReport(e){console.log("RTBCB: Displaying enhanced HTML report"),this.hideLoading(),window.closeBusinessCaseModal();let t=document.getElementById("rtbcb-results-enhanced");if(t)console.log("RTBCB: Reusing existing results container");else{console.log("RTBCB: Creating results container"),t=document.createElement("div"),t.id="rtbcb-results-enhanced",t.className="rtbcb-enhanced-results-container";const e=document.getElementById("rtbcbModalOverlay");e&&e.parentNode?(e.parentNode.insertBefore(t,e.nextSibling),console.log("RTBCB: Results container inserted after modal")):(document.body.appendChild(t),console.log("RTBCB: Results container appended to body"))}console.log("RTBCB: Injecting report content"),t.innerHTML=e,t.style.display="block",this.initializeEnhancedReport(t),t.scrollIntoView({behavior:"smooth",block:"start"})}initializeEnhancedReport(e){this.initializeReportCharts(e),this.initializeCollapsibleSections(e),this.initializeInteractiveMetrics(e)}initializeReportCharts(e){if(window.rtbcb_ajax?.settings&&!1===window.rtbcb_ajax.settings.enable_charts)return void console.log("RTBCB: Charts disabled in settings");const t=e.querySelector("#rtbcb-roi-chart");if(t)if(console.log("RTBCB: Initializing ROI chart"),"undefined"!=typeof Chart)try{const s=this.extractROIDataFromReport(e);if(console.log("RTBCB: Extracted ROI data",s),!s||0===Object.keys(s).length)return void console.warn("RTBCB: ROI data is empty. Chart will not be rendered");this.createROIChart(t,s)}catch(e){console.error("Failed to initialize chart:",e)}else console.warn("RTBCB: Chart.js library is not available")}extractROIDataFromReport(e){const t={};return e.querySelectorAll(".rtbcb-scenario-card").forEach(e=>{const s=this.getScenarioNameFromCard(e);s&&(t[s]=this.extractMetricsFromCard(e))}),t}getScenarioNameFromCard(e){if(e.classList.contains("conservative"))return"conservative";if(e.classList.contains("base"))return"base";if(e.classList.contains("optimistic"))return"optimistic";const t=e.querySelector("h4");if(t){const e=t.textContent.toLowerCase();if(e.includes("conservative"))return"conservative";if(e.includes("base"))return"base";if(e.includes("optimistic"))return"optimistic"}return null}extractMetricsFromCard(e){const t={};return e.querySelectorAll(".rtbcb-scenario-metric").forEach(e=>{const s=e.querySelector(".rtbcb-metric-label"),r=e.querySelector(".rtbcb-metric-value");if(s&&r){const e=s.textContent.trim(),n=r.textContent.replace(/[$,]/g,"").trim(),i=parseFloat(n)||0;e.includes("Total Annual")?t.total_annual_benefit=i:e.includes("Labor")?t.labor_savings=i:e.includes("Fee")?t.fee_savings=i:e.includes("Error")&&(t.error_reduction=i)}}),t}createROIChart(e,t){console.log("RTBCB: Creating ROI chart");const s=e.getContext("2d");if(!s){if(console.error("RTBCB: Failed to get canvas context for ROI chart."),e.parentNode){const t=window.wp?.i18n?.__("Chart rendering failed","rtbcb")||"Chart rendering failed",s=document.createElement("p");s.textContent=t,s.classList.add("rtbcb-chart-error"),e.parentNode.insertBefore(s,e),e.remove()}return}const r={labels:["Labor Savings","Fee Savings","Error Reduction","Total Benefit"],datasets:[]},n={conservative:{bg:"rgba(239, 68, 68, 0.8)",border:"rgba(239, 68, 68, 1)"},base:{bg:"rgba(59, 130, 246, 0.8)",border:"rgba(59, 130, 246, 1)"},optimistic:{bg:"rgba(16, 185, 129, 0.8)",border:"rgba(16, 185, 129, 1)"}};Object.keys(t).forEach(e=>{const s=t[e],i=n[e]||n.base;r.datasets.push({label:this.formatScenarioLabel(e),data:[s.labor_savings||0,s.fee_savings||0,s.error_reduction||0,s.total_annual_benefit||0],backgroundColor:i.bg,borderColor:i.border,borderWidth:1})}),new Chart(s,{type:"bar",data:r,options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(new Intl.NumberFormat).format(e)}}}},plugins:{tooltip:{callbacks:{label:function(e){return e.dataset.label+": $"+(new Intl.NumberFormat).format(e.raw)}}},legend:{display:!0,position:"top"}}}}),console.log("RTBCB: ROI chart created")}formatScenarioLabel(e){switch(e){case"conservative":return"Conservative";case"base":return"Base Case";case"optimistic":return"Optimistic";default:return e.charAt(0).toUpperCase()+e.slice(1)}}initializeCollapsibleSections(e){e.querySelectorAll(".rtbcb-section-toggle").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-target"),t=document.getElementById(e),s=this.querySelector(".rtbcb-toggle-arrow"),r=this.querySelector(".rtbcb-toggle-text");if(t){const e="none"===t.style.display;t.style.display=e?"block":"none",s&&(s.textContent=e?"‚ñ≤":"‚ñº"),r&&(r.textContent=e?"Collapse":"Expand")}})})}initializeInteractiveMetrics(e){e.querySelectorAll(".rtbcb-metric-card").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("expanded")})})}showEnhancedError(e,t=null){this.hideLoading();const s=document.getElementById("rtbcb-progress-container");s&&(s.innerHTML=`\n                <div class="rtbcb-progress-content">\n                    <div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">\n                        ‚ö†Ô∏è\n                    </div>\n                    \n                    <div class="rtbcb-progress-text" style="color: #ef4444; margin-bottom: 16px;">\n                        Unable to Generate Report\n                    </div>\n                    \n                    <div class="rtbcb-progress-step">\n                        <span class="rtbcb-progress-step-text" style="color: #4b5563;">\n                            ${window.DOMPurify?DOMPurify.sanitize(e):this.escapeHTML(e)}\n                        </span>\n                    </div>\n                    \n                    ${t?`\n                    <details style="margin-top: 16px; text-align: left; width: 100%; max-width: 400px;">\n                        <summary style="cursor: pointer; color: #7c3aed; font-weight: 600; margin-bottom: 8px;">\n                            Technical Details\n                        </summary>\n                        <pre style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">\n                            ${this.escapeHTML(JSON.stringify(t,null,2))}\n                        </pre>\n                    </details>\n                    `:""}\n                    \n                    <div class="rtbcb-progress-partial" style="margin-top: 20px;">\n                        <button type="button" onclick="location.reload()"\n                                style="background: #7216f4; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 0 8px 8px 0;">\n                            Try Again\n                        </button>\n                        <a href="/request-processing/" target="_blank"\n                           style="background: #f3f4f6; color: #4b5563; border: none; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; margin: 0 8px 8px 0;">\n                            Request Processing\n                        </a>\n                    </div>\n                </div>\n            `,s.style.display="flex",s.classList.add("active"),s.setAttribute("role","alert"),s.setAttribute("aria-label","Error occurred"))}showResults(e){console.log("RTBCB: Processing structured data results"),this.hideLoading();const t=e.company_intelligence?.industry_context||e.industry_context||e.industry_insights||{},s={companyName:e.company_name||e.metadata?.company_name||"Your Company",scenarios:e.scenarios||e.financial_analysis?.roi_scenarios||{},recommendation:{category_info:e.recommendation?.category_info||e.technology_strategy?.category_details||{},confidence:e.recommendation?.confidence||e.metadata?.confidence_level||.75,reasoning:e.recommendation?.reasoning||e.technology_strategy?.recommended_category||""},executiveSummary:e.executive_summary||e.narrative||{},operationalAnalysis:e.operational_insights||e.operational_analysis||{},industryContext:{sector_analysis:t.sector_analysis||{},benchmarking:t.benchmarking||{},regulatory_landscape:t.regulatory_landscape||{}},nextActions:e.narrative?.next_actions||[...e.action_plan?.immediate_steps||[],...e.action_plan?.short_term_milestones||[],...e.action_plan?.long_term_objectives||[]],risks:e.risks||e.risk_analysis?.implementation_risks||[]};window.closeBusinessCaseModal();const r=document.getElementById("rtbcbResults");r?(r.innerHTML=this.renderResults(s),this.populateRiskAssessment(s.risks),r.style.display="block",r.scrollIntoView({behavior:"smooth",block:"start"})):(console.error("RTBCB: Results container not found"),this.showEnhancedError(__("Unable to display results. Please refresh the page.","rtbcb")))}renderResults(e){const{scenarios:t,recommendation:s,companyName:r,executiveSummary:n,operationalAnalysis:i,industryContext:o,nextActions:a}=e,c=r||"Your Company";return`\n            <div class="rtbcb-results-container">\n                <div class="rtbcb-results-header">\n                    <div class="rtbcb-results-badge">\n                        <span class="rtbcb-badge-icon">‚úì</span>\n                        Business Case Generated Successfully\n                    </div>\n                    <h2>${c} Treasury Technology Business Case</h2>\n                    <p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n                </div>\n\n                ${this.renderRecommendation(s,c)}\n                ${this.renderROISummary(t,c)}\n                ${this.renderExecutiveSummary(n)}\n                ${this.renderOperationalAnalysis(i)}\n${this.renderIndustryInsights(o)}\n                ${this.renderRiskAssessmentSection()}\n                ${this.renderNextSteps(a||[],c)}\n                ${this.renderActions()}\n            </div>\n        `}renderRecommendation(e,t){const s=e.category_info||{};return`\n            <div class="rtbcb-recommendation-card">\n                <div class="rtbcb-recommendation-header">\n                    <h3>Recommended Solution for ${t}</h3>\n                    <span class="rtbcb-confidence-badge">${Math.round(100*(e.confidence||.75))}% Confidence</span>\n                </div>\n                <div class="rtbcb-recommendation-name">${s.name||"Treasury Management System"}</div>\n                <div class="rtbcb-recommendation-description">\n                    ${s.description||"Modern treasury platform with automation and analytics"}\n                </div>\n                <div class="rtbcb-recommendation-reasoning">\n                    ${e.reasoning||`Based on ${t}'s profile, this solution best fits your needs.`}\n                </div>\n            </div>\n        `}renderROISummary(e,t){return`\n            <div class="rtbcb-roi-section">\n                <h3>${t} Projected Annual Benefits</h3>\n                <div class="rtbcb-roi-summary">\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Conservative</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.low?.total_annual_benefit||e.conservative?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">80% probability</div>\n                    </div>\n                    <div class="rtbcb-scenario rtbcb-scenario-base">\n                        <div class="rtbcb-scenario-label">Base Case</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.base?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Most likely outcome</div>\n                    </div>\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Optimistic</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.high?.total_annual_benefit||e.optimistic?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Best case scenario</div>\n                    </div>\n                </div>\n                ${this.renderBenefitBreakdown(e.base)}\n            </div>\n        `}renderBenefitBreakdown(e){if(!e)return"";const t=[{label:"Labor Savings",amount:e.labor_savings||0},{label:"Fee Reduction",amount:e.fee_savings||0},{label:"Error Prevention",amount:e.error_reduction||0}],s=e.total_annual_benefit||0;return`\n            <div class="rtbcb-benefit-breakdown">\n                <h4>Benefit Breakdown</h4>\n                <div class="rtbcb-chart-fallback">\n                    <div class="rtbcb-benefit-bars">\n                        ${t.map(e=>{const t=s>0?(e.amount/s*100).toFixed(0):0;return`\n                                <div class="rtbcb-benefit-bar">\n                                    <div class="rtbcb-benefit-bar-label">${e.label}</div>\n                                    <div class="rtbcb-benefit-bar-fill" style="width: ${t}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n                                        $${this.formatNumber(e.amount)}\n                                    </div>\n                                </div>\n                            `}).join("")}\n                    </div>\n                </div>\n            </div>\n        `}renderExecutiveSummary(e={}){const t=e?.narrative||e?.executive_recommendation||"Treasury technology investment presents a compelling opportunity for operational efficiency.",s=Array.isArray(e?.key_value_drivers)?e.key_value_drivers:[];return`\n            <div class="rtbcb-narrative-section">\n                <h3>Executive Summary</h3>\n                <div class="rtbcb-narrative-content">${this.escapeHTML(t)}</div>\n                ${s.length?`<div class="rtbcb-industry-group"><h4>Key Value Drivers</h4><ul>${(e=>e.map(e=>`<li>${this.escapeHTML(e)}</li>`).join(""))(s)}</ul></div>`:""}\n            </div>\n        `}renderOperationalAnalysis(e={}){const{current_state_assessment:t=[],process_improvements:s=[],automation_opportunities:r=[]}=e||{},n=Object.prototype.hasOwnProperty.call(e,"process_improvements"),i=Object.prototype.hasOwnProperty.call(e,"automation_opportunities"),o=Array.isArray(t)?t.some(e=>e):!!t;if(!o&&!n&&!i)return"";const a=e=>Array.isArray(e)?e.filter(e=>e&&"object"==typeof e?Object.values(e).some(e=>e):e):[];return`\n            <div class="rtbcb-operational-analysis">\n                <h3>Operational Analysis</h3>\n                ${o?(e=>{if(Array.isArray(e)){const t=a(e);return t.length?`<ul>${t.map(e=>`<li>${this.escapeHTML(e)}</li>`).join("")}</ul>`:`<p>${this.escapeHTML(__("No data provided"))}</p>`}return`<p>${this.escapeHTML(e)}</p>`})(t):""}\n                ${n?`<div class="rtbcb-industry-group"><h4>Process Improvements</h4><ul>${(e=>{const t=a(e);return t.length?t.map(e=>{if(e&&"object"==typeof e){const t=this.escapeHTML(e.process||e.process_area||""),s=this.escapeHTML(e.current_state||""),r=this.escapeHTML(e.improved_state||""),n=this.escapeHTML(e.impact||e.impact_level||"");let i="";return(s||r)&&(i+=`${s} ‚Üí ${r}`),n&&(i+=i?` (${n})`:`(${n})`),`<li><strong>${t}</strong>${i?`: ${i}`:""}</li>`}return`<li>${this.escapeHTML(e)}</li>`}).join(""):`<li>${this.escapeHTML(__("No data provided"))}</li>`})(s)}</ul></div>`:""}\n                ${i?`<div class="rtbcb-industry-group"><h4>Automation Opportunities</h4><ul>${(e=>{const t=a(e);return t.length?t.map(e=>{if(e&&"object"==typeof e){const t=this.escapeHTML(e.opportunity||""),s=this.escapeHTML(e.complexity||""),r=this.escapeHTML(e.savings||e.time_savings||""),n=[];s&&n.push(`${s} ${this.escapeHTML(__("complexity"))}`),r&&n.push(r);return`<li><strong>${t}</strong>${n.length?`: ${n.join(" ‚Üí ")}`:""}</li>`}return`<li>${this.escapeHTML(e)}</li>`}).join(""):`<li>${this.escapeHTML(__("No data provided"))}</li>`})(r)}</ul></div>`:""}\n            </div>\n        `}renderIndustryInsights(e={}){const{sector_analysis:t={},benchmarking:s={},regulatory_landscape:r={}}=e||{},{market_dynamics:n="",growth_trends:i="",disruption_factors:o=[],technology_adoption:a=""}=t,{typical_treasury_setup:c="",common_pain_points:l=[],investment_patterns:d=""}=s,{key_regulations:b=[],compliance_complexity:p="",upcoming_changes:u=[]}=r;if(!(n||i||0!==o.length||a||c||0!==l.length||d||0!==b.length||p||0!==u.length))return"";const h=e=>e.map(e=>`<li>${this.escapeHTML(e)}</li>`).join("");return`\n<div class="rtbcb-industry-insights">\n<h3>Industry Insights</h3>\n${n?`<div class="rtbcb-industry-group"><h4>Market Dynamics</h4><p>${this.escapeHTML(n)}</p></div>`:""}\n${i?`<div class="rtbcb-industry-group"><h4>Growth Trends</h4><p>${this.escapeHTML(i)}</p></div>`:""}\n${o.length?`<div class="rtbcb-industry-group"><h4>Disruption Factors</h4><ul>${h(o)}</ul></div>`:""}\n${a?`<div class="rtbcb-industry-group"><h4>Technology Adoption</h4><p>${this.escapeHTML(a)}</p></div>`:""}\n${c?`<div class="rtbcb-industry-group"><h4>Typical Treasury Setup</h4><p>${this.escapeHTML(c)}</p></div>`:""}\n${l.length?`<div class="rtbcb-industry-group"><h4>Common Pain Points</h4><ul>${h(l)}</ul></div>`:""}\n${d?`<div class="rtbcb-industry-group"><h4>Investment Patterns</h4><p>${this.escapeHTML(d)}</p></div>`:""}\n${b.length?`<div class="rtbcb-industry-group"><h4>Key Regulations</h4><ul>${h(b)}</ul></div>`:""}\n${p?`<div class="rtbcb-industry-group"><h4>Compliance Complexity</h4><p>${this.escapeHTML(p)}</p></div>`:""}\n${u.length?`<div class="rtbcb-industry-group"><h4>Upcoming Changes</h4><ul>${h(u)}</ul></div>`:""}\n</div>\n`}renderRiskAssessmentSection(){return'\n            <div class="rtbcb-risk-assessment">\n                <h3>Risk Assessment</h3>\n                <ul class="rtbcb-risk-list"></ul>\n            </div>\n        '}populateRiskAssessment(e){const t=document.querySelector(".rtbcb-risk-list");t&&(t.innerHTML="",(e||[]).forEach(e=>{const s=document.createElement("li");if(e&&"object"==typeof e){const t=Object.values(e).filter(Boolean);s.textContent=t.join(" - ")}else null!=e&&(s.textContent=String(e));t.appendChild(s)}))}renderNextSteps(e){e&&0!==e.length||(e=[__("Present business case to stakeholders","rtbcb"),__("Evaluate solution providers","rtbcb"),__("Develop implementation timeline","rtbcb"),__("Plan change management strategy","rtbcb")]);const t=e=>window.DOMPurify&&"function"==typeof window.DOMPurify.sanitize?window.DOMPurify.sanitize(e):this.escapeHTML(e);return`\n            <div class="rtbcb-next-steps">\n                <h3>${__("Recommended Next Steps","rtbcb")}</h3>\n                <div class="rtbcb-steps-grid">\n                    ${e.map((e,s)=>`\n                        <div class="rtbcb-step">\n                            <div class="rtbcb-step-number">${s+1}</div>\n                            <div class="rtbcb-step-content">\n                                <p>${t(e)}</p>\n                            </div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}renderActions(){return`\n            <div class="rtbcb-actions-section">\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n                    <span class="rtbcb-btn-icon">üìã</span>\n                    ${__("Copy HTML","rtbcb")}\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n                    <span class="rtbcb-btn-icon">üîÑ</span>\n                    ${__("Start Over","rtbcb")}\n                </button>\n            </div>\n        `}copyResultsHTML(){const e=document.querySelector(".rtbcb-results-container");e&&navigator.clipboard&&navigator.clipboard.writeText(e.innerHTML).then(()=>alert(__("Results HTML copied to clipboard","rtbcb"))).catch(e=>console.error("Copy failed:",e))}handleError(e){this.clearPersistentState();const t=e.message||__("An unexpected error occurred","rtbcb");console.group("RTBCB Error Details"),console.error("Message:",t),console.error("Type:",e.type),console.error("Debug Info:",e.debug_info),console.error("Timestamp:",e.timestamp),console.groupEnd(),this.showEnhancedError(this.getUserFriendlyMessage(t),e)}getUserFriendlyMessage(e){const t={"Security check failed":__("Session expired. Please refresh the page and try again.","rtbcb"),"OpenAI API key not configured":__("Service temporarily unavailable. Please try again later.","rtbcb"),"API connection failed":__("Unable to connect to analysis service. Please try again.","rtbcb"),"Missing required field":__("Please fill in all required fields.","rtbcb"),"Invalid email address":__("Please enter a valid email address.","rtbcb"),"request took longer than our 5-minute limit":__('Your request exceeded the 5-minute limit. Visit the <a href="/request-processing/" target="_blank">Request Processing page</a> or <a href="#" onclick="window.location.href=&apos;mailto:contact@realtreasury.com?subject=Business%20Case%20Request&apos;">request email delivery</a>.',"rtbcb"),"PHP error occurred":__("Server error encountered. Please try again.","rtbcb"),"Server returned invalid JSON response":__("Server communication error. Please try again.","rtbcb"),"Unexpected server response":__("Server communication error. Please try again.","rtbcb"),"Job not found":__("Unable to locate your report request. Please resubmit the form.","rtbcb")};for(const[s,r]of Object.entries(t))if(e.includes(s))return r;return __("An error occurred while processing your request. Please try again.","rtbcb")}escapeHTML(e){const t=document.createElement("div");return t.textContent=null==e?"":String(e),t.innerHTML}formatNumber(e){return"number"!=typeof e||isNaN(e)?"0":new Intl.NumberFormat("en-US",{maximumFractionDigits:0,minimumFractionDigits:0}).format(e)}reinitialize(){this.currentStep=1,this.updateStepVisibility(),this.updateProgressIndicator()}}