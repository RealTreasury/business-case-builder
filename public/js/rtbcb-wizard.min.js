window.openBusinessCaseModal=function(){const overlay=document.getElementById("rtbcbModalOverlay");if(overlay){overlay.classList.add("active");document.body.style.overflow="hidden";if(window.businessCaseBuilder){window.businessCaseBuilder.reinitialize()}else{window.businessCaseBuilder=new BusinessCaseBuilder}}};window.closeBusinessCaseModal=function(){const overlay=document.getElementById("rtbcbModalOverlay");if(overlay){overlay.classList.remove("active");document.body.style.overflow=""}};document.addEventListener("DOMContentLoaded",function(){try{if(document.getElementById("rtbcbForm")){window.businessCaseBuilder=new BusinessCaseBuilder}}catch(error){console.error("BusinessCaseBuilder initialization failed:",error)}});class BusinessCaseBuilder{constructor(){this.currentStep=1;this.totalSteps=5;this.form=document.getElementById("rtbcbForm");this.overlay=document.getElementById("rtbcbModalOverlay");if(!this.form)return;this.init()}init(){this.cacheElements();this.bindEvents();this.updateStepVisibility();this.updateProgressIndicator()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next");this.prevBtn=this.form.querySelector(".rtbcb-nav-prev");this.submitBtn=this.form.querySelector(".rtbcb-nav-submit");this.steps=this.form.querySelectorAll(".rtbcb-wizard-step");this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step");this.stepFields={1:["company_name","company_size","industry"],2:["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],3:["pain_points"],4:["business_objective","implementation_timeline","budget_range"],5:["email"]}}bindEvents(){if(this.nextBtn){this.nextBtn.addEventListener("click",e=>{e.preventDefault();this.handleNext()})}if(this.prevBtn){this.prevBtn.addEventListener("click",e=>{e.preventDefault();this.handlePrev()})}this.form.addEventListener("submit",e=>{e.preventDefault();if(this.validateStep(this.totalSteps)){try{this.handleSubmit()}catch(error){console.error("RTBCB: handleSubmit error:",error);this.showError("An unexpected error occurred. Please try again.")}}});const painPointCards=this.form.querySelectorAll(".rtbcb-pain-point-card");painPointCards.forEach(card=>{const checkbox=card.querySelector('input[type="checkbox"]');if(checkbox){checkbox.addEventListener("change",()=>{card.classList.toggle("rtbcb-selected",checkbox.checked);const checkedBoxes=this.form.querySelectorAll('input[name="pain_points[]"]:checked');if(checkedBoxes.length>0){this.clearStepError(3)}})}});this.form.querySelectorAll("input, select").forEach(field=>{field.addEventListener("blur",()=>this.validateField(field));field.addEventListener("input",()=>this.clearFieldError(field))});document.addEventListener("keydown",e=>{if(e.key==="Escape"&&this.overlay.classList.contains("active")){window.closeBusinessCaseModal()}})}handleNext(){if(this.validateStep(this.currentStep)){if(this.currentStep<this.totalSteps){this.currentStep++;this.updateStepVisibility();this.updateProgressIndicator();this.scrollToTop();this.updateStepVisibility()}}}handlePrev(){if(this.currentStep>1){this.currentStep--;this.updateStepVisibility();this.updateProgressIndicator();this.scrollToTop()}}validateStep(stepNumber){let isValid=true;const fieldsToValidate=this.stepFields[stepNumber];if(stepNumber===3){const checkedBoxes=this.form.querySelectorAll('input[name="pain_points[]"]:checked');if(checkedBoxes.length===0){this.showStepError(3,"Please select at least one challenge");return false}this.clearStepError(3)}else{fieldsToValidate.forEach(fieldName=>{const field=this.form.querySelector(`[name="${fieldName}"]`);if(field&&!this.validateField(field)){isValid=false}})}return isValid}showFieldWarning(field,message){const fieldContainer=field.closest(".rtbcb-field");if(!fieldContainer)return;const existingWarning=fieldContainer.querySelector(".rtbcb-field-warning");if(existingWarning){existingWarning.remove()}const warningEl=document.createElement("div");warningEl.className="rtbcb-field-warning";warningEl.textContent=message;warningEl.style.color="#f59e0b";warningEl.style.fontSize="12px";warningEl.style.marginTop="4px";fieldContainer.appendChild(warningEl)}validateField(field){const value=field.value.trim();let isValid=true;let errorMessage="";if(field.hasAttribute("required")&&!value){errorMessage="This field is required";isValid=false}if(field.name==="company_name"&&value){if(value.length<2){errorMessage="Company name must be at least 2 characters";isValid=false}else if(value.length>100){errorMessage="Company name must be less than 100 characters";isValid=false}else if(/^[^a-zA-Z]*$/.test(value)){errorMessage="Please enter a valid company name";isValid=false}}if(field.type==="email"&&value){const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(value)){errorMessage="Please enter a valid email address";isValid=false}const domain=value.split("@")[1]?.toLowerCase();const consumerDomains=["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com"];if(domain&&consumerDomains.includes(domain)){this.showFieldWarning(field,"Consider using your business email for better results")}}if(field.type==="number"&&value){if(!Number.isFinite(Number(value))){errorMessage="Please enter a valid number";isValid=false}}if(!isValid){this.showFieldError(field,errorMessage)}else{this.clearFieldError(field)}return isValid}showFieldError(field,message){const fieldContainer=field.closest(".rtbcb-field");if(!fieldContainer)return;this.clearFieldError(field);field.classList.add("rtbcb-field-invalid");const errorEl=document.createElement("div");errorEl.className="rtbcb-field-error";errorEl.textContent=message;fieldContainer.appendChild(errorEl)}clearFieldError(field){const fieldContainer=field.closest(".rtbcb-field");if(!fieldContainer)return;field.classList.remove("rtbcb-field-invalid");const existingError=fieldContainer.querySelector(".rtbcb-field-error");if(existingError){existingError.remove()}}showStepError(stepNumber,message){const step=this.steps[stepNumber-1];if(!step)return;const validationDiv=step.querySelector(".rtbcb-pain-points-validation");if(validationDiv){const messageDiv=validationDiv.querySelector(".rtbcb-validation-message");if(messageDiv){messageDiv.textContent=message;messageDiv.style.display="block";messageDiv.style.color="#ef4444"}}}clearStepError(stepNumber){const step=this.steps[stepNumber-1];if(!step)return;const validationDiv=step.querySelector(".rtbcb-pain-points-validation");if(validationDiv){const messageDiv=validationDiv.querySelector(".rtbcb-validation-message");if(messageDiv){messageDiv.style.display="none"}}}updateStepVisibility(){this.steps.forEach((step,index)=>{const stepNum=index+1;if(stepNum===this.currentStep){step.classList.add("active");step.style.display="block"}else{step.classList.remove("active");step.style.display="none"}});if(this.prevBtn){this.prevBtn.style.display=this.currentStep===1?"none":"inline-flex"}if(this.currentStep===this.totalSteps){if(this.nextBtn){this.nextBtn.style.display="none"}}else{if(this.nextBtn){this.nextBtn.style.display="inline-flex"}}if(this.submitBtn){const isLastStep=this.currentStep===this.totalSteps;if(isLastStep){let stepsValid=true;for(let i=1;i<this.currentStep;i++){if(!this.validateStep(i)){stepsValid=false;break}}this.submitBtn.style.display=stepsValid?"inline-flex":"none";this.submitBtn.disabled=!stepsValid}else{this.submitBtn.style.display="none";this.submitBtn.disabled=true}}}updateProgressIndicator(){this.progressSteps.forEach((step,index)=>{const stepNum=index+1;if(stepNum<this.currentStep){step.classList.add("completed");step.classList.remove("active")}else if(stepNum===this.currentStep){step.classList.add("active");step.classList.remove("completed")}else{step.classList.remove("active","completed")}})}scrollToTop(){const modalBody=this.form.closest(".rtbcb-modal-body");if(modalBody){modalBody.scrollTop=0}}async handleSubmit(){this.showProgress();if(typeof rtbcbAjax==="undefined"||!rtbcbAjax.ajax_url){this.showError("Unable to submit form. Please refresh the page and try again.");return}const formData=new FormData;const rawData=new FormData(this.form);const numericFields=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const[key,value]of rawData.entries()){if(numericFields.includes(key)){const numValue=Number(value);formData.append(key,Number.isFinite(numValue)?numValue:0)}else{formData.append(key,value)}}formData.append("action","rtbcb_generate_case");formData.append("rtbcb_nonce",rtbcbAjax.nonce);console.log("RTBCB: Submitting form data:",Object.fromEntries(formData));try{const response=await fetch(rtbcbAjax.ajax_url,{method:"POST",body:formData});let result;try{result=await response.json()}catch(e){throw new Error("Invalid server response")}if(response.ok){if(result&&result.success){console.log("RTBCB: Business case generated successfully");this.showResults(result.data)}else{const errorMessage=result?.data?.message||"Failed to generate business case";const error=new Error(errorMessage);if(result?.data?.error_code){error.code=result.data.error_code}throw error}}else{let errorMessage=result?.data?.message;if(!errorMessage){if(response.status>=500){errorMessage="Server error. Please try again later."}else if(response.status>=400){errorMessage="Invalid input. Please check your entries and try again."}else{errorMessage="Server responded with status "+response.status}}const error=new Error(errorMessage);error.status=response.status;if(result?.data?.error_code){error.code=result.data.error_code}throw error}}catch(error){console.error("RTBCB: Submission error details:",{message:error.message,stack:error.stack,type:error.constructor.name,code:error.code||error.error_code});let displayMessage=error.name==="TypeError"?"Network error. Please check your connection and try again.":error.message;const errorCode=error.code||error.error_code;if(errorCode){displayMessage+=` (Error code: ${errorCode})`}displayMessage+=" Please check your AI configuration or try again later.";this.showError(displayMessage)}}showProgress(){const formContainer=this.form.closest(".rtbcb-form-container");if(formContainer){formContainer.style.display="none"}const companyName=this.form.querySelector('[name="company_name"]')?.value||"your company";const progressHTML=`\n            <div class="rtbcb-progress-overlay" style="position: relative; background: none;">\n                <div class="rtbcb-progress-content">\n                    <div class="rtbcb-progress-spinner"></div>\n                    <div class="rtbcb-progress-text">Generating Your Business Case</div>\n                    <div class="rtbcb-progress-step">\n                        <span class="rtbcb-progress-step-text">Analyzing ${companyName}'s treasury operations...</span>\n                    </div>\n                </div>\n            </div>\n        `;const modalBody=this.form.closest(".rtbcb-modal-body");if(modalBody){modalBody.insertAdjacentHTML("beforeend",progressHTML)}}showResults(data){window.closeBusinessCaseModal();const resultsContainer=document.getElementById("rtbcbResults");if(resultsContainer){resultsContainer.innerHTML=this.renderResults(data);this.populateRiskAssessment(data.narrative?.risks||[]);resultsContainer.style.display="block";resultsContainer.scrollIntoView({behavior:"smooth",block:"start"})}}renderResults(data){const{scenarios:scenarios,recommendation:recommendation,company_name:company_name}=data;const narrative=data.narrative||{};const displayName=company_name||"Your Company";return`\n            <div class="rtbcb-results-container">\n                <div class="rtbcb-results-header">\n                    <div class="rtbcb-results-badge">\n                        <span class="rtbcb-badge-icon">✓</span>\n                        Business Case Generated Successfully\n                    </div>\n                    <h2>${displayName} Treasury Technology Business Case</h2>\n                    <p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n                </div>\n\n                ${this.renderRecommendation(recommendation,displayName)}\n                ${this.renderROISummary(scenarios,displayName)}\n                ${this.renderNarrative(narrative)}\n                ${this.renderRiskAssessmentSection()}\n                ${this.renderNextSteps(narrative?.next_actions||[],displayName)}\n                ${this.renderActions()}\n            </div>\n        `}renderRecommendation(recommendation,companyName){const category=recommendation.category_info||{};const confidence=Math.round((recommendation.confidence||.75)*100);return`\n            <div class="rtbcb-recommendation-card">\n                <div class="rtbcb-recommendation-header">\n                    <h3>Recommended Solution for ${companyName}</h3>\n                    <span class="rtbcb-confidence-badge">${confidence}% Confidence</span>\n                </div>\n                <div class="rtbcb-recommendation-name">${category.name||"Treasury Management System"}</div>\n                <div class="rtbcb-recommendation-description">\n                    ${category.description||"Modern treasury platform with automation and analytics"}\n                </div>\n                <div class="rtbcb-recommendation-reasoning">\n                    ${recommendation.reasoning||`Based on ${companyName}'s profile, this solution best fits your needs.`}\n                </div>\n            </div>\n        `}renderROISummary(scenarios,companyName){return`\n            <div class="rtbcb-roi-section">\n                <h3>${companyName} Projected Annual Benefits</h3>\n                <div class="rtbcb-roi-summary">\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Conservative</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.low?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">80% probability</div>\n                    </div>\n                    <div class="rtbcb-scenario rtbcb-scenario-base">\n                        <div class="rtbcb-scenario-label">Base Case</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.base?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Most likely outcome</div>\n                    </div>\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Optimistic</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(scenarios.high?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Best case scenario</div>\n                    </div>\n                </div>\n                ${this.renderBenefitBreakdown(scenarios.base)}\n            </div>\n        `}renderBenefitBreakdown(scenario){if(!scenario)return"";const benefits=[{label:"Labor Savings",amount:scenario.labor_savings||0},{label:"Fee Reduction",amount:scenario.fee_savings||0},{label:"Error Prevention",amount:scenario.error_reduction||0}];const total=scenario.total_annual_benefit||0;return`\n            <div class="rtbcb-benefit-breakdown">\n                <h4>Benefit Breakdown</h4>\n                <div class="rtbcb-chart-fallback">\n                    <div class="rtbcb-benefit-bars">\n                        ${benefits.map(b=>{const percentage=total>0?(b.amount/total*100).toFixed(0):0;return`\n                                <div class="rtbcb-benefit-bar">\n                                    <div class="rtbcb-benefit-bar-label">${b.label}</div>\n                                    <div class="rtbcb-benefit-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n                                        $${this.formatNumber(b.amount)}\n                                    </div>\n                                </div>\n                            `}).join("")}\n                    </div>\n                </div>\n            </div>\n        `}renderNarrative(narrative={}){return`\n            <div class="rtbcb-narrative-section">\n                <h3>Executive Summary</h3>\n                <div class="rtbcb-narrative-content">\n                    ${narrative?.narrative||"Treasury technology investment presents a compelling opportunity for operational efficiency."}\n                </div>\n            </div>\n        `}renderRiskAssessmentSection(){return`\n            <div class="rtbcb-risk-assessment">\n                <h3>Risk Assessment</h3>\n                <ul class="rtbcb-risk-list"></ul>\n            </div>\n        `}populateRiskAssessment(risks){const list=document.querySelector(".rtbcb-risk-list");if(!list)return;list.innerHTML="";(risks||[]).forEach(risk=>{const item=document.createElement("li");if(risk&&typeof risk==="object"){const values=Object.values(risk).filter(Boolean);item.textContent=values.join(" - ")}else if(risk!=null){item.textContent=String(risk)}list.appendChild(item)})}renderNextSteps(steps){if(!steps||steps.length===0){steps=["Present business case to stakeholders","Evaluate solution providers","Develop implementation timeline","Plan change management strategy"]}return`\n            <div class="rtbcb-next-steps">\n                <h3>Recommended Next Steps</h3>\n                <div class="rtbcb-steps-grid">\n                    ${steps.map((step,index)=>`\n                        <div class="rtbcb-step">\n                            <div class="rtbcb-step-number">${index+1}</div>\n                            <div class="rtbcb-step-content">\n                                <p>${step}</p>\n                            </div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}copyResultsHTML(){const container=document.querySelector(".rtbcb-results-container");if(!container||!navigator.clipboard){return}navigator.clipboard.writeText(container.innerHTML).then(()=>alert("Results HTML copied to clipboard")).catch(err=>console.error("Copy failed:",err))}renderActions(){return`\n            <div class="rtbcb-actions-section">\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.print()">\n                    <span class="rtbcb-btn-icon">🖨️</span>\n                    Print Results\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n                    <span class="rtbcb-btn-icon">📋</span>\n                    Copy HTML\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n                    <span class="rtbcb-btn-icon">🔄</span>\n                    Start Over\n                </button>\n            </div>\n        `}showError(message){const progressOverlay=document.querySelector(".rtbcb-progress-overlay");if(progressOverlay){progressOverlay.remove()}const modalBody=this.form.closest(".rtbcb-modal-body");if(modalBody){const safeMessage=this.escapeHTML(message);const errorHTML=`\n                <div class="rtbcb-error-container" style="padding: 40px; text-align: center;">\n                    <div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>\n                    <h3 style="color: #ef4444; margin-bottom: 16px;">Unable to Generate Business Case</h3>\n                    <p style="color: #4b5563; margin-bottom: 24px;">${safeMessage}</p>\n                    <div class="rtbcb-error-actions">\n                        <button type="button" class="rtbcb-action-btn rtbcb-btn-primary" onclick="location.reload()">\n                            Try Again\n                        </button>\n                        <a href="mailto:contact@realtreasury.com" class="rtbcb-action-btn rtbcb-btn-secondary" style="text-decoration: none;">\n                            Contact Support\n                        </a>\n                    </div>\n                </div>\n            `;modalBody.innerHTML=errorHTML}}escapeHTML(str){const div=document.createElement("div");div.textContent=str==null?"":String(str);return div.innerHTML}formatNumber(num){return new Intl.NumberFormat("en-US").format(Math.round(num))}reinitialize(){this.currentStep=1;this.updateStepVisibility();this.updateProgressIndicator()}}