window.openBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&(e.classList.add("active"),document.body.style.overflow="hidden",window.businessCaseBuilder?window.businessCaseBuilder.reinitialize():window.businessCaseBuilder=new BusinessCaseBuilder)},window.closeBusinessCaseModal=function(){const e=document.getElementById("rtbcbModalOverlay");e&&(e.classList.remove("active"),document.body.style.overflow="")},document.addEventListener("DOMContentLoaded",function(){try{document.getElementById("rtbcbForm")&&(window.businessCaseBuilder=new BusinessCaseBuilder)}catch(e){console.error("BusinessCaseBuilder initialization failed:",e)}});class BusinessCaseBuilder{constructor(){this.currentStep=1,this.totalSteps=5,this.form=document.getElementById("rtbcbForm"),this.overlay=document.getElementById("rtbcbModalOverlay"),this.form&&this.init()}init(){this.cacheElements(),this.bindEvents(),this.updateStepVisibility(),this.updateProgressIndicator()}cacheElements(){this.nextBtn=this.form.querySelector(".rtbcb-nav-next"),this.prevBtn=this.form.querySelector(".rtbcb-nav-prev"),this.submitBtn=this.form.querySelector(".rtbcb-nav-submit"),this.steps=this.form.querySelectorAll(".rtbcb-wizard-step"),this.progressSteps=this.form.querySelectorAll(".rtbcb-progress-step"),this.progressLine=this.form.querySelector(".rtbcb-progress-line"),this.stepFields={1:["company_name","company_size","industry"],2:["hours_reconciliation","hours_cash_positioning","num_banks","ftes"],3:["pain_points"],4:["business_objective","implementation_timeline","budget_range"],5:["email"]}}bindEvents(){this.nextBtn&&this.nextBtn.addEventListener("click",e=>{e.preventDefault(),this.handleNext()}),this.prevBtn&&this.prevBtn.addEventListener("click",e=>{e.preventDefault(),this.handlePrev()}),this.form.addEventListener("submit",e=>{if(e.preventDefault(),this.validateStep(this.totalSteps))try{this.handleSubmit()}catch(e){console.error("RTBCB: handleSubmit error:",e),this.showError("An unexpected error occurred. Please try again.")}});this.form.querySelectorAll(".rtbcb-pain-point-card").forEach(e=>{const t=e.querySelector('input[type="checkbox"]');t&&t.addEventListener("change",()=>{e.classList.toggle("rtbcb-selected",t.checked);this.form.querySelectorAll('input[name="pain_points[]"]:checked').length>0&&this.clearStepError(3)})}),this.form.querySelectorAll("input, select").forEach(e=>{e.addEventListener("blur",()=>this.validateField(e)),e.addEventListener("input",()=>this.clearFieldError(e))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.overlay.classList.contains("active")&&window.closeBusinessCaseModal()})}handleNext(){this.validateStep(this.currentStep)&&this.currentStep<this.totalSteps&&(this.currentStep++,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop(),this.updateStepVisibility())}handlePrev(){this.currentStep>1&&(this.currentStep--,this.updateStepVisibility(),this.updateProgressIndicator(),this.scrollToTop())}validateStep(e){let t=!0;const s=this.stepFields[e];if(3===e){if(0===this.form.querySelectorAll('input[name="pain_points[]"]:checked').length)return this.showStepError(3,"Please select at least one challenge"),!1;this.clearStepError(3)}else s.forEach(e=>{const s=this.form.querySelector(`[name="${e}"]`);s&&!this.validateField(s)&&(t=!1)});return t}showFieldWarning(e,t){const s=e.closest(".rtbcb-field");if(!s)return;const n=s.querySelector(".rtbcb-field-warning");n&&n.remove();const r=document.createElement("div");r.className="rtbcb-field-warning",r.textContent=t,r.style.color="#f59e0b",r.style.fontSize="12px",r.style.marginTop="4px",s.appendChild(r)}validateField(e){const t=e.value.trim();let s=!0,n="";if(e.hasAttribute("required")&&!t&&(n="This field is required",s=!1),"company_name"===e.name&&t&&(t.length<2?(n="Company name must be at least 2 characters",s=!1):t.length>100?(n="Company name must be less than 100 characters",s=!1):/^[^a-zA-Z]*$/.test(t)&&(n="Please enter a valid company name",s=!1)),"email"===e.type&&t){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)||(n="Please enter a valid email address",s=!1);const r=t.split("@")[1]?.toLowerCase();r&&["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com"].includes(r)&&this.showFieldWarning(e,"Consider using your business email for better results")}return"number"===e.type&&t&&(Number.isFinite(Number(t))||(n="Please enter a valid number",s=!1)),s?this.clearFieldError(e):this.showFieldError(e,n),s}showFieldError(e,t){const s=e.closest(".rtbcb-field");if(!s)return;this.clearFieldError(e),e.classList.add("rtbcb-field-invalid");const n=document.createElement("div");n.className="rtbcb-field-error",n.textContent=t,s.appendChild(n)}clearFieldError(e){const t=e.closest(".rtbcb-field");if(!t)return;e.classList.remove("rtbcb-field-invalid");const s=t.querySelector(".rtbcb-field-error");s&&s.remove()}showStepError(e,t){const s=this.steps[e-1];if(!s)return;const n=s.querySelector(".rtbcb-pain-points-validation");if(n){const e=n.querySelector(".rtbcb-validation-message");e&&(e.textContent=t,e.style.display="block",e.style.color="#ef4444")}}clearStepError(e){const t=this.steps[e-1];if(!t)return;const s=t.querySelector(".rtbcb-pain-points-validation");if(s){const e=s.querySelector(".rtbcb-validation-message");e&&(e.style.display="none")}}updateStepVisibility(){if(this.steps.forEach((e,t)=>{t+1===this.currentStep?(e.classList.add("active"),e.style.display="block"):(e.classList.remove("active"),e.style.display="none")}),this.prevBtn&&(this.prevBtn.style.display=1===this.currentStep?"none":"inline-flex"),this.currentStep===this.totalSteps?this.nextBtn&&(this.nextBtn.style.display="none"):this.nextBtn&&(this.nextBtn.style.display="inline-flex"),this.submitBtn){if(this.currentStep===this.totalSteps){let e=!0;for(let t=1;t<this.currentStep;t++)if(!this.validateStep(t)){e=!1;break}this.submitBtn.style.display=e?"inline-flex":"none",this.submitBtn.disabled=!e}else this.submitBtn.style.display="none",this.submitBtn.disabled=!0}}updateProgressIndicator(){if(this.progressSteps.forEach((e,t)=>{const s=t+1;s<this.currentStep?(e.classList.add("completed"),e.classList.remove("active")):s===this.currentStep?(e.classList.add("active"),e.classList.remove("completed")):e.classList.remove("active","completed")}),this.progressLine){const e=this.currentStep/this.totalSteps*100;this.progressLine.style.width=`${e}%`}}scrollToTop(){const e=this.form.closest(".rtbcb-modal-body");e&&(e.scrollTop=0)}async handleSubmit(e){if(this.showProgress(),"undefined"==typeof rtbcbAjax||!rtbcbAjax.ajax_url)return void this.showError("Unable to submit form. Please refresh the page and try again.");let t;if(e instanceof FormData){t=new FormData;for(const[s,n]of e.entries())t.append(s,n)}else{t=new FormData;const e=new FormData(this.form),s=["hours_reconciliation","hours_cash_positioning","num_banks","ftes"];for(const[n,r]of e.entries())if(s.includes(n)){const e=Number(r);t.append(n,Number.isFinite(e)?e:0)}else t.append(n,r);t.append("action","rtbcb_generate_case"),t.append("rtbcb_nonce",rtbcbAjax.nonce)}this.lastFormData=t,console.log("RTBCB: Submitting form data:",Object.fromEntries(t));try{const e=await fetch(rtbcbAjax.ajax_url,{method:"POST",body:t}),s=e.headers&&"function"==typeof e.headers.get?e.headers.get("x-request-id"):null,n=(new Date).toISOString();if(504===e.status||e.status>=500){const t=new Error("Server timeout");throw t.status=e.status,t.requestId=s,t.timestamp=n,t}let r;try{r=await e.clone().json()}catch(t){const s=await e.text();throw console.warn("RTBCB: Unexpected server response:",s),new Error("Unexpected server response")}if(!e.ok){let t=r?.data?.message;t||(t=e.status>=500?"Server error. Please try again later.":e.status>=400?"Invalid input. Please check your entries and try again.":"Server responded with status "+e.status);const s=new Error(t);throw s.status=e.status,r?.data?.error_code&&(s.code=r.data.error_code),s}if(!r||!r.success){const e=new Error(r?.data?.message||"Failed to generate business case");throw r?.data?.error_code&&(e.code=r.data.error_code),e}console.log("RTBCB: Business case generated successfully"),this.showResults(r.data)}catch(e){if(console.error("RTBCB: Submission error details:",{message:e.message,stack:e.stack,type:e.constructor.name,code:e.code||e.error_code}),504===e.status||e.status&&e.status>=500)return void this.showTimeoutError("Server timeout—please retry or contact support",{requestId:e.requestId,timestamp:e.timestamp||(new Date).toISOString()});let t;t="TypeError"===e.name?"Network error. Please check your connection and try again.":e.message;const s=e.code||e.error_code;s&&(t+=` (Error code: ${s})`),t+=" Please check your AI configuration or try again later.",this.showError(t)}}showProgress(){const e=this.form.closest(".rtbcb-form-container");e&&(e.style.display="none");const t=`\n            <div class="rtbcb-progress-overlay" style="position: relative; background: none;">\n                <div class="rtbcb-progress-content">\n                    <div class="rtbcb-progress-spinner"></div>\n                    <div class="rtbcb-progress-text">Generating Your Business Case</div>\n                    <div class="rtbcb-progress-step">\n                        <span class="rtbcb-progress-step-text">Analyzing ${this.form.querySelector('[name="company_name"]')?.value||"your company"}'s treasury operations...</span>\n                    </div>\n                </div>\n            </div>\n        `,s=this.form.closest(".rtbcb-modal-body");s&&s.insertAdjacentHTML("beforeend",t)}showResults(e){window.closeBusinessCaseModal();const t=document.getElementById("rtbcbResults");t&&(t.innerHTML=this.renderResults(e),this.populateRiskAssessment(e.narrative?.risks||[]),t.style.display="block",t.scrollIntoView({behavior:"smooth",block:"start"}))}renderResults(e){const{scenarios:t,recommendation:s,company_name:n}=e,r=e.narrative||{},i=n||"Your Company";return`\n            <div class="rtbcb-results-container">\n                <div class="rtbcb-results-header">\n                    <div class="rtbcb-results-badge">\n                        <span class="rtbcb-badge-icon">✓</span>\n                        Business Case Generated Successfully\n                    </div>\n                    <h2>${i} Treasury Technology Business Case</h2>\n                    <p class="rtbcb-results-subtitle">Personalized ROI analysis and strategic recommendations</p>\n                </div>\n\n                ${this.renderRecommendation(s,i)}\n                ${this.renderROISummary(t,i)}\n                ${this.renderNarrative(r)}\n                ${this.renderRiskAssessmentSection()}\n                ${this.renderNextSteps(r?.next_actions||[],i)}\n                ${this.renderActions()}\n            </div>\n        `}renderRecommendation(e,t){const s=e.category_info||{};return`\n            <div class="rtbcb-recommendation-card">\n                <div class="rtbcb-recommendation-header">\n                    <h3>Recommended Solution for ${t}</h3>\n                    <span class="rtbcb-confidence-badge">${Math.round(100*(e.confidence||.75))}% Confidence</span>\n                </div>\n                <div class="rtbcb-recommendation-name">${s.name||"Treasury Management System"}</div>\n                <div class="rtbcb-recommendation-description">\n                    ${s.description||"Modern treasury platform with automation and analytics"}\n                </div>\n                <div class="rtbcb-recommendation-reasoning">\n                    ${e.reasoning||`Based on ${t}'s profile, this solution best fits your needs.`}\n                </div>\n            </div>\n        `}renderROISummary(e,t){return`\n            <div class="rtbcb-roi-section">\n                <h3>${t} Projected Annual Benefits</h3>\n                <div class="rtbcb-roi-summary">\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Conservative</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.low?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">80% probability</div>\n                    </div>\n                    <div class="rtbcb-scenario rtbcb-scenario-base">\n                        <div class="rtbcb-scenario-label">Base Case</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.base?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Most likely outcome</div>\n                    </div>\n                    <div class="rtbcb-scenario">\n                        <div class="rtbcb-scenario-label">Optimistic</div>\n                        <div class="rtbcb-scenario-amount">$${this.formatNumber(e.high?.total_annual_benefit||0)}</div>\n                        <div class="rtbcb-scenario-confidence">Best case scenario</div>\n                    </div>\n                </div>\n                ${this.renderBenefitBreakdown(e.base)}\n            </div>\n        `}renderBenefitBreakdown(e){if(!e)return"";const t=[{label:"Labor Savings",amount:e.labor_savings||0},{label:"Fee Reduction",amount:e.fee_savings||0},{label:"Error Prevention",amount:e.error_reduction||0}],s=e.total_annual_benefit||0;return`\n            <div class="rtbcb-benefit-breakdown">\n                <h4>Benefit Breakdown</h4>\n                <div class="rtbcb-chart-fallback">\n                    <div class="rtbcb-benefit-bars">\n                        ${t.map(e=>{const t=s>0?(e.amount/s*100).toFixed(0):0;return`\n                                <div class="rtbcb-benefit-bar">\n                                    <div class="rtbcb-benefit-bar-label">${e.label}</div>\n                                    <div class="rtbcb-benefit-bar-fill" style="width: ${t}%; background: linear-gradient(90deg, #7216f4, #8f47f6);">\n                                        $${this.formatNumber(e.amount)}\n                                    </div>\n                                </div>\n                            `}).join("")}\n                    </div>\n                </div>\n            </div>\n        `}renderNarrative(e={}){return`\n            <div class="rtbcb-narrative-section">\n                <h3>Executive Summary</h3>\n                <div class="rtbcb-narrative-content">\n                    ${e?.narrative||"Treasury technology investment presents a compelling opportunity for operational efficiency."}\n                </div>\n            </div>\n        `}renderRiskAssessmentSection(){return'\n            <div class="rtbcb-risk-assessment">\n                <h3>Risk Assessment</h3>\n                <ul class="rtbcb-risk-list"></ul>\n            </div>\n        '}populateRiskAssessment(e){const t=document.querySelector(".rtbcb-risk-list");t&&(t.innerHTML="",(e||[]).forEach(e=>{const s=document.createElement("li");if(e&&"object"==typeof e){const t=Object.values(e).filter(Boolean);s.textContent=t.join(" - ")}else null!=e&&(s.textContent=String(e));t.appendChild(s)}))}renderNextSteps(e){return e&&0!==e.length||(e=["Present business case to stakeholders","Evaluate solution providers","Develop implementation timeline","Plan change management strategy"]),`\n            <div class="rtbcb-next-steps">\n                <h3>Recommended Next Steps</h3>\n                <div class="rtbcb-steps-grid">\n                    ${e.map((e,t)=>`\n                        <div class="rtbcb-step">\n                            <div class="rtbcb-step-number">${t+1}</div>\n                            <div class="rtbcb-step-content">\n                                <p>${e}</p>\n                            </div>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}copyResultsHTML(){const e=document.querySelector(".rtbcb-results-container");e&&navigator.clipboard&&navigator.clipboard.writeText(e.innerHTML).then(()=>alert("Results HTML copied to clipboard")).catch(e=>console.error("Copy failed:",e))}renderActions(){return'\n            <div class="rtbcb-actions-section">\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.print()">\n                    <span class="rtbcb-btn-icon">🖨️</span>\n                    Print Results\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="window.businessCaseBuilder.copyResultsHTML()">\n                    <span class="rtbcb-btn-icon">📋</span>\n                    Copy HTML\n                </button>\n                <button type="button" class="rtbcb-action-btn rtbcb-btn-secondary" onclick="location.reload()">\n                    <span class="rtbcb-btn-icon">🔄</span>\n                    Start Over\n                </button>\n            </div>\n        '}showTimeoutError(e,t={}){const s=document.querySelector(".rtbcb-progress-overlay");s&&s.remove();const n=this.form.closest(".rtbcb-form-container"),r=n?n.parentNode:this.form.parentNode,i=this.escapeHTML(e),o=t.requestId?`<div>Request ID: ${this.escapeHTML(t.requestId)}</div>`:"",a=t.timestamp?`<div>Timestamp: ${this.escapeHTML(t.timestamp)}</div>`:"",c=`\n            <div class="rtbcb-error-overlay" style="padding: 40px; text-align: center;">\n                <div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>\n                <h3 style="color: #ef4444; margin-bottom: 16px;">Server Timeout</h3>\n                <p style="color: #4b5563; margin-bottom: 24px;">${i}</p>\n                ${o||a?`<div class="rtbcb-error-diagnostics" style="color: #6b7280; margin-bottom: 24px;">${o}${a}</div>`:""}\n                <div class="rtbcb-error-actions">\n                    <button type="button" class="rtbcb-action-btn rtbcb-btn-primary rtbcb-retry-btn">Retry</button>\n                    <a href="mailto:contact@realtreasury.com" class="rtbcb-action-btn rtbcb-btn-secondary" style="text-decoration: none;">Contact Support</a>\n                </div>\n            </div>\n        `;r.insertAdjacentHTML("afterbegin",c);const l=r.querySelector(".rtbcb-retry-btn");l&&l.addEventListener("click",()=>{l.disabled=!0;const e=r.querySelector(".rtbcb-error-overlay");e&&e.remove(),setTimeout(()=>this.handleSubmit(this.lastFormData),1e3)})}showError(e){const t=document.querySelector(".rtbcb-progress-overlay");t&&t.remove();const s=this.form.closest(".rtbcb-modal-body");if(s){const t=`\n                <div class="rtbcb-error-container" style="padding: 40px; text-align: center;">\n                    <div class="rtbcb-error-icon" style="font-size: 48px; color: #ef4444; margin-bottom: 20px;">⚠️</div>\n                    <h3 style="color: #ef4444; margin-bottom: 16px;">Unable to Generate Business Case</h3>\n                    <p style="color: #4b5563; margin-bottom: 24px;">${this.escapeHTML(e)}</p>\n                    <div class="rtbcb-error-actions">\n                        <button type="button" class="rtbcb-action-btn rtbcb-btn-primary" onclick="location.reload()">\n                            Try Again\n                        </button>\n                        <a href="mailto:contact@realtreasury.com" class="rtbcb-action-btn rtbcb-btn-secondary" style="text-decoration: none;">\n                            Contact Support\n                        </a>\n                    </div>\n                </div>\n            `;s.innerHTML=t}}escapeHTML(e){const t=document.createElement("div");return t.textContent=null==e?"":String(e),t.innerHTML}formatNumber(e){return new Intl.NumberFormat("en-US").format(Math.round(e))}reinitialize(){this.currentStep=1,this.updateStepVisibility(),this.updateProgressIndicator()}}