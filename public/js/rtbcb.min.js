function handleSubmissionError(e,t){console.error("Submission Error:",t?t+": "+e:e);const r=document.getElementById("rtbcb-progress-container");if(r){r.style.display="block",r.innerHTML="";const a=e=>e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]));if("function"==typeof document.createElement){const a=document.createElement("div");a.className="rtbcb-error-content";const n=document.createElement("h3");n.style.color="#dc3545",n.textContent="Generation Failed";const o=document.createElement("p");o.textContent="We're sorry, but we couldn't generate your business case. Please try again later.";const i=document.createElement("p");i.style.fontSize="0.9em",i.style.color="#6c757d",i.style.marginTop="15px";const s=document.createElement("strong");s.textContent="Error Details:",i.appendChild(s),t&&i.appendChild(document.createTextNode(" ["+t+"]")),i.appendChild(document.createTextNode(" "+e)),a.appendChild(n),a.appendChild(o),a.appendChild(i),"function"==typeof r.appendChild?r.appendChild(a):r.innerHTML=a.outerHTML}else r.innerHTML='<div class="rtbcb-error-content"><h3 style="color: #dc3545;">Generation Failed</h3><p>We\'re sorry, but we couldn\'t generate your business case. Please try again later.</p><p style="font-size: 0.9em; color: #6c757d; margin-top: 15px;"><strong>Error Details:</strong> '+(t?"["+a(t)+"] ":"")+a(e)+"</p></div>"}}function isValidUrl(e){if(!e)return!1;try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}"undefined"==typeof rtbcb_ajax||isValidUrl(rtbcb_ajax.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcb_ajax.ajax_url=ajaxurl);let rtbcbIsSubmitting=!1;async function handleSubmit(e){if(e.preventDefault(),!(window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.handleSubmit||rtbcbIsSubmitting)){if(rtbcbIsSubmitting=!0,"undefined"==typeof rtbcb_ajax)return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var t=e.target,r=new FormData(t);r.append("action","rtbcb_generate_case"),rtbcb_ajax.nonce&&r.append("rtbcb_nonce",rtbcb_ajax.nonce);var a=document.getElementById("rtbcb-progress-container"),n=document.querySelector(".rtbcb-form-container");if(n&&(n.style.display="none"),a){var o=a.querySelector(".rtbcb-progress-text");rtbcb_ajax&&rtbcb_ajax.strings&&rtbcb_ajax.strings.generating&&(o?o.textContent=rtbcb_ajax.strings.generating:a.textContent=rtbcb_ajax.strings.generating),a.style.display="block"}if(!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var i,s,c,b="function"==typeof r.entries?Object.fromEntries(r.entries()):{};console.log("RTBCB: Submitting form data:",b);try{if(!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);i=await fetch(rtbcb_ajax.ajax_url,{method:"POST",body:r}),s=await i.text()}catch(e){return handleSubmissionError("Network error. Please try again later.",""),void(rtbcbIsSubmitting=!1)}if(!i.ok){var l="Server responded with status "+i.status+".",d="";try{var u=JSON.parse(s);l=u.data&&u.data.message?u.data.message:l,d=u.data&&u.data.error_code?u.data.error_code:""}catch(e){console.error("Could not parse error response as JSON.",e),l=s||l}return handleSubmissionError(l,d),void(rtbcbIsSubmitting=!1)}try{c=JSON.parse(s)}catch(e){return handleSubmissionError("Invalid server response.",""),void(rtbcbIsSubmitting=!1)}if(!c.success||!c.data||!c.data.job_id)return handleSubmissionError(l=c.data&&c.data.message?c.data.message:"An unknown error occurred.",d=c.data&&c.data.error_code?c.data.error_code:""),void(rtbcbIsSubmitting=!1);pollJobStatus(c.data.job_id,a,n)}}async function pollJobStatus(e,t,r){try{if(!rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);const n=rtbcb_ajax.nonce?rtbcb_ajax.nonce:"",o=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_job_status&job_id=${encodeURIComponent(e)}&rtbcb_nonce=${n}`),i=await o.json();if(!i.success)return handleSubmissionError("Unable to retrieve job status.",""),void(rtbcbIsSubmitting=!1);const s=i.data,c=s.status;if("completed"===c){if(t){var a=t.querySelector(".rtbcb-progress-text");rtbcb_ajax&&rtbcb_ajax.strings&&rtbcb_ajax.strings.email_confirmation&&(a?a.textContent=rtbcb_ajax.strings.email_confirmation:t.textContent=rtbcb_ajax.strings.email_confirmation),setTimeout(()=>{t.style.display="none",r&&(r.style.display="block")},3e3)}rtbcbIsSubmitting=!1}else"error"===c?(handleSubmissionError(s.message||"Job failed.",""),rtbcbIsSubmitting=!1):setTimeout(()=>pollJobStatus(e,t,r),2e3)}catch(e){handleSubmissionError("Network error. Please try again later.",""),rtbcbIsSubmitting=!1}}async function rtbcbStreamAnalysis(e,t){if(!rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return void handleSubmissionError("Service unavailable. Please reload the page.","");e.append("action","rtbcb_stream_analysis"),rtbcb_ajax.nonce&&e.append("rtbcb_nonce",rtbcb_ajax.nonce);const r=(await fetch(rtbcb_ajax.ajax_url,{method:"POST",body:e})).body.getReader(),a=new TextDecoder;for(;;){const{value:e,done:n}=await r.read();if(n)break;const o=a.decode(e);"function"==typeof t&&t(o)}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("rtbcbForm");e&&e.addEventListener("submit",handleSubmit)}),window.rtbcbStreamAnalysis=rtbcbStreamAnalysis;