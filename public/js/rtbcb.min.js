function handleSubmissionError(e,t){console.error("Submission Error:",t?t+": "+e:e);const r=document.getElementById("rtbcb-progress-container");if(r){r.style.display="block",r.innerHTML="";const a=e=>e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]));if("function"==typeof document.createElement){const a=document.createElement("div");a.className="rtbcb-error-content";const n=document.createElement("h3");n.style.color="#dc3545",n.textContent="Generation Failed";const o=document.createElement("p");o.textContent="We're sorry, but we couldn't generate your business case. Please try again later.";const i=document.createElement("p");i.style.fontSize="0.9em",i.style.color="#6c757d",i.style.marginTop="15px";const c=document.createElement("strong");c.textContent="Error Details:",i.appendChild(c),t&&i.appendChild(document.createTextNode(" ["+t+"]")),i.appendChild(document.createTextNode(" "+e)),a.appendChild(n),a.appendChild(o),a.appendChild(i),"function"==typeof r.appendChild?r.appendChild(a):r.innerHTML=a.outerHTML}else r.innerHTML='<div class="rtbcb-error-content"><h3 style="color: #dc3545;">Generation Failed</h3><p>We\'re sorry, but we couldn\'t generate your business case. Please try again later.</p><p style="font-size: 0.9em; color: #6c757d; margin-top: 15px;"><strong>Error Details:</strong> '+(t?"["+a(t)+"] ":"")+a(e)+"</p></div>"}}function isValidUrl(e){if(!e)return!1;try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}async function rtbcbRefreshNonce(){if("undefined"==typeof rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return!1;try{const e=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_get_nonce`);if(!e.ok)return!1;const t=await e.json();if(t&&t.success)return rtbcb_ajax.nonce=t.data||t.nonce||t,!0}catch(e){console.error("RTBCB: Nonce refresh failed",e)}return!1}"undefined"==typeof rtbcb_ajax||isValidUrl(rtbcb_ajax.ajax_url)||"undefined"!=typeof ajaxurl&&isValidUrl(ajaxurl)&&(rtbcb_ajax.ajax_url=ajaxurl);let rtbcbIsSubmitting=!1;async function handleSubmit(e){if(e.preventDefault(),!(window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.handleSubmit||rtbcbIsSubmitting)){if(rtbcbIsSubmitting=!0,"undefined"==typeof rtbcb_ajax)return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var t=e.target,r=new FormData(t);r.append("action","rtbcb_generate_case"),rtbcb_ajax.nonce&&r.append("rtbcb_nonce",rtbcb_ajax.nonce);var a=t.querySelector('input[name="report_type"]:checked'),n=a?a.value:"basic";r.append("report_type",n),r.append("fast_mode","fast"===n?"1":"0");var o=document.getElementById("rtbcb-progress-container"),i=document.querySelector(".rtbcb-form-container");if(i&&(i.style.display="none"),o){var c=o.querySelector(".rtbcb-progress-text");rtbcb_ajax&&rtbcb_ajax.strings&&rtbcb_ajax.strings.generating&&(c?c.textContent=rtbcb_ajax.strings.generating:o.textContent=rtbcb_ajax.strings.generating),o.style.display="block"}if(!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var s,b,l="function"==typeof r.entries?Object.fromEntries(r.entries()):{};console.log("RTBCB: Submitting form data:",l);for(var d,u=0;u<2;){try{if(!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);s=await fetch(rtbcb_ajax.ajax_url,{method:"POST",body:r}),b=await s.text()}catch(e){return handleSubmissionError("Network error. Please try again later.",""),void(rtbcbIsSubmitting=!1)}if((403===s.status||b.includes("Security check failed"))&&0===u){if(await rtbcbRefreshNonce()){r.set("rtbcb_nonce",rtbcb_ajax.nonce),u++;continue}return handleSubmissionError("Security validation failed. Please reload the page.",""),void(rtbcbIsSubmitting=!1)}break}if(!s.ok){var m="Server responded with status "+s.status+".",p="";try{var f=JSON.parse(b);m=f.data&&f.data.message?f.data.message:m,p=f.data&&f.data.error_code?f.data.error_code:""}catch(e){console.error("Could not parse error response as JSON.",e),m=b||m}return handleSubmissionError(m,p),void(rtbcbIsSubmitting=!1)}try{d=JSON.parse(b)}catch(e){return handleSubmissionError("Invalid server response.",""),void(rtbcbIsSubmitting=!1)}if(!d.success||!d.data||!d.data.job_id)return handleSubmissionError(m=d.data&&d.data.message?d.data.message:"An unknown error occurred.",p=d.data&&d.data.error_code?d.data.error_code:""),void(rtbcbIsSubmitting=!1);pollJobStatus(d.data.job_id,o,i)}}async function pollJobStatus(e,t,r){try{if(!rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);let n,o,i=rtbcb_ajax.nonce?rtbcb_ajax.nonce:"",c=0;for(;c<2;){if(n=await fetch(`${rtbcb_ajax.ajax_url}?action=rtbcb_job_status&job_id=${encodeURIComponent(e)}&rtbcb_nonce=${i}`),o=await n.text(),(403===n.status||o.includes("Security check failed"))&&0===c){if(await rtbcbRefreshNonce()){i=rtbcb_ajax.nonce,c++;continue}return handleSubmissionError("Security validation failed. Please reload the page.",""),void(rtbcbIsSubmitting=!1)}break}const s=JSON.parse(o);if(!s.success)return handleSubmissionError("Unable to retrieve job status.",""),void(rtbcbIsSubmitting=!1);const b=s.data||s,l=b.status;if("completed"===l){if(t){var a=t.querySelector(".rtbcb-progress-text");rtbcb_ajax&&rtbcb_ajax.strings&&rtbcb_ajax.strings.email_confirmation&&(a?a.textContent=rtbcb_ajax.strings.email_confirmation:t.textContent=rtbcb_ajax.strings.email_confirmation),setTimeout(()=>{t.style.display="none",r&&(r.style.display="block")},3e3)}rtbcbIsSubmitting=!1}else"error"===l?(handleSubmissionError(b.message||"Job failed.",""),rtbcbIsSubmitting=!1):setTimeout(()=>pollJobStatus(e,t,r),2e3)}catch(e){handleSubmissionError("Network error. Please try again later.",""),rtbcbIsSubmitting=!1}}async function rtbcbStreamAnalysis(e,t){if(!rtbcb_ajax||!isValidUrl(rtbcb_ajax.ajax_url))return void handleSubmissionError("Service unavailable. Please reload the page.","");let r;e.append("action","rtbcb_stream_analysis"),rtbcb_ajax.nonce&&e.append("rtbcb_nonce",rtbcb_ajax.nonce);let a=0;for(;a<2;){if(r=await fetch(rtbcb_ajax.ajax_url,{method:"POST",body:e}),403===r.status&&0===a){if(await rtbcbRefreshNonce()){e.set("rtbcb_nonce",rtbcb_ajax.nonce),a++;continue}return void handleSubmissionError("Security validation failed. Please reload the page.","")}break}const n=r.body.getReader(),o=new TextDecoder;for(;;){const{value:e,done:r}=await n.read();if(r)break;const a=o.decode(e);"function"==typeof t&&t(a)}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("rtbcbForm");e&&e.addEventListener("submit",handleSubmit)}),window.rtbcbStreamAnalysis=rtbcbStreamAnalysis;