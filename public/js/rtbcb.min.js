function handleSubmissionError(t,e){console.error("Submission Error:",e?e+": "+t:t);const r=document.getElementById("rtbcb-progress-container");if(r){r.style.display="block",r.innerHTML="";const n=t=>t.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]));if("function"==typeof document.createElement){const n=document.createElement("div");n.className="rtbcb-error-content";const a=document.createElement("h3");a.style.color="#dc3545",a.textContent="Generation Failed";const o=document.createElement("p");o.textContent="We're sorry, but we couldn't generate your business case. Please try again later.";const s=document.createElement("p");s.style.fontSize="0.9em",s.style.color="#6c757d",s.style.marginTop="15px";const i=document.createElement("strong");i.textContent="Error Details:",s.appendChild(i),e&&s.appendChild(document.createTextNode(" ["+e+"]")),s.appendChild(document.createTextNode(" "+t)),n.appendChild(a),n.appendChild(o),n.appendChild(s),"function"==typeof r.appendChild?r.appendChild(n):r.innerHTML=n.outerHTML}else r.innerHTML='<div class="rtbcb-error-content"><h3 style="color: #dc3545;">Generation Failed</h3><p>We\'re sorry, but we couldn\'t generate your business case. Please try again later.</p><p style="font-size: 0.9em; color: #6c757d; margin-top: 15px;"><strong>Error Details:</strong> '+(e?"["+n(e)+"] ":"")+n(t)+"</p></div>"}}let rtbcbIsSubmitting=!1;async function handleSubmit(t){if(t.preventDefault(),!(window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.handleSubmit||rtbcbIsSubmitting)){rtbcbIsSubmitting=!0;var e=t.target,r=new FormData(e);r.append("action","rtbcb_generate_case"),r.append("rtbcb_nonce",rtbcbAjax.nonce);var n=document.getElementById("rtbcb-progress-container"),a=document.querySelector(".rtbcb-form-container");if(a&&(a.style.display="none"),n){var o=n.querySelector(".rtbcb-progress-text");rtbcbAjax&&rtbcbAjax.strings&&rtbcbAjax.strings.generating&&(o?o.textContent=rtbcbAjax.strings.generating:n.textContent=rtbcbAjax.strings.generating),n.style.display="block"}if("undefined"==typeof rtbcbAjax||!rtbcbAjax.ajax_url)return handleSubmissionError("Unable to submit form. Please refresh the page and try again.",""),void(rtbcbIsSubmitting=!1);var s,i,c,b="function"==typeof r.entries?Object.fromEntries(r.entries()):{};console.log("RTBCB: Submitting form data:",b);try{s=await fetch(rtbcbAjax.ajax_url,{method:"POST",body:r}),i=await s.text()}catch(t){return handleSubmissionError("Network error. Please try again later.",""),void(rtbcbIsSubmitting=!1)}if(!s.ok){var d="Server responded with status "+s.status+".",l="";try{var u=JSON.parse(i);d=u.data&&u.data.message?u.data.message:d,l=u.data&&u.data.error_code?u.data.error_code:""}catch(t){console.error("Could not parse error response as JSON.",t),d=i||d}return handleSubmissionError(d,l),void(rtbcbIsSubmitting=!1)}try{c=JSON.parse(i)}catch(t){return handleSubmissionError("Invalid server response.",""),void(rtbcbIsSubmitting=!1)}if(!c.success||!c.data||!c.data.job_id)return handleSubmissionError(d=c.data&&c.data.message?c.data.message:"An unknown error occurred.",l=c.data&&c.data.error_code?c.data.error_code:""),void(rtbcbIsSubmitting=!1);pollJobStatus(c.data.job_id,n,a)}}async function pollJobStatus(t,e,r){try{const a=await fetch(`${rtbcbAjax.ajax_url}?action=rtbcb_job_status&job_id=${encodeURIComponent(t)}&rtbcb_nonce=${rtbcbAjax.nonce}`),o=await a.json();if(!o.success)return handleSubmissionError("Unable to retrieve job status.",""),void(rtbcbIsSubmitting=!1);const s=o.data.status;if("completed"===s){if(e){var n=e.querySelector(".rtbcb-progress-text");rtbcbAjax&&rtbcbAjax.strings&&rtbcbAjax.strings.email_confirmation&&(n?n.textContent=rtbcbAjax.strings.email_confirmation:e.textContent=rtbcbAjax.strings.email_confirmation),setTimeout(()=>{e.style.display="none",r&&(r.style.display="block")},3e3)}rtbcbIsSubmitting=!1}else"error"===s?(handleSubmissionError(o.data.message||"Job failed.",""),rtbcbIsSubmitting=!1):setTimeout(()=>pollJobStatus(t,e,r),2e3)}catch(t){handleSubmissionError("Network error. Please try again later.",""),rtbcbIsSubmitting=!1}}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("rtbcbForm");t&&t.addEventListener("submit",handleSubmit)});