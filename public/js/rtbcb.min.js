function handleSubmissionError(e,t){console.error("Submission Error:",t?t+": "+e:e);const r=document.getElementById("rtbcb-progress-container");if(r){r.style.display="block",r.innerHTML="";const n=e=>e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]));if("function"==typeof document.createElement){const n=document.createElement("div");n.className="rtbcb-error-content";const a=document.createElement("h3");a.style.color="#dc3545",a.textContent="Generation Failed";const o=document.createElement("p");o.textContent="We're sorry, but we couldn't generate your business case. Please try again later.";const i=document.createElement("p");i.style.fontSize="0.9em",i.style.color="#6c757d",i.style.marginTop="15px";const s=document.createElement("strong");s.textContent="Error Details:",i.appendChild(s),t&&i.appendChild(document.createTextNode(" ["+t+"]")),i.appendChild(document.createTextNode(" "+e)),n.appendChild(a),n.appendChild(o),n.appendChild(i),"function"==typeof r.appendChild?r.appendChild(n):r.innerHTML=n.outerHTML}else r.innerHTML='<div class="rtbcb-error-content"><h3 style="color: #dc3545;">Generation Failed</h3><p>We\'re sorry, but we couldn\'t generate your business case. Please try again later.</p><p style="font-size: 0.9em; color: #6c757d; margin-top: 15px;"><strong>Error Details:</strong> '+(t?"["+n(t)+"] ":"")+n(e)+"</p></div>"}}function isValidUrl(e){if(!e)return!1;try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}let rtbcbIsSubmitting=!1;async function handleSubmit(e){if(e.preventDefault(),!(window.businessCaseBuilder&&"function"==typeof window.businessCaseBuilder.handleSubmit||rtbcbIsSubmitting)){if(rtbcbIsSubmitting=!0,"undefined"==typeof rtbcbAjax)return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var t=e.target,r=new FormData(t);r.append("action","rtbcb_generate_case"),rtbcbAjax.nonce&&r.append("rtbcb_nonce",rtbcbAjax.nonce);var n=document.getElementById("rtbcb-progress-container"),a=document.querySelector(".rtbcb-form-container");if(a&&(a.style.display="none"),n){var o=n.querySelector(".rtbcb-progress-text");rtbcbAjax&&rtbcbAjax.strings&&rtbcbAjax.strings.generating&&(o?o.textContent=rtbcbAjax.strings.generating:n.textContent=rtbcbAjax.strings.generating),n.style.display="block"}if(!isValidUrl(rtbcbAjax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);var i,s,c,b="function"==typeof r.entries?Object.fromEntries(r.entries()):{};console.log("RTBCB: Submitting form data:",b);try{if(!isValidUrl(rtbcbAjax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);i=await fetch(rtbcbAjax.ajax_url,{method:"POST",body:r}),s=await i.text()}catch(e){return handleSubmissionError("Network error. Please try again later.",""),void(rtbcbIsSubmitting=!1)}if(!i.ok){var d="Server responded with status "+i.status+".",l="";try{var u=JSON.parse(s);d=u.data&&u.data.message?u.data.message:d,l=u.data&&u.data.error_code?u.data.error_code:""}catch(e){console.error("Could not parse error response as JSON.",e),d=s||d}return handleSubmissionError(d,l),void(rtbcbIsSubmitting=!1)}try{c=JSON.parse(s)}catch(e){return handleSubmissionError("Invalid server response.",""),void(rtbcbIsSubmitting=!1)}if(!c.success||!c.data||!c.data.job_id)return handleSubmissionError(d=c.data&&c.data.message?c.data.message:"An unknown error occurred.",l=c.data&&c.data.error_code?c.data.error_code:""),void(rtbcbIsSubmitting=!1);pollJobStatus(c.data.job_id,n,a)}}async function pollJobStatus(e,t,r){try{if(!rtbcbAjax||!isValidUrl(rtbcbAjax.ajax_url))return handleSubmissionError("Service unavailable. Please reload the page.",""),void(rtbcbIsSubmitting=!1);const a=rtbcbAjax.nonce?rtbcbAjax.nonce:"",o=await fetch(`${rtbcbAjax.ajax_url}?action=rtbcb_job_status&job_id=${encodeURIComponent(e)}&rtbcb_nonce=${a}`),i=await o.json();if(!i.success)return handleSubmissionError("Unable to retrieve job status.",""),void(rtbcbIsSubmitting=!1);const s=i.data,c=s.status;if("completed"===c){if(t){var n=t.querySelector(".rtbcb-progress-text");rtbcbAjax&&rtbcbAjax.strings&&rtbcbAjax.strings.email_confirmation&&(n?n.textContent=rtbcbAjax.strings.email_confirmation:t.textContent=rtbcbAjax.strings.email_confirmation),setTimeout(()=>{t.style.display="none",r&&(r.style.display="block")},3e3)}rtbcbIsSubmitting=!1}else"error"===c?(handleSubmissionError(s.message||"Job failed.",""),rtbcbIsSubmitting=!1):setTimeout(()=>pollJobStatus(e,t,r),2e3)}catch(e){handleSubmissionError("Network error. Please try again later.",""),rtbcbIsSubmitting=!1}}async function rtbcbStreamAnalysis(e,t){if(!rtbcbAjax||!isValidUrl(rtbcbAjax.ajax_url))return void handleSubmissionError("Service unavailable. Please reload the page.","");e.append("action","rtbcb_stream_analysis"),rtbcbAjax.nonce&&e.append("rtbcb_nonce",rtbcbAjax.nonce);const r=(await fetch(rtbcbAjax.ajax_url,{method:"POST",body:e})).body.getReader(),n=new TextDecoder;for(;;){const{value:e,done:a}=await r.read();if(a)break;const o=n.decode(e);"function"==typeof t&&t(o)}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("rtbcbForm");e&&e.addEventListener("submit",handleSubmit)}),window.rtbcbStreamAnalysis=rtbcbStreamAnalysis;