if(void 0===ajaxurl)var ajaxurl=window.location.origin+"/wp-admin/admin-ajax.php";function isValidUrl(t){if(!t)return!1;try{var e=new URL(t,window.location.origin);return"http:"===e.protocol||"https:"===e.protocol}catch(t){return!1}}"object"!=typeof window.rtbcbAdmin&&(window.rtbcbAdmin={}),isValidUrl(window.rtbcbAdmin.ajax_url)||(window.rtbcbAdmin.ajax_url=isValidUrl(ajaxurl)?ajaxurl:""),jQuery(document).ready(function(t){"use strict";console.log("RTBCB Admin JS loaded successfully");var e=window.RTBCB||{};window.RTBCB=e,e.Admin={init:function(){this.bindEvents(),this.initComponents()},bindEvents:function(){t("#rtbcb-test-api").on("click",this.testApi),t("#rtbcb-rebuild-index").on("click",this.rebuildIndex),t("#rtbcb-sync-to-local").on("click",this.syncLocal),t("#rtbcb-generate-commentary").on("click",this.testCommentary),t("#rtbcb-company-overview-form").on("submit",this.testCompanyOverview),t("#rtbcb-industry-overview-form").on("submit",this.testIndustryOverview),t("#rtbcb-benefits-estimate-form").on("submit",this.testBenefits),t("#rtbcb-report-assembly-form").on("submit",this.testReportAssembly),t("#rtbcb-rerun-tracking-script").on("click",function(){t("#rtbcb-run-tracking-script").trigger("click")}),t("#rtbcb-run-tracking-script").on("click",this.testTrackingScript),t("#rtbcb-rerun-follow-up").on("click",function(){t("#rtbcb-run-follow-up").trigger("click")}),t("#rtbcb-run-follow-up").on("click",this.testFollowUpEmail),t("#rtbcb-test-all-sections").on("click",this.runAllTests),t("#rtbcb-regenerate-analysis").on("click",function(e){e.preventDefault(),t("#rtbcb-test-all-sections").trigger("click")}),t("#rtbcb-show-usage-map").on("click",function(){t("#rtbcb-usage-map-wrapper").toggle()}),t("#rtbcb-clear-analysis").on("click",this.clearAnalysis),t("#rtbcb-start-new-analysis").on("click",this.startNewAnalysis),t("#rtbcb-company-name").on("change",function(){window.rtbcbAdmin.comprehensive&&alert("Stored analysis may be outdated for new company.")}),t("#doaction, #doaction2").on("click",function(){var e=t(this).closest("form");e.find('input[name="page"][value="rtbcb-reports"]').length&&"delete_all"===e.find('select[name="action"], select[name="action2"]').val()&&e.find('input[type="checkbox"][name="files[]"]').prop("checked",!0)})},initComponents:function(){t("#rtbcb-bulk-form").length&&this.initLeadsManager(),t("#rtbcb-test-tabs").length&&this.initTabs(),t("#rtbcb-progress-steps").length&&this.initPhaseChart(),t("#rtbcb-test-all-sections").length&&(t("#rtbcb-test-all-sections").addClass("rtbcb-primary-action").focus(),window.rtbcbAdmin&&window.rtbcbAdmin.auto_run_all&&t("#rtbcb-test-all-sections").trigger("click"))},testApi:async function(e){e.preventDefault();var a=t(this),n=a.find("h4"),i=n.length?n.text():a.text();(n.length?n:a).text(window.rtbcbAdmin.strings.processing||"Processing..."),a.prop("disabled",!0);try{var r=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_connection",nonce:window.rtbcbAdmin.nonce}}),s=r.success?"API connection successful!":r.data&&r.data.message?r.data.message:"Connection failed";alert(s)}catch(t){alert("Request failed")}finally{(n.length?n:a).text(i),a.prop("disabled",!1)}},rebuildIndex:async function(e){e.preventDefault();var a=t(this),n=a.text();a.text(window.rtbcbAdmin.strings.processing||"Processing...").prop("disabled",!0);try{var i=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_rebuild_index",nonce:window.rtbcbAdmin.nonce}});i.success?(alert("RAG index rebuilt successfully"),location.reload()):alert(i.data&&i.data.message?i.data.message:"Rebuild failed")}catch(t){alert("Rebuild request failed")}finally{a.text(n).prop("disabled",!1)}},syncLocal:async function(e){e.preventDefault();var a=t(this),n=a.text(),i=t("#rtbcb-connectivity-status");a.text(window.rtbcbAdmin.strings.processing||"Processing...").prop("disabled",!0);var r=t("#rtbcb-sync-local-form").find('input[name="rtbcb_sync_local_nonce"]').val();try{var s=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_sync_to_local",nonce:r}}),c=s.data&&s.data.message?s.data.message:"Sync completed",o=s.success?"notice notice-success":"notice notice-error";i.html('<div class="'+o+'"><p>'+c+"</p></div>")}catch(t){var d=window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.error?window.rtbcbAdmin.strings.error:"Sync request failed";i.html('<div class="notice notice-error"><p>'+d+"</p></div>")}finally{a.text(n).prop("disabled",!1)}},testCommentary:async function(e){e.preventDefault();var a=t(this),n=t("#rtbcb-commentary-industry").val(),i=t("#rtbcb-commentary-results"),r=a.text();a.prop("disabled",!0).text(window.rtbcbAdmin.strings.generating||"Generating...");try{var s=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_commentary",industry:n,nonce:window.rtbcbAdmin.company_overview_nonce}});s.success&&s.data?i.text(s.data.overview||s.data.commentary||"Generated successfully"):i.text(s.data&&s.data.message?s.data.message:"Generation failed")}catch(t){i.text("Request failed")}finally{a.prop("disabled",!1).text(r)}},testCompanyOverview:function(e){e.preventDefault();var a=t(this),n=t("#rtbcb-company-overview-results"),i=a.find('button[type="submit"]'),r=i.text();i.prop("disabled",!0).text(window.rtbcbAdmin.strings.processing||"Processing...");var s=t("#rtbcb-company-name").val(),c=window.rtbcbAdmin.company_overview_nonce;t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_company_overview",company_name:s,nonce:c},success:function(e){if(e.success&&e.data){n.html('<div class="notice notice-success"><p>'+(e.data.overview||"Generated successfully")+"</p></div>");var a=t("#rtbcb-company-overview-meta");if(a.length){var i=window.rtbcbAdmin.strings||{};if(a.empty(),e.data.word_count&&t("<p/>").text((i.word_count||"Word Count")+": "+e.data.word_count).appendTo(a),e.data.elapsed&&t("<p/>").text((i.elapsed||"Elapsed")+": "+e.data.elapsed+"s").appendTo(a),e.data.recommendations&&e.data.recommendations.length){t("<p/>").text((i.recommendations||"Recommendations")+":").appendTo(a);var r=t("<ul/>");e.data.recommendations.forEach(function(e){t("<li/>").text(e).appendTo(r)}),a.append(r)}if(e.data.references&&e.data.references.length){t("<p/>").text((i.references||"References")+":").appendTo(a);var s=t("<ul/>");e.data.references.forEach(function(e){t("<li/>").append(t("<a/>",{text:e,href:e,target:"_blank",rel:"noopener noreferrer"})).appendTo(s)}),a.append(s)}}e.data.metrics&&(window.rtbcbAdmin=window.rtbcbAdmin||{},rtbcbAdmin.company=rtbcbAdmin.company||{},rtbcbAdmin.company.revenue=e.data.metrics.revenue||0,rtbcbAdmin.company.staff_count=e.data.metrics.staff_count||0,rtbcbAdmin.company.efficiency=e.data.metrics.efficiency||0)}else n.html('<div class="notice notice-error"><p>'+(e.data&&e.data.message?e.data.message:"Generation failed")+"</p></div>")},error:function(){n.html('<div class="notice notice-error"><p>Request failed</p></div>')},complete:function(){i.prop("disabled",!1).text(r)}})},testIndustryOverview:function(e){e.preventDefault();var a=t(this),n=t("#rtbcb-industry-overview-results"),i=a.find('button[type="submit"]'),r=i.text();i.prop("disabled",!0).text(window.rtbcbAdmin.strings.processing||"Processing...");var s=t("#rtbcb-industry-name").val(),c=t("#rtbcb-company-size").val(),o=a.find('[name="nonce"]').val()||window.rtbcbAdmin.industry_overview_nonce,d={industry:s,size:c};t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_industry_overview",company_data:JSON.stringify(d),nonce:o},success:function(e){if(e.success&&e.data){var a=t("#rtbcb-industry-overview-meta");if(n.empty(),t('<div class="notice notice-success" />').append(t("<p/>").text(e.data.overview||"Generated successfully")).appendTo(n),a.length){var i=window.rtbcbAdmin.strings||{};if(a.empty(),e.data.word_count&&t("<p/>").text((i.word_count||"Word Count")+": "+e.data.word_count).appendTo(a),e.data.elapsed&&t("<p/>").text((i.elapsed||"Elapsed")+": "+e.data.elapsed+"s").appendTo(a),e.data.recommendations&&e.data.recommendations.length){t("<p/>").text((i.recommendations||"Recommendations")+":").appendTo(a);var r=t("<ul/>");e.data.recommendations.forEach(function(e){t("<li/>").text(e).appendTo(r)}),a.append(r)}if(e.data.references&&e.data.references.length){t("<p/>").text((i.references||"References")+":").appendTo(a);var s=t("<ul/>");e.data.references.forEach(function(e){t("<li/>").append(t("<a/>",{text:e,href:e,target:"_blank",rel:"noopener noreferrer"})).appendTo(s)}),a.append(s)}n.append(a)}}else n.html('<div class="notice notice-error"><p>'+(e.data&&e.data.message?e.data.message:"Generation failed")+"</p></div>")},error:function(){n.html('<div class="notice notice-error"><p>Request failed</p></div>')},complete:function(){i.prop("disabled",!1).text(r)}})},testBenefits:async function(e){e.preventDefault();var a=t("#rtbcb-benefits-estimate-results");a.text(window.rtbcbAdmin.strings.processing||"Processing...");var n=window.rtbcbAdmin.company||{};try{var i=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_estimated_benefits",company_data:{revenue:n.revenue,staff_count:n.staff_count,efficiency:n.efficiency},recommended_category:t("#rtbcb-test-category").val(),nonce:window.rtbcbAdmin.benefits_estimate_nonce}});i.success&&i.data?a.text(JSON.stringify(i.data.estimate||i.data,null,2)):a.text(i.data&&i.data.message?i.data.message:"Generation failed")}catch(t){a.text("Request failed")}},testReportAssembly:async function(e){e.preventDefault();var a=t(this),n=t("#rtbcb-report-assembly-results"),i=a.find('button[type="submit"]'),r=i.text();i.prop("disabled",!0).text(window.rtbcbAdmin.strings.processing||"Processing...");try{var s=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_report_assembly",nonce:a.find('[name="nonce"]').val()||window.rtbcbAdmin.report_assembly_nonce}});if(s.success&&s.data&&s.data.summary){var c=t('<div class="notice notice-success" />'),o=t("<pre />").text(JSON.stringify(s.data.summary,null,2));c.append(o),n.html(c)}else n.html('<div class="notice notice-error"><p>'+(s.data&&s.data.message?s.data.message:"Generation failed")+"</p></div>")}catch(t){n.html('<div class="notice notice-error"><p>Request failed</p></div>')}finally{i.prop("disabled",!1).text(r)}},testTrackingScript:function(e){e.preventDefault();var a=t(this),n=t("#rtbcb_test_tracking_script_nonce").val(),i=t("#rtbcb-tracking-snippet").val(),r=a.text();a.prop("disabled",!0).text(window.rtbcbAdmin.strings.testing||"Testing..."),t("#rtbcb-tracking-script-result").html("");try{var s=document.createElement("script");s.text=i+"\n document.dispatchEvent(new CustomEvent('rtbcbTrackingEvent'));",document.body.appendChild(s)}catch(e){return t("#rtbcb-tracking-script-result").html('<div class="notice notice-error"><p>'+e.message+"</p></div>"),void a.prop("disabled",!1).text(r)}t(document).one("rtbcbTrackingEvent",function(){t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_tracking_script",nonce:n},success:function(e){e.success?t("#rtbcb-tracking-script-result").html('<div class="notice notice-success"><p>Event captured.</p></div>'):t("#rtbcb-tracking-script-result").html('<div class="notice notice-error"><p>'+(e.data&&e.data.message?e.data.message:"Test failed.")+"</p></div>")},error:function(){t("#rtbcb-tracking-script-result").html('<div class="notice notice-error"><p>Request failed.</p></div>')},complete:function(){a.prop("disabled",!1).text(r)}})})},testFollowUpEmail:function(e){e.preventDefault();var a=t(this),n=t("#rtbcb_test_follow_up_email_nonce").val(),i=a.text();a.prop("disabled",!0).text(window.rtbcbAdmin.strings.testing||"Testing..."),t("#rtbcb-follow-up-result").html(""),t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_test_follow_up_email",nonce:n},success:function(e){if(e.success){var a=e.data.queue||[];t("#rtbcb-follow-up-result").html("<pre>"+JSON.stringify(a,null,2)+"</pre>")}else t("#rtbcb-follow-up-result").html('<div class="notice notice-error"><p>'+(e.data&&e.data.message?e.data.message:"Test failed.")+"</p></div>")},error:function(){t("#rtbcb-follow-up-result").html('<div class="notice notice-error"><p>Request failed.</p></div>')},complete:function(){a.prop("disabled",!1).text(i)}})},runAllTests:async function(a){a.preventDefault();var n=t(this),i=n.text(),r=t("#rtbcb-company-name"),s="";if(r.length&&"function"==typeof r.val){var c=r.val();s=c?c.trim():""}if(s){var o=t("#rtbcb-test-status"),d=t("#rtbcb-test-progress"),l=t("#rtbcb-test-step"),b=t("#rtbcb-test-config");t("#rtbcb-copy-debug").remove(),n.prop("disabled",!0).text(window.rtbcbAdmin.strings.testing||"Testing..."),d.val(0).attr({"aria-valuenow":0}).removeClass("rtbcb-complete"),o.text(window.rtbcbAdmin.strings.starting_tests||"Starting tests..."),l.text(""),b.text("");var u=(window.rtbcbAdmin.sections||[]).filter(function(t){return t.action}),p=t("#rtbcb-progress-steps");p.length?p.empty():(p=t('<ol id="rtbcb-progress-steps" class="rtbcb-progress-steps"></ol>'),b.after(p));var m={},w={};u.forEach(function(e){var a=t(".rtbcb-section-item").filter(function(){return t(this).find(".rtbcb-section-label").text()===e.label});m[e.id]=a,a.length&&(a.removeClass("completed").addClass("pending"),a.find(".rtbcb-section-status").text("⚪ "+(window.rtbcbAdmin.strings.queued||"Queued")));var n=t("<li></li>").attr("data-section",e.id).text(e.label+" - "+(window.rtbcbAdmin.strings.queued||"Queued"));p.append(n),w[e.id]=n});var f=[];d.attr({max:u.length,"aria-valuemax":u.length,"aria-valuetext":"0 of "+u.length});for(var g=0;g<u.length;g++){var v=u[g],h=m[v.id],y=w[v.id];l.text(v.label),h&&h.length&&h.find(".rtbcb-section-status").text("⏳ "+(window.rtbcbAdmin.strings.running||"Running")),y&&y.length&&y.text(v.label+" - "+(window.rtbcbAdmin.strings.running||"Running...")),o.text(v.label+" - "+(window.rtbcbAdmin.strings.running||"Running"));var x=(new Date).toISOString(),_=performance.now();try{var A=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:v.action,nonce:v.nonce,company_name:s}}),k=(new Date).toISOString(),T=(performance.now()-_)/1e3;f.push({section:v.id,status:A.success?"success":"error",message:A.data&&A.data.message?A.data.message:"",start_time:x,end_time:k,duration:parseFloat(T.toFixed(3))});try{var C=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_get_section_config",nonce:window.rtbcbAdmin.test_dashboard_nonce,section:v.id}});if(C.success&&C.data&&C.data.config){b.text(C.data.config);var S=t("#rtbcb-copy-debug");S.length||((S=t('<button type="button" id="rtbcb-copy-debug" class="button"></button>')).text(window.rtbcbAdmin.strings.copy_debug||"Copy Debug"),S.on("click",function(){var t=b.text();window.rtbcbTestUtils&&window.rtbcbTestUtils.copyToClipboard?window.rtbcbTestUtils.copyToClipboard(t).then(function(){alert(window.rtbcbAdmin.strings.copied||"Copied to clipboard.")}):navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(t).then(function(){alert(window.rtbcbAdmin.strings.copied||"Copied to clipboard.")})}),b.after(S))}else b.text(""),t("#rtbcb-copy-debug").remove()}catch(e){b.text(""),t("#rtbcb-copy-debug").remove()}if(h&&h.length&&(h.removeClass("pending").addClass("completed"),h.find(".rtbcb-section-status").text("✅ "+(window.rtbcbAdmin.strings.passed||"Passed"))),y&&y.length){var j=A.success?window.rtbcbAdmin.strings.passed||"Passed":window.rtbcbAdmin.strings.failed||"Failed";y.text(v.label+" - "+j+" ("+T.toFixed(1)+"s)")}o.text("✅ "+v.label+" - "+(window.rtbcbAdmin.strings.passed||"Passed"))}catch(t){k=(new Date).toISOString(),T=(performance.now()-_)/1e3,f.push({section:v.id,status:"error",message:t&&t.message?t.message:"Request failed",start_time:x,end_time:k,duration:parseFloat(T.toFixed(3))}),h&&h.length&&(h.removeClass("completed").addClass("pending"),h.find(".rtbcb-section-status").text("❌ "+(window.rtbcbAdmin.strings.failed||"Failed"))),y&&y.length&&y.text(v.label+" - "+(window.rtbcbAdmin.strings.failed||"Failed")+" ("+T.toFixed(1)+"s)"),o.text("❌ "+v.label+" - "+(window.rtbcbAdmin.strings.failed||"Failed"))}var O=g+1;d.val(O).attr({"aria-valuenow":O,"aria-valuetext":O+" of "+u.length}),await e.Admin.refreshPhaseChart()}await e.Admin.saveTestResults(f),e.Admin.fetchTestSummary(),d.val(u.length).attr({"aria-valuenow":u.length,"aria-valuetext":u.length+" of "+u.length}).addClass("rtbcb-complete"),o.text("✅ "+(window.rtbcbAdmin.strings.all_sections_done||"All sections completed")),t("#rtbcb-section-tests").slideDown(),n.prop("disabled",!1).text(i)}else alert(window.rtbcbAdmin.strings.company_required||"Please enter a company name before running tests")},initLeadsManager:function(){var e=this;t("#rtbcb-select-all").on("change",function(){var a=this.checked;t(".rtbcb-lead-checkbox").prop("checked",a),e.updateBulkButton()}),t(".rtbcb-lead-checkbox").on("change",function(){e.updateSelectAll(),e.updateBulkButton()}),t("#rtbcb-bulk-form").on("submit",async function(e){e.preventDefault();var a=t("#rtbcb-bulk-action").val(),n=[];if(t(".rtbcb-lead-checkbox:checked").each(function(){n.push(this.value)}),a&&n.length&&("delete"!==a||confirm(window.rtbcbAdmin.strings.confirm_bulk_delete||"Are you sure?")))try{var i=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_bulk_action_leads",nonce:window.rtbcbAdmin.nonce,bulk_action:a,lead_ids:n}});i.success?location.reload():alert(i.data&&i.data.message?i.data.message:"Bulk action failed")}catch(t){alert("Bulk action request failed")}}),t(".rtbcb-view-lead").on("click",function(e){e.preventDefault();var a=t(this).closest("tr"),n=`\n                    <div class="rtbcb-lead-detail-grid">\n                        <div class="rtbcb-detail-item"><label>Email:</label><span>${a.find(".column-email strong").text()}</span></div>\n                        <div class="rtbcb-detail-item"><label>Company Size:</label><span>${a.find(".column-company-size").text().trim()}</span></div>\n                        <div class="rtbcb-detail-item"><label>Category:</label><span>${a.find(".column-category").text().trim()}</span></div>\n                        <div class="rtbcb-detail-item"><label>ROI:</label><span>${a.find(".column-roi").text().trim()}</span></div>\n                        <div class="rtbcb-detail-item"><label>Date:</label><span>${a.find(".column-date").text().trim()}</span></div>\n                    </div>`;t("#rtbcb-lead-details").html(n),t("#rtbcb-lead-modal").show()}),t(".rtbcb-delete-lead").on("click",async function(a){if(a.preventDefault(),confirm(window.rtbcbAdmin.strings.confirm_delete||"Are you sure?")){var n=t(this).data("lead-id"),i=t(this).closest("tr");try{var r=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_delete_lead",nonce:window.rtbcbAdmin.nonce,lead_id:n}});r.success?(i.remove(),e.updateBulkButton()):alert(r.data&&r.data.message?r.data.message:"Delete failed")}catch(t){alert("Delete request failed")}}}),t(".rtbcb-modal-close").on("click",function(){t("#rtbcb-lead-modal").hide()}),t("#rtbcb-lead-modal").on("click",function(e){"rtbcb-lead-modal"===e.target.id&&t(this).hide()})},updateSelectAll:function(){var e=t("#rtbcb-select-all"),a=t(".rtbcb-lead-checkbox").length,n=t(".rtbcb-lead-checkbox:checked").length;e.prop("checked",a===n&&a>0),e.prop("indeterminate",n>0&&n<a)},updateBulkButton:function(){var e=t(".rtbcb-lead-checkbox:checked").length;t('#rtbcb-bulk-form button[type="submit"]').prop("disabled",0===e)},initTabs:function(){function e(e){t("#rtbcb-test-tabs a").removeClass("nav-tab-active"),t('#rtbcb-test-tabs a[href="'+e+'"]').addClass("nav-tab-active"),t(".rtbcb-tab-panel").hide(),t(e).show(),window.location.hash=e}t("#rtbcb-test-tabs a").on("click",function(a){a.preventDefault(),e(t(this).attr("href"))}),t(".rtbcb-jump-tab").on("click",function(a){a.preventDefault();var n=t(this).attr("href");t("#rtbcb-section-tests").show(),e(n);var i=document.getElementById("rtbcb-section-tests");i&&i.scrollIntoView&&i.scrollIntoView({behavior:"smooth"})}),window.location.hash&&t('#rtbcb-test-tabs a[href="'+window.location.hash+'"]').length&&(t("#rtbcb-section-tests").show(),e(window.location.hash))},initPhaseChart:function(){window.rtbcbAdmin&&window.rtbcbAdmin.phaseKeys&&(window.rtbcbAdmin.phaseKeys.forEach(function(e){var a=window.rtbcbAdmin.phaseCompletion[e]||0,n=t('.rtbcb-progress-phase[data-phase="'+e+'"]');n.find(".rtbcb-phase-percent").text(a+"%"),n.toggleClass("completed",a>=100)}),t(".rtbcb-section-item").each(function(){var e=1===t(this).data("completed")||"1"===t(this).data("completed");t(this).toggleClass("completed",e),t(this).toggleClass("pending",!e)}),t(".rtbcb-phase-toggle").off("click").on("click",function(){var e=t(this),a="true"===e.attr("aria-expanded");e.attr("aria-expanded",a?"false":"true"),e.closest(".rtbcb-progress-phase").toggleClass("expanded")}))},refreshPhaseChart:async function(){try{var e=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_get_phase_completion",nonce:window.rtbcbAdmin.test_dashboard_nonce}});e.success&&e.data&&e.data.percentages&&(window.rtbcbAdmin.phaseCompletion=e.data.percentages,this.initPhaseChart())}catch(t){console.error("Failed to refresh progress",t)}},saveTestResults:async function(e){try{var a=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_save_test_results",nonce:window.rtbcbAdmin.test_dashboard_nonce,results:JSON.stringify(e)}});if(a.success)console.log("Test results saved");else{var n=a.data&&a.data.message?a.data.message:window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.error?window.rtbcbAdmin.strings.error:"Failed to save test results",i=t("<div>").text(n).html();t("#rtbcb-test-status").after('<div class="notice notice-error"><p>'+i+"</p></div>"),console.error(i)}}catch(e){n=e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message?e.responseJSON.data.message:window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.error?window.rtbcbAdmin.strings.error:"Failed to save test results",i=t("<div>").text(n).html(),t("#rtbcb-test-status").after('<div class="notice notice-error"><p>'+i+"</p></div>"),console.error("Failed to save test results",e)}},fetchTestSummary:async function(){try{var e=await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_get_test_summary_html",nonce:window.rtbcbAdmin.test_dashboard_nonce}});if(e.success&&e.data&&e.data.html){var a=t("#rtbcb-final-summary");a.length||(a=t('<div id="rtbcb-final-summary"></div>'),t("#rtbcb-test-status").after(a)),a.html(e.data.html)}else{var n=e.data&&e.data.message?e.data.message:window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.error?window.rtbcbAdmin.strings.error:"Failed to fetch test summary",i=t("<div>").text(n).html(),r=t('<div class="notice notice-error"><p>'+i+"</p></div>");if(t("#rtbcb-test-status").after(r),e.data&&e.data.debug){var s=e.data.debug;(c=t('<button type="button" class="button"></button>').text(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copy_debug_packet?window.rtbcbAdmin.strings.copy_debug_packet:"Copy Debug Packet")).on("click",function(){navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(s).then(function(){alert(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copied||"Copied to clipboard.")}):window.rtbcbTestUtils&&window.rtbcbTestUtils.copyToClipboard&&window.rtbcbTestUtils.copyToClipboard(s).then(function(){alert(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copied||"Copied to clipboard.")})}),r.append(c)}}}catch(e){var c,o=e&&e.responseJSON&&e.responseJSON.data?e.responseJSON.data:{};n=o.message||(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.error?window.rtbcbAdmin.strings.error:"Failed to fetch test summary"),i=t("<div>").text(n).html(),r=t('<div class="notice notice-error"><p>'+i+"</p></div>"),t("#rtbcb-test-status").after(r),o.debug&&(s=o.debug,(c=t('<button type="button" class="button"></button>').text(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copy_debug_packet?window.rtbcbAdmin.strings.copy_debug_packet:"Copy Debug Packet")).on("click",function(){navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(s).then(function(){alert(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copied||"Copied to clipboard.")}):window.rtbcbTestUtils&&window.rtbcbTestUtils.copyToClipboard&&window.rtbcbTestUtils.copyToClipboard(s).then(function(){alert(window.rtbcbAdmin.strings&&window.rtbcbAdmin.strings.copied||"Copied to clipboard.")})}),r.append(c))}},startNewAnalysis:async function(e){e.preventDefault();var a=t("#rtbcb_clear_current_company_nonce").val();try{(await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_clear_current_company",nonce:a}})).success?window.location.href="admin.php?page=rtbcb-test-dashboard#rtbcb-phase1":alert("Request failed")}catch(t){alert("Request failed")}},clearAnalysis:async function(e){e.preventDefault();try{(await t.ajax({url:window.rtbcbAdmin.ajax_url,method:"POST",data:{action:"rtbcb_clear_analysis_data",nonce:window.rtbcbAdmin.test_dashboard_nonce}})).success&&(t("#rtbcb-comprehensive-analysis").hide(),t(".rtbcb-view-source").hide(),t(".rtbcb-data-status").text("⚪ Generate new"))}catch(t){alert("Clear failed")}}},e.Admin.init();var a=t(".rtbcb-results-table-wrapper");function n(t){t[0].scrollWidth>t[0].clientWidth?(t.addClass("rtbcb-scrollable"),t[0].scrollLeft+t[0].clientWidth>=t[0].scrollWidth-1?t.addClass("rtbcb-scrolled-end"):t.removeClass("rtbcb-scrolled-end")):t.removeClass("rtbcb-scrollable rtbcb-scrolled-end")}a.each(function(){n(t(this))}),a.on("scroll",function(){n(t(this))}),t(window).on("resize",function(){a.each(function(){n(t(this))})}),window.RTBCBAdmin=e.Admin});