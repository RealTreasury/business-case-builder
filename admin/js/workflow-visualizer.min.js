jQuery(function(t){function r(r,o){t("#rtbcb-workflow-message").removeClass("notice-success notice-error").addClass("notice-"+o).text(r).show()}function o(o){t.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_get_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(s){if(s.success){var n=s.data.history||[];if(!n.length)return t("#rtbcb-workflow-history-container").html("<p>"+rtbcbWorkflow.strings.no_history+"</p>"),void(o&&r(rtbcbWorkflow.strings.refresh_success,"success"));var c=[];n.forEach(function(t){t.steps&&t.steps.forEach(function(t){-1===c.indexOf(t.name)&&c.push(t.name)})});var e='<div class="rtbcb-history-table-wrapper"><table class="widefat rtbcb-history-table"><thead><tr><th>'+rtbcbWorkflow.strings.lead+"</th><th>"+rtbcbWorkflow.strings.company+"</th><th>"+rtbcbWorkflow.strings.started+"</th><th>"+rtbcbWorkflow.strings.template+"</th>";c.forEach(function(r){e+="<th>"+t("<div>").text(r).html()+"</th>"}),e+="</tr></thead><tbody>",n.forEach(function(r){var o=r.email||(r.lead_id?"ID "+r.lead_id:rtbcbWorkflow.strings.unknown_lead),s=t("<div>").text(o).html();r.logs_url&&(s='<a href="'+r.logs_url+'" target="_blank" title="'+rtbcbWorkflow.strings.view_logs+'">'+s+"</a>");var n=r.company||rtbcbWorkflow.strings.unknown_company,i=r.started_at||rtbcbWorkflow.strings.unknown_start,l=r.report_template||rtbcbWorkflow.strings.unknown_template;e+="<tr><td>"+s+"</td><td>"+t("<div>").text(n).html()+"</td><td>"+t("<div>").text(i).html()+"</td><td>"+t("<div>").text(l).html()+"</td>",c.forEach(function(o){var s=rtbcbWorkflow.strings.not_run,n="";r.steps&&r.steps.forEach(function(t){t.name===o&&(s=t.status,t.duration&&(n='<span class="rtbcb-step-time">'+t.duration+rtbcbWorkflow.strings.seconds,t.elapsed&&(n+=" ("+t.elapsed+rtbcbWorkflow.strings.elapsed_suffix+")"),n+="</span>"))}),e+="<td><span>"+t("<div>").text(s).html()+"</span>"+n+"</td>"}),e+="</tr>"}),e+="</tbody></table></div>",t("#rtbcb-workflow-history-container").html(e),o&&r(rtbcbWorkflow.strings.refresh_success,"success")}else o&&r(rtbcbWorkflow.strings.error,"error")}).fail(function(){o&&r(rtbcbWorkflow.strings.error,"error")})}t("#rtbcb-refresh-workflow").on("click",function(){o(!0)}),t("#rtbcb-clear-workflow").on("click",function(){t.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_clear_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(o){o.success?(t("#rtbcb-workflow-history-container").empty(),r(rtbcbWorkflow.strings.clear_success,"success")):r(rtbcbWorkflow.strings.error,"error")}).fail(function(){r(rtbcbWorkflow.strings.error,"error")})}),o(!1)});