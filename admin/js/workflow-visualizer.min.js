jQuery(function($){function showMessage(message,type){var $msg=$("#rtbcb-workflow-message");$msg.removeClass("notice-success notice-error").addClass("notice-"+type).text(message).show()}function loadHistory(showNotice){$.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_get_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(response){if(response.success){var history=response.data.history||[];if(!history.length){$("#rtbcb-workflow-history-container").html("<p>"+rtbcbWorkflow.strings.no_history+"</p>");if(showNotice){showMessage(rtbcbWorkflow.strings.refresh_success,"success")}return}var stepNames=[];history.forEach(function(item){if(item.steps){item.steps.forEach(function(step){if(stepNames.indexOf(step.name)===-1){stepNames.push(step.name)}})}});var html='<div class="rtbcb-history-table-wrapper"><table class="widefat rtbcb-history-table"><thead><tr><th>'+rtbcbWorkflow.strings.lead+"</th><th>"+rtbcbWorkflow.strings.company+"</th><th>"+rtbcbWorkflow.strings.started+"</th><th>"+rtbcbWorkflow.strings.template+"</th><th>"+rtbcbWorkflow.strings.logs+"</th>";stepNames.forEach(function(name){html+="<th>"+$("<div>").text(name).html()+"</th>"});html+="</tr></thead><tbody>";history.forEach(function(item){var lead=item.email||(item.lead_id?"ID "+item.lead_id:rtbcbWorkflow.strings.unknown_lead);var leadHtml=$("<div>").text(lead).html();if(item.logs_url){leadHtml='<a href="'+item.logs_url+'" target="_blank" title="'+rtbcbWorkflow.strings.view_logs+'">'+leadHtml+"</a>"}var company=item.company||rtbcbWorkflow.strings.unknown_company;var started=item.started_at||rtbcbWorkflow.strings.unknown_start;var template=item.report_template||rtbcbWorkflow.strings.unknown_template;var logsLink=item.logs_url?'<a href="'+item.logs_url+'" target="_blank">'+rtbcbWorkflow.strings.view_logs+"</a>":$("<div>").text(rtbcbWorkflow.strings.no_logs).html();html+="<tr><td>"+leadHtml+"</td><td>"+$("<div>").text(company).html()+"</td><td>"+$("<div>").text(started).html()+"</td><td>"+$("<div>").text(template).html()+"</td><td>"+logsLink+"</td>";stepNames.forEach(function(name){var status=rtbcbWorkflow.strings.not_run;var time="";if(item.steps){item.steps.forEach(function(step){if(step.name===name){status=step.status;if(step.duration){time='<span class="rtbcb-step-time">'+step.duration+rtbcbWorkflow.strings.seconds;if(step.elapsed){time+=" ("+step.elapsed+rtbcbWorkflow.strings.elapsed_suffix+")"}time+="</span>"}}})}html+="<td><span>"+$("<div>").text(status).html()+"</span>"+time+"</td>"});html+="</tr>"});html+="</tbody></table></div>";$("#rtbcb-workflow-history-container").html(html);makeSortable($(".rtbcb-history-table"));if(showNotice){showMessage(rtbcbWorkflow.strings.refresh_success,"success")}}else if(showNotice){showMessage(rtbcbWorkflow.strings.error,"error")}}).fail(function(){if(showNotice){showMessage(rtbcbWorkflow.strings.error,"error")}})}function makeSortable($table){$table.find("th").each(function(index){var asc=true;$(this).on("click",function(){var rows=$table.find("tbody tr").get();rows.sort(function(a,b){var A=$(a).children("td").eq(index).text().toUpperCase();var B=$(b).children("td").eq(index).text().toUpperCase();if(A<B){return asc?-1:1}if(A>B){return asc?1:-1}return 0});$.each(rows,function(i,row){$table.children("tbody").append(row)});$table.find("th").removeClass("rtbcb-sorted-asc rtbcb-sorted-desc");$(this).addClass(asc?"rtbcb-sorted-asc":"rtbcb-sorted-desc");asc=!asc})})}$("#rtbcb-refresh-workflow").on("click",function(){loadHistory(true)});$("#rtbcb-clear-workflow").on("click",function(){$.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_clear_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(response){if(response.success){$("#rtbcb-workflow-history-container").empty();showMessage(rtbcbWorkflow.strings.clear_success,"success")}else{showMessage(rtbcbWorkflow.strings.error,"error")}}).fail(function(){showMessage(rtbcbWorkflow.strings.error,"error")})});loadHistory(false)});