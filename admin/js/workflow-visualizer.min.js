jQuery(function(t){function r(r,o){t("#rtbcb-workflow-message").removeClass("notice-success notice-error").addClass("notice-"+o).text(r).show()}function o(o){t.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_get_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(s){if(s.success){var e=s.data.history||[];if(!e.length)return t("#rtbcb-workflow-history-container").html("<p>"+rtbcbWorkflow.strings.no_history+"</p>"),void(o&&r(rtbcbWorkflow.strings.refresh_success,"success"));var n=[];e.forEach(function(t){t.steps&&t.steps.forEach(function(t){-1===n.indexOf(t.name)&&n.push(t.name)})});var c='<div class="rtbcb-history-table-wrapper"><table class="widefat rtbcb-history-table"><thead><tr><th>'+rtbcbWorkflow.strings.lead+"</th><th>"+rtbcbWorkflow.strings.company+"</th><th>"+rtbcbWorkflow.strings.started+"</th><th>"+rtbcbWorkflow.strings.template+"</th><th>"+rtbcbWorkflow.strings.logs+"</th>";n.forEach(function(r){c+="<th>"+t("<div>").text(r).html()+"</th>"}),c+="</tr></thead><tbody>",e.forEach(function(r){var o=r.email||(r.lead_id?"ID "+r.lead_id:rtbcbWorkflow.strings.unknown_lead),s=t("<div>").text(o).html();r.logs_url&&(s='<a href="'+r.logs_url+'" target="_blank" title="'+rtbcbWorkflow.strings.view_logs+'">'+s+"</a>");var e=r.company||rtbcbWorkflow.strings.unknown_company,b=r.started_at||rtbcbWorkflow.strings.unknown_start,i=r.report_template||rtbcbWorkflow.strings.unknown_template,l=r.logs_url?'<a href="'+r.logs_url+'" target="_blank">'+rtbcbWorkflow.strings.view_logs+"</a>":t("<div>").text(rtbcbWorkflow.strings.no_logs).html();c+="<tr><td>"+s+"</td><td>"+t("<div>").text(e).html()+"</td><td>"+t("<div>").text(b).html()+"</td><td>"+t("<div>").text(i).html()+"</td><td>"+l+"</td>",n.forEach(function(o){var s=rtbcbWorkflow.strings.not_run,e="";r.steps&&r.steps.forEach(function(t){t.name===o&&(s=t.status,t.duration&&(e='<span class="rtbcb-step-time">'+t.duration+rtbcbWorkflow.strings.seconds,t.elapsed&&(e+=" ("+t.elapsed+rtbcbWorkflow.strings.elapsed_suffix+")"),e+="</span>"))}),c+="<td><span>"+t("<div>").text(s).html()+"</span>"+e+"</td>"}),c+="</tr>"}),c+="</tbody></table></div>",t("#rtbcb-workflow-history-container").html(c),(b=t(".rtbcb-history-table")).find("th").each(function(r){var o=!0;t(this).on("click",function(){var s=b.find("tbody tr").get();s.sort(function(s,e){var n=t(s).children("td").eq(r).text().toUpperCase(),c=t(e).children("td").eq(r).text().toUpperCase();return n<c?o?-1:1:n>c?o?1:-1:0}),t.each(s,function(t,r){b.children("tbody").append(r)}),b.find("th").removeClass("rtbcb-sorted-asc rtbcb-sorted-desc"),t(this).addClass(o?"rtbcb-sorted-asc":"rtbcb-sorted-desc"),o=!o})}),o&&r(rtbcbWorkflow.strings.refresh_success,"success")}else o&&r(rtbcbWorkflow.strings.error,"error");var b}).fail(function(){o&&r(rtbcbWorkflow.strings.error,"error")})}t("#rtbcb-refresh-workflow").on("click",function(){o(!0)}),t("#rtbcb-clear-workflow").on("click",function(){t.post(rtbcbWorkflow.ajax_url,{action:"rtbcb_clear_workflow_history",nonce:rtbcbWorkflow.nonce}).done(function(o){o.success?(t("#rtbcb-workflow-history-container").empty(),r(rtbcbWorkflow.strings.clear_success,"success")):r(rtbcbWorkflow.strings.error,"error")}).fail(function(){r(rtbcbWorkflow.strings.error,"error")})}),o(!1)});